function $parcel$interopDefault(e){return e&&e.__esModule?e.default:e}function $ef2b9a9b8ae02095$export$9a00dee1beb8f576(e){return e.charAt(0).toUpperCase()+e.slice(1)}function $ef2b9a9b8ae02095$export$99454b2c58b3846f({uuid:e=null,scene_id:s=null,token_id:a=null,actor_id:i=null}){return e?fromUuidSync(e)||null:s&&a?game.scenes.get(s)?.tokens.get(a)?.actor||null:i&&game.actors.get(i)||null}function $ef2b9a9b8ae02095$export$9c490b34b2f16a34(e){let s=Math.floor(e.length/2),a=[...e].sort((e,s)=>e-s);return e.length%2!=0?a[s]:(a[s-1]+a[s])/2}function $ef2b9a9b8ae02095$export$6d905af60429adc0(e){return e[Math.floor(Math.random()*e.length)]}function $ef2b9a9b8ae02095$export$55aae15f3c7dd534(e){if("strength"===e.toLowerCase())return"Str";if("dexterity"===e.toLowerCase())return"Dex";if("speed"===e.toLowerCase())return"Spd";if("endurance"===e.toLowerCase())return"End";if("intelligence"===e.toLowerCase())return"Int";else if("perception"===e.toLowerCase())return"Per";else if("charisma"===e.toLowerCase())return"Chr";else if("determination"===e.toLowerCase())return"Det";else return $ef2b9a9b8ae02095$export$9a00dee1beb8f576(e)}function $ef2b9a9b8ae02095$export$44f4605f44e8fbf2(e,s,a){return(e?$ef2b9a9b8ae02095$export$55aae15f3c7dd534(e):"")+(s?`/${s}`:"")+(a?isNaN(a)?` vs. ${a}`:`-${a}`:"")}function $ef2b9a9b8ae02095$export$260ae3d8e98e4090(){return btoa(Number(1e4*Math.random()).toString()).substring(1,17)}function $ef2b9a9b8ae02095$export$33dec5772ae42010(e,s=null){try{return game.settings.get("saga-machine",e)}catch(e){return s}}async function $ef2b9a9b8ae02095$export$76270d92bc7c69ae(e){for(let s of e){let e=await getTemplate(s.path);Handlebars.registerPartial(s.name,e)}}function $ef2b9a9b8ae02095$export$8e68967fd29d5cd0(){return"saga-machine"===game.system.id?"systems/saga-machine":`systems/${game.system.id}/saga-machine`}class $53b5035feb70b083$export$471af1c74e831048 extends Item{async prepareDerivedData(){super.prepareDerivedData(),this.full_name(),this.actor&&this.actor.isOwner&&this.id&&this.actor.items.get(this.id)&&this.parse_properties()}async _onCreate(e,s,a){await super._onCreate(e,s,a),this.isOwner&&this.id&&e.img===foundry.documents.BaseItem.DEFAULT_ICON&&("skill"===this.type&&this.update({img:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/skill.svg`}),"trait"===this.type&&this.update({img:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/trait.svg`}),"origin"===this.type&&this.update({img:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/origin.svg`}),"path"===this.type&&this.update({img:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/path.svg`}),"ambition"===this.type&&this.update({img:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/ambition.svg`}),"consequence"===this.type&&this.update({img:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/consequence.svg`}),"action"===this.type&&this.update({img:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/action.svg`}))}full_name(){let e=this.name+(this.system.specialized?` (${this.system.specialization})`:"");"trait"===this.type&&this.system.ranked&&(e+=` ${this.system.rank}`),this.system.full_name=e}parse_properties(){"item"===this.type&&("string"==typeof this.system.properties&&(this.system.properties=this.system.properties.split(",").map(e=>e.trim())),this.system.container=this.property_value("Container"),this.system.armor=$53b5035feb70b083$export$c1ee35a8710d4530.calc_armor(this),this.system.bulky=this.property_value("Bulky"),this.system.parry=this.property_value("Parry"),this.system.powered=this.property_value("Powered"),this.system.hands=this.property_value("Hands")||1,this.system.unit_encumbrance=$53b5035feb70b083$export$c1ee35a8710d4530.calc_unit_encumbrance(this),this.system.container_encumbrance=$53b5035feb70b083$export$c1ee35a8710d4530.calc_container_encumbrance(this),this.system.encumbrance=$53b5035feb70b083$export$c1ee35a8710d4530.calc_encumbrance(this),this.system.unit_loads=$53b5035feb70b083$export$c1ee35a8710d4530.calc_unit_loads(this),this.system.loads=$53b5035feb70b083$export$c1ee35a8710d4530.calc_loads(this))}property_value(e){for(let s of this.system.properties)if(s.toLowerCase().startsWith(`${e.toLowerCase()} `)){let[e,a]=s.split(" ");return Number(a)}return 0}async remove_from_container(){"item"===this.type&&this.update({"system.parent":null})}}class $53b5035feb70b083$export$4b017698e4946e33{static parent_action_index(e,s){let a=e?.system?.actions;if(!a)return -1;for(let e=0;e<a.length;e++)if(a[e]._id===s)return e;return -1}static is_power(e){return!!e.properties&&$53b5035feb70b083$export$4b017698e4946e33.has_property(e.properties,"Power")}static is_attack(e){return"Defense"===e.tn||"Willpower"===e.tn}static strength_met(e,s=null){s||(s=$ef2b9a9b8ae02095$export$99454b2c58b3846f(e));let a=s?.system?.stats?.strength?.value;if(null==a)return!0;let i=$53b5035feb70b083$export$4b017698e4946e33.damage(e),r=$53b5035feb70b083$export$4b017698e4946e33.parse_properties(e.properties),n=$53b5035feb70b083$export$4b017698e4946e33.property_value(r,"Str");return $53b5035feb70b083$export$4b017698e4946e33.property_value(r,"Hands")>=2?a>=(n||i/2):a>=(n||i)}static damage(e){if(!e.effects)return 0;let s=JSON.parse(e.effects);Array.isArray(s)||(s=[s]);for(let e=0;e<s.length;e++){let a=new $a92622f457efc12a$export$a32b0b1c1ac59d04(s[e]);if("damage"===a.type)return a.base_damage()}return 0}static is_defense(e){if(!e||!e.length)return!1;for(let s=0;s<e.length;s++)if("defense"===e[s].type)return!0;return!1}static merge_modifiers(e,s){return e=$53b5035feb70b083$export$4b017698e4946e33.parse_properties(e),(s=$53b5035feb70b083$export$4b017698e4946e33.parse_properties(s)).concat(e)}static merge_properties(e,s,a=!1){e=$53b5035feb70b083$export$4b017698e4946e33.property_set(e);let i=[],r=(s=$53b5035feb70b083$export$4b017698e4946e33.property_set(s)).concat(e).filter(e=>!(i.indexOf(e.property)>=0)&&!!i.push(e.property));return a?r.map(e=>`${e.property} ${e.value??""}`.trim()):r}static property_set(e){return $53b5035feb70b083$export$4b017698e4946e33.parse_properties(e).map(e=>{let[s,a]=e.split(" ");return{property:s,value:Number(a)||null}})}static parse_properties(e){return"string"==typeof e?e.split(",").map(e=>e.trim()):Array.isArray(e)?e:[]}static property_value(e,s){for(let a of $53b5035feb70b083$export$4b017698e4946e33.parse_properties(e))if(a.toLowerCase().startsWith(`${s.toLowerCase()} `)){let[,e]=a.split(" ");return Number(e)}return 0}static has_property(e,s){return $53b5035feb70b083$export$4b017698e4946e33.parse_properties(e).map(e=>e.split(" ")[0]).includes(s)}}class $53b5035feb70b083$export$c1ee35a8710d4530{static calc_unit_encumbrance(e){if(e.system.load)return 100;if(e.system.properties.includes("Neg"))return 0;for(let s of e.system.properties){if(s.startsWith("Implant ")||s.startsWith("Software "))return 0;if(s.startsWith("Big ")){let[e,a]=s.split(" ");return Number(a)}}return 1}static calc_unit_loads(e){return e.system.unit_encumbrance/100}static calc_container_encumbrance(e){return e.system.unit_encumbrance*e.system.quantity}static calc_encumbrance(e){return!e.system.carried||e.system.parent||e.system.equipped&&e.system.properties.includes("Worn")?0:e.system.unit_encumbrance*e.system.quantity}static calc_loads(e){return Math.floor(e.system.unit_loads*e.system.quantity)}static calc_armor(e){return"Armors"!==e.system.group?0:Number.isFinite(parseInt(e.system.uses))?parseInt(e.system.uses):e.property_value("Armor")||0}}class $a92622f457efc12a$export$a32b0b1c1ac59d04{test=null;type=null;target="self";when="always";message="";static IGNORES_ALL_ARMOR=-1;constructor(e,s=null){Object.assign(this,e),s&&(this.test=s),this.validate(e)}validate(){if(!["consequence","damage","defense","message"].includes(this.type))throw`Unknown type ${this.type}`}right_time(e){return"always"===this.when||this.when===e}format_message(e,s){return`<div><strong>${e}:</strong> ${s}</div>`}effect(){return"damage"===this.type?`${this.value} ${this.damage_type}`:"consequence"===this.type?this.name:"Special"}consequence_link(e=null){e||(e=this.name);let s=game.items.filter(s=>"consequence"===s.type&&s.name===e);return s&&s.length?`<a class="content-link" draggable="true" data-link="" data-uuid="${s[0].uuid}" data-id="${s[0].id}" data-type="Item" data-tooltip="Item"><i class="fas fa-suitcase"></i>${e}</a>`:e}base_damage(){let e=0,s=String(this.value).toLowerCase();return s.includes("@str")&&(e+=Number(this?.test?.actor?.system?.stats?.strength?.value)),s.includes("@dex")&&(e+=Number(this?.test?.actor?.system?.stats?.dexterity?.value)),s.includes("@spd")&&(e+=Number(this?.test?.actor?.system?.stats?.speed?.value)),s.includes("@end")&&(e+=Number(this?.test?.actor?.system?.stats?.endurance?.value)),s.includes("@int")&&(e+=Number(this?.test?.actor?.system?.stats?.intelligence?.value)),s.includes("@per")&&(e+=Number(this?.test?.actor?.system?.stats?.perception?.value)),s.includes("@chr")&&(e+=Number(this?.test?.actor?.system?.stats?.charisma?.value)),s.includes("@det")&&(e+=Number(this?.test?.actor?.system?.stats?.determination?.value)),e+=Number(s=s.replace(/[^\d.-]/g,""))}apply(e="always",s){return s||(s=this),"consequence"===this.type&&this.right_time(e)&&this.apply_consequence(),"damage"===this.type&&this.right_time(e)&&this.apply_damage(s),"defense"===this.type&&this.right_time(e)&&this.apply_defense(),"message"===this.type&&this.right_time(e)&&this.apply_message(),this}apply_message(){this.message=this.format_message(this.key?this.key:"Message",this.value)}apply_consequence(){let e=this.name?this.name:"Unknown",s=this.subject?`${e} (${this.subject})`:e,a=this.consequence_link(s);a||(a=s),this.message=this.format_message("Consequence",a)}apply_damage(e){let s=this.base_damage(),a=this.margin?Number(this.margin):this.test&&this.test.margin?Number(this.test.margin):0;this.properties=$53b5035feb70b083$export$4b017698e4946e33.parse_properties(e.properties);let i=$53b5035feb70b083$export$4b017698e4946e33.has_property(this.properties,"Ignores")?$a92622f457efc12a$export$a32b0b1c1ac59d04.IGNORES_ALL_ARMOR:$53b5035feb70b083$export$4b017698e4946e33.property_value(this.properties,"Pierce"),r=s+a;r<0&&(r=0),$53b5035feb70b083$export$4b017698e4946e33.has_property(this.properties,"Feeble")&&(r=Math.floor(r/2));let n=this.damage_type?this.damage_type:"";this.message=this.format_message("Damage",`<span class="damage" data-pierce="${i}">${r}</span> <span class="damage-type">${n}</span>`)}apply_defense(){if(!this.test)return;let e=null;"self"===this.target?e=this.test.actor:"target"===this.target&&this.test.target&&(e=this.test.target);let s=e.system.scores.defense.value+this.test.randomizer,a=e.system.scores.willpower.value+this.test.randomizer;e.update({"system.scores.defense.tn":s,"system.scores.defense.roll":this.test.randomizer,"system.scores.defense.parry_on":!1,"system.scores.defense.dodge_on":!1,"system.scores.willpower.tn":a,"system.scores.willpower.roll":this.test.randomizer,"system.scores.willpower.resist_on":!1}),this.message=this.format_message("Defense",`TN ${s}`)+this.format_message("Willpower",`TN ${a}`)}static to_json(e){let s={};for(let[a,i]of Object.entries(e))("string"==typeof i||"number"==typeof i||"boolean"==typeof i||null===i||"properties"===a)&&(s[a]=i);return s}static from_json(e){return new $a92622f457efc12a$export$a32b0b1c1ac59d04(e)}}class $a92622f457efc12a$var$Wound{descriptor;description;constructor(e,s){this.descriptor=e||"",this.description=s||""}}class $a92622f457efc12a$export$a8bf75e7367c8d41{static async generate_wound(e,s){let a=new $a92622f457efc12a$var$Wound;if(s&&"fat"!==e){let e=game.tables.getName("Grave Wounds");if(e)return a.description=(await e.draw()).results[0].text,a.descriptor=a.description.split(":")[0],a;a.descriptor=$ef2b9a9b8ae02095$export$6d905af60429adc0(["grave ","deep ","severe ","critical ","serious ","major "])}switch("fat"!==e&&(a.descriptor+=$ef2b9a9b8ae02095$export$6d905af60429adc0(["arm ","leg ","abdomen ","chest ","head ","neck ","hand ","foot ","knee ","elbow ","forearm ","shin ","side ","back ","cheek ","brow ","shoulder ","hip ","thigh ","groin ","rib ","skull ","face "])),e){case"burn":case"cor":case"fr":case"tox":a.descriptor+=$ef2b9a9b8ae02095$export$6d905af60429adc0(["burn","sore","lesion"]);break;case"cut":a.descriptor+=$ef2b9a9b8ae02095$export$6d905af60429adc0(["slash","cut","slice"]);break;case"fat":a.descriptor+=$ef2b9a9b8ae02095$export$6d905af60429adc0(["tired","weakened","winded"]);break;case"pi":a.descriptor+=$ef2b9a9b8ae02095$export$6d905af60429adc0(["stab","puncture","gash"]);break;case"sm":a.descriptor+=$ef2b9a9b8ae02095$export$6d905af60429adc0(["bruise","trauma","rent"]);break;default:a.descriptor+=$ef2b9a9b8ae02095$export$6d905af60429adc0(["wound","gash","laceration"])}return a}}const $c76bcdf2af710582$export$bd4feec9a9a5101a={FAST_TURN:"3",NPC_TURN:"2",SLOW_TURN:"1"};class $c76bcdf2af710582$export$ca8ad600a8ec4279 extends Combatant{getInitiativeRoll(e){return this.actor?this.isNPC?this.actor.getInitiativeRoll($c76bcdf2af710582$export$bd4feec9a9a5101a.NPC_TURN):this.actor.getInitiativeRoll():new Roll($c76bcdf2af710582$export$bd4feec9a9a5101a.NPC_TURN)}getInitiativeValue(){return this.isNPC?Number($c76bcdf2af710582$export$bd4feec9a9a5101a.NPC_TURN):this.actor.system.fast_turn?Number($c76bcdf2af710582$export$bd4feec9a9a5101a.FAST_TURN):Number($c76bcdf2af710582$export$bd4feec9a9a5101a.SLOW_TURN)}}class $c76bcdf2af710582$export$c9b99f4a745fcbd1 extends Combat{async rollInitiative(e,{formula:s=null,updateTurn:a=!0,messageOptions:i={}}={}){let r=[];for(let[a,i]of("string"==typeof e?[e]:e).entries()){let e=this.combatants.get(i);if(!e?.isOwner)continue;let a=e.getInitiativeRoll(s);await a.evaluate(),r.push({_id:i,initiative:a.total})}return r.length&&(await this.updateEmbeddedDocuments("Combatant",r),a&&this.combatant?.id&&await this.update({turn:this.turns.findIndex(e=>e.id===this.combatant?.id)})),this}async update_combatant_initiative(e,s){if(null!=s)for(let s of game.combat.combatants.filter(s=>s.actorId===e.id))await game.combat.setInitiative(s.id,s.getInitiativeValue())}chase_label(e,s=!1){let a=s?e?.system?.scores?.willpower:e?.system?.scores?.defense;if(!a)return'<span class="defense-tn">&mdash;</span>';let i=e.system.scores.defense.roll,r="",n="";switch(i){case 1:r="critical failure",n="If this is a chase, the character encounters an obstacle.";break;case 9:case 10:r="critical success",n="If this is a chase, the character gains a leg up."}return`<span class="defense-tn ${r}" title="${n}">${a.tn}</span>`}async start_of_round(){let e=async e=>{for(let e of(await this.rollAll(),this.combatants))"character"===e.actor.type&&await e.actor.test({stat:"defense",effects:[{type:"defense"}],whisper:!0,chat:!0,...e.actor.total_modifiers({score:"defense"})});let s=`<h3>Round ${this.round}</h3><p><strong>Choose a Fast or Slow turn now!</strong></p><table class="sm-table">`;for(let e of this.combatants){if(e.hidden)continue;let a=Array.from(e.actor.statuses.map(e=>e.split(/\s|-/).map(e=>e.capitalize()).join(" "))).sort().join(", ");s+=`<tr><td><strong>${e.name}</strong></td><td>${a||"&mdash;"}</td></tr>`}for(let e of(s+="</table>",await ChatMessage.create({content:s}),s='<h4><strong>Defenses This Round</strong></h4><table class="sm-table">',this.combatants))s+=`<tr><td><strong>${e.name}</strong></td><td>Defense ${this.chase_label(e.actor)}</td><td>Willpower ${this.chase_label(e.actor,!0)}</td></tr>`;for(let e of(s+="</table>",await ChatMessage.create({content:s,whisper:game.users.filter(e=>e.isGM).map(e=>e.id)}),this.combatants))e.actor.statuses.has("dying")&&!e.actor.statuses.has("defeated")&&(await ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:e.actor}),content:`<p><strong>${e.name} is Dying!</strong></p><ul><li>Limited to 1 AP.</li><li>Making an Endurance test.<ul><li><em>Crit Success:</em> Lose a Dying.</li><li><em>Failure:</em> Gain a Dying.</li><li><em>3 Dying:</em> ${e.name} dies.</li></ul></li></ul>`}),await e.actor.test({stat:"endurance",tn:e.actor.dying_tn(),chat:!0,effects:[{type:"consequence",name:"Dying",when:"failure",target:"self"}],...e.actor.total_modifiers({score:"defense"})})),e.actor.statuses.has("bleeding")&&!e.actor.statuses.has("defeated")&&e.actor.items.filter(e=>"consequence"===e.type&&"Bleeding"===e.name).forEach(s=>{if(s.system.rank>0){let a=new $a92622f457efc12a$export$a32b0b1c1ac59d04({type:"damage",value:s.system.rank,damage_type:s.system.specialization,properties:"Ignores",when:"always",target:"self"}).apply();ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:e.actor}),content:`<p><strong>${e.name} is Bleeding!</strong></p><ul><li>Right-click and select Apply Damage.</li><li>${a.message}</li></ul>`})}})};new foundry.applications.api.DialogV2({window:{title:"Begin New Round?"},content:"<p>Do you want to begin a new round? Make sure to prompt your players to set their defenses first, if necessary.</p>",buttons:[{action:"yes",label:"Yes",icon:"fas fa-check",callback:e},{action:"no",label:"No",icon:"fas fa-times",callback:()=>{}}],default:"yes"}).render({force:!0})}}Hooks.on("renderCombatTracker",(e,s)=>{try{let a=e.viewed?.combatants,i=s instanceof HTMLElement?s:s?.[0]??null;if(!i||!a)return;i.querySelectorAll(".combatant").forEach(e=>{let s=e.getAttribute("data-combatant-id"),i=a.get(s);if(!i)return;let r=i.isNPC?"NPC":i.actor?.system?.fast_turn?"FAST":"SLOW",n=e.querySelector(".token-initiative");n&&(n.innerHTML=`<a class="combatant-control dlturnorder" title="Change Turn">${r}</a>`)}),i.querySelectorAll(".dlturnorder").forEach(s=>{s.addEventListener("click",async s=>{s.preventDefault();let i=s.currentTarget instanceof Element?s.currentTarget.closest("li"):null,r=i?.dataset?.combatantId;if(!r)return;let n=a.get(r);n&&!n.isNPC&&(game.user.isGM||n.actor?.isOwner)&&(await n.actor.update({"system.fast_turn":!n.actor.system.fast_turn}),e.viewed&&e.viewed.setupTurns())})})}catch(e){console.error("SagaMachine renderCombatTracker hook error:",e)}});var $3311d4ef469e3627$exports={};$3311d4ef469e3627$exports=function(){"use strict";function e(e,s){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);s&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(e,s).enumerable})),a.push.apply(a,i)}return a}function s(s){for(var a=1;a<arguments.length;a++){var i=null!=arguments[a]?arguments[a]:{};a%2?e(Object(i),!0).forEach(function(e){!function(e,s,a){var i;(s="symbol"==typeof(i=function(e,s){if("object"!=typeof e||null===e)return e;var a=e[Symbol.toPrimitive];if(void 0!==a){var i=a.call(e,s||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===s?String:Number)(e)}(s,"string"))?i:String(i))in e?Object.defineProperty(e,s,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[s]=a}(s,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(i)):e(Object(i)).forEach(function(e){Object.defineProperty(s,e,Object.getOwnPropertyDescriptor(i,e))})}return s}let a=(e,s,a,i)=>(e=""+e,s=""+s,i&&(e=e.trim(),s=s.trim()),a?e==s:e.toLowerCase()==s.toLowerCase()),i=(e,s)=>e&&Array.isArray(e)&&e.map(e=>r(e,s));function r(e,s){var a,i={};for(a in e)0>s.indexOf(a)&&(i[a]=e[a]);return i}function n(e){var s=document.createElement("div");return e.replace(/\&#?[0-9a-z]+;/gi,function(e){return s.innerHTML=e,s.innerText})}function o(e){return(new DOMParser).parseFromString(e.trim(),"text/html").body.firstElementChild}function c(e,s){for(s=s||"previous";e=e[s+"Sibling"];)if(3==e.nodeType)return e}function l(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/`|'/g,"&#039;"):e}function d(e){var s=Object.prototype.toString.call(e).split(" ")[1].slice(0,-1);return e===Object(e)&&"Array"!=s&&"Function"!=s&&"RegExp"!=s&&"HTMLUnknownElement"!=s}function p(e,s,a){function i(e,s){for(var a in s)if(s.hasOwnProperty(a)){if(d(s[a])){d(e[a])?i(e[a],s[a]):e[a]=Object.assign({},s[a]);continue}if(Array.isArray(s[a])){e[a]=Object.assign([],s[a]);continue}e[a]=s[a]}}return e instanceof Object||(e={}),i(e,s),a&&i(e,a),e}function h(){let e=[],s={};for(let a of arguments)for(let i of a)d(i)?s[i.value]||(e.push(i),s[i.value]=1):e.includes(i)||e.push(i);return e}function u(e){return String.prototype.normalize?"string"==typeof e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,""):void 0:e}function f(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function m(e){return e&&e.classList&&e.classList.contains(this.settings.classNames.tag)}function g(e,s){var a=window.getSelection();return s=s||a.getRangeAt(0),"string"==typeof e&&(e=document.createTextNode(e)),s&&(s.deleteContents(),s.insertNode(e)),e}function b(e,s,a){return e?(s&&(e.__tagifyTagData=a?s:p({},e.__tagifyTagData||{},s)),e.__tagifyTagData):(console.warn("tag element doesn't exist",e,s),s)}function y(e){if(e&&e.parentNode){var s=window.getSelection(),a=s.getRangeAt(0);s.rangeCount&&(a.setStartAfter(e),a.collapse(!0),s.removeAllRanges(),s.addRange(a))}}function v(e,s){e.forEach(e=>{if(b(e.previousSibling)||!e.previousSibling){var a=document.createTextNode("​");e.before(a),s&&y(a)}})}var _={delimiters:",",pattern:null,tagTextProp:"value",maxTags:1/0,callbacks:{},addTagOnBlur:!0,onChangeAfterBlur:!0,duplicates:!1,whitelist:[],blacklist:[],enforceWhitelist:!1,userInput:!0,keepInvalidTags:!1,createInvalidTags:!0,mixTagsAllowedAfter:/,|\.|\:|\s/,mixTagsInterpolator:["[[","]]"],backspace:!0,skipInvalid:!1,pasteAsTags:!0,editTags:{clicks:2,keepInvalid:!0},transformTag:()=>{},trim:!0,a11y:{focusableTags:!1},mixMode:{insertAfterTag:" "},autoComplete:{enabled:!0,rightKey:!1},classNames:{namespace:"tagify",mixMode:"tagify--mix",selectMode:"tagify--select",input:"tagify__input",focus:"tagify--focus",tagNoAnimation:"tagify--noAnim",tagInvalid:"tagify--invalid",tagNotAllowed:"tagify--notAllowed",scopeLoading:"tagify--loading",hasMaxTags:"tagify--hasMaxTags",hasNoTags:"tagify--noTags",empty:"tagify--empty",inputInvalid:"tagify__input--invalid",dropdown:"tagify__dropdown",dropdownWrapper:"tagify__dropdown__wrapper",dropdownHeader:"tagify__dropdown__header",dropdownFooter:"tagify__dropdown__footer",dropdownItem:"tagify__dropdown__item",dropdownItemActive:"tagify__dropdown__item--active",dropdownItemHidden:"tagify__dropdown__item--hidden",dropdownInital:"tagify__dropdown--initial",tag:"tagify__tag",tagText:"tagify__tag-text",tagX:"tagify__tag__removeBtn",tagLoading:"tagify__tag--loading",tagEditing:"tagify__tag--editable",tagFlash:"tagify__tag--flash",tagHide:"tagify__tag--hide"},dropdown:{classname:"",enabled:2,maxItems:10,searchKeys:["value","searchBy"],fuzzySearch:!0,caseSensitive:!1,accentedSearch:!0,includeSelectedTags:!1,highlightFirst:!1,closeOnSelect:!0,clearOnSelect:!0,position:"all",appendTarget:null},hooks:{beforeRemoveTag:()=>Promise.resolve(),beforePaste:()=>Promise.resolve(),suggestionClick:()=>Promise.resolve()}};function w(){for(let e in this.dropdown={},this._dropdown)this.dropdown[e]="function"==typeof this._dropdown[e]?this._dropdown[e].bind(this):this._dropdown[e];this.dropdown.refs()}let x="@yaireo/tagify/";var T,k={empty:"empty",exceed:"number of tags exceeded",pattern:"pattern mismatch",duplicate:"already exists",notAllowed:"not allowed"};function D(e,s){var a;let i,r;if(!e){console.warn("Tagify:","input element not found",e);let s=new Proxy(this,{get:()=>()=>s});return s}if(e.__tagify)return console.warn("Tagify: ","input element is already Tagified - Same instance is returned.",e),e.__tagify;p(this,function(e){var s=document.createTextNode("");function a(e,a,i){i&&a.split(/\s+/g).forEach(a=>s[e+"EventListener"].call(s,a,i))}return{off(e,s){return a("remove",e,s),this},on(e,s){return s&&"function"==typeof s&&a("add",e,s),this},trigger(a,i,r){var n;if(r=r||{cloneData:!0},a)if(e.settings.isJQueryPlugin)"remove"==a&&(a="removeTag"),jQuery(e.DOM.originalInput).triggerHandler(a,[i]);else{try{var o="object"==typeof i?i:{value:i};if((o=r.cloneData?p({},o):o).tagify=this,i.event&&(o.event=this.cloneEvent(i.event)),i instanceof Object)for(var c in i)i[c]instanceof HTMLElement&&(o[c]=i[c]);n=new CustomEvent(a,{detail:o})}catch(e){console.warn(e)}s.dispatchEvent(n)}}}}(this)),this.isFirefox=/firefox|fxios/i.test(navigator.userAgent)&&!/seamonkey/i.test(navigator.userAgent),this.isIE=window.document.documentMode,s=s||{},this.getPersistedData=(a=s.id,e=>{let s;if(1==localStorage.getItem(x+a+"/v",1))try{s=JSON.parse(localStorage[x+a+"/"+e])}catch(e){}return s}),this.setPersistedData=(i=s.id)?(localStorage.setItem(x+i+"/v",1),(e,s)=>{let a=JSON.stringify(e);e&&s&&(localStorage.setItem(x+i+"/"+s,a),dispatchEvent(new Event("storage")))}):()=>{},this.clearPersistedData=(r=s.id,e=>{let s=x+"/"+r+"/";if(e)localStorage.removeItem(s+e);else for(let e in localStorage)e.includes(s)&&localStorage.removeItem(e)}),this.applySettings(e,s),this.state={inputText:"",editing:!1,composing:!1,actions:{},mixMode:{},dropdown:{},flaggedTags:{}},this.value=[],this.listeners={},this.DOM={},this.build(e),w.call(this),this.getCSSVars(),this.loadOriginalValues(),this.events.customBinding.call(this),this.events.binding.call(this),e.autofocus&&this.DOM.input.focus(),e.__tagify=this}return D.prototype={_dropdown:{refs(){this.DOM.dropdown=this.parseTemplate("dropdown",[this.settings]),this.DOM.dropdown.content=this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-wrapper']")},getHeaderRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-header']")},getFooterRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-footer']")},getAllSuggestionsRefs(){return[...this.DOM.dropdown.content.querySelectorAll(this.settings.classNames.dropdownItemSelector)]},show(e){var s,i,r,n=this.settings,o="mix"==n.mode&&!n.enforceWhitelist,c=!n.whitelist||!n.whitelist.length,l="manual"==n.dropdown.position;if(e=void 0===e?this.state.inputText:e,!(c&&!o&&!n.templates.dropdownItemNoMatch||!1===n.dropdown.enable||this.state.isLoading||this.settings.readonly)){if(clearTimeout(this.dropdownHide__bindEventsTimeout),this.suggestedListItems=this.dropdown.filterListItems(e),e&&!this.suggestedListItems.length&&(this.trigger("dropdown:noMatch",e),n.templates.dropdownItemNoMatch&&(r=n.templates.dropdownItemNoMatch.call(this,{value:e}))),!r){if(this.suggestedListItems.length)e&&o&&!this.state.editing.scope&&!a(this.suggestedListItems[0].value,e)&&this.suggestedListItems.unshift({value:e});else{if(!e||!o||this.state.editing.scope)return this.input.autocomplete.suggest.call(this),void this.dropdown.hide();this.suggestedListItems=[{value:e}]}i=""+(d(s=this.suggestedListItems[0])?s.value:s),n.autoComplete&&i&&0==i.indexOf(e)&&this.input.autocomplete.suggest.call(this,s)}this.dropdown.fill(r),n.dropdown.highlightFirst&&this.dropdown.highlightOption(this.DOM.dropdown.content.querySelector(n.classNames.dropdownItemSelector)),this.state.dropdown.visible||setTimeout(this.dropdown.events.binding.bind(this)),this.state.dropdown.visible=e||!0,this.state.dropdown.query=e,this.setStateSelection(),l||setTimeout(()=>{this.dropdown.position(),this.dropdown.render()}),setTimeout(()=>{this.trigger("dropdown:show",this.DOM.dropdown)})}},hide(e){var s=this.DOM,a=s.scope,i=s.dropdown,r="manual"==this.settings.dropdown.position&&!e;if(i&&document.body.contains(i)&&!r)return window.removeEventListener("resize",this.dropdown.position),this.dropdown.events.binding.call(this,!1),a.setAttribute("aria-expanded",!1),i.parentNode.removeChild(i),setTimeout(()=>{this.state.dropdown.visible=!1},100),this.state.dropdown.query=this.state.ddItemData=this.state.ddItemElm=this.state.selection=null,this.state.tag&&this.state.tag.value.length&&(this.state.flaggedTags[this.state.tag.baseOffset]=this.state.tag),this.trigger("dropdown:hide",i),this},toggle(e){this.dropdown[this.state.dropdown.visible&&!e?"hide":"show"]()},render(){var e,s,a=((s=this.DOM.dropdown.cloneNode(!0)).style.cssText="position:fixed; top:-9999px; opacity:0",document.body.appendChild(s),e=s.clientHeight,s.parentNode.removeChild(s),e),i=this.settings;return"number"==typeof i.dropdown.enabled&&i.dropdown.enabled>=0&&(this.DOM.scope.setAttribute("aria-expanded",!0),document.body.contains(this.DOM.dropdown)||(this.DOM.dropdown.classList.add(i.classNames.dropdownInital),this.dropdown.position(a),i.dropdown.appendTarget.appendChild(this.DOM.dropdown),setTimeout(()=>this.DOM.dropdown.classList.remove(i.classNames.dropdownInital)))),this},fill(e){e="string"==typeof e?e:this.dropdown.createListHTML(e||this.suggestedListItems);var s=this.settings.templates.dropdownContent.call(this,e);this.DOM.dropdown.content.innerHTML=s?s.replace(/\>[\r\n ]+\</g,"><").split(/>\s+</).join("><").trim():""},fillHeaderFooter(){var e=this.dropdown.filterListItems(this.state.dropdown.query),s=this.parseTemplate("dropdownHeader",[e]),a=this.parseTemplate("dropdownFooter",[e]),i=this.dropdown.getHeaderRef(),r=this.dropdown.getFooterRef();s&&i?.parentNode.replaceChild(s,i),a&&r?.parentNode.replaceChild(a,r)},refilter(e){e=e||this.state.dropdown.query||"",this.suggestedListItems=this.dropdown.filterListItems(e),this.dropdown.fill(),this.suggestedListItems.length||this.dropdown.hide(),this.trigger("dropdown:updated",this.DOM.dropdown)},position(e){var s=this.settings.dropdown;if("manual"!=s.position){var a,i,r,n,o,c,l=this.DOM.dropdown,d=s.placeAbove,p=s.appendTarget===document.body,h=p?window.pageYOffset:s.appendTarget.scrollTop,u=document.fullscreenElement||document.webkitFullscreenElement||document.documentElement,f=u.clientHeight,m=Math.max(u.clientWidth||0,window.innerWidth||0)>480?s.position:"all",g=this.DOM["input"==m?"input":"scope"];if(e=e||l.clientHeight,this.state.dropdown.visible){if("text"==m?(r=(a=function(){let e=document.getSelection();if(e.rangeCount){let s,a,i=e.getRangeAt(0),r=i.startContainer,n=i.startOffset;if(n>0)return(a=document.createRange()).setStart(r,n-1),a.setEnd(r,n),{left:(s=a.getBoundingClientRect()).right,top:s.top,bottom:s.bottom};if(r.getBoundingClientRect)return r.getBoundingClientRect()}return{left:-9999,top:-9999}}()).bottom,i=a.top,n=a.left,o="auto"):(c=function(e){for(var s=0,a=0;e&&e!=u;)s+=e.offsetLeft||0,a+=e.offsetTop||0,e=e.parentNode;return{left:s,top:a}}(s.appendTarget),i=(a=g.getBoundingClientRect()).top-c.top,r=a.bottom-1-c.top,n=a.left-c.left,o=a.width+"px"),!p){let e=function(){for(var e=0,a=s.appendTarget.parentNode;a;)e+=a.scrollTop||0,a=a.parentNode;return e}();i+=e,r+=e}i=Math.floor(i),r=Math.ceil(r),d=void 0===d?f-a.bottom<e:d,l.style.cssText="left:"+(n+window.pageXOffset)+"px; width:"+o+";"+(d?"top: "+(i+h)+"px":"top: "+(r+h)+"px"),l.setAttribute("placement",d?"top":"bottom"),l.setAttribute("position",m)}}},events:{binding(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var s=this.dropdown.events.callbacks,a=this.listeners.dropdown=this.listeners.dropdown||{position:this.dropdown.position.bind(this,null),onKeyDown:s.onKeyDown.bind(this),onMouseOver:s.onMouseOver.bind(this),onMouseLeave:s.onMouseLeave.bind(this),onClick:s.onClick.bind(this),onScroll:s.onScroll.bind(this)},i=e?"addEventListener":"removeEventListener";"manual"!=this.settings.dropdown.position&&(document[i]("scroll",a.position,!0),window[i]("resize",a.position),window[i]("keydown",a.onKeyDown)),this.DOM.dropdown[i]("mouseover",a.onMouseOver),this.DOM.dropdown[i]("mouseleave",a.onMouseLeave),this.DOM.dropdown[i]("mousedown",a.onClick),this.DOM.dropdown.content[i]("scroll",a.onScroll)},callbacks:{onKeyDown(e){if(this.state.hasFocus&&!this.state.composing){var s=this.DOM.dropdown.querySelector(this.settings.classNames.dropdownItemActiveSelector),a=this.dropdown.getSuggestionDataByNode(s);switch(e.key){case"ArrowDown":case"ArrowUp":case"Down":case"Up":e.preventDefault();var i=this.dropdown.getAllSuggestionsRefs(),r="ArrowUp"==e.key||"Up"==e.key;s&&(s=this.dropdown.getNextOrPrevOption(s,!r)),s&&s.matches(this.settings.classNames.dropdownItemSelector)||(s=i[r?i.length-1:0]),this.dropdown.highlightOption(s,!0);break;case"Escape":case"Esc":this.dropdown.hide();break;case"ArrowRight":if(this.state.actions.ArrowLeft)return;case"Tab":if("mix"!=this.settings.mode&&s&&!this.settings.autoComplete.rightKey&&!this.state.editing){e.preventDefault();var n=this.dropdown.getMappedValue(a);return this.input.autocomplete.set.call(this,n),!1}return!0;case"Enter":e.preventDefault(),this.settings.hooks.suggestionClick(e,{tagify:this,tagData:a,suggestionElm:s}).then(()=>{s?(this.dropdown.selectOption(s),s=this.dropdown.getNextOrPrevOption(s,!r),this.dropdown.highlightOption(s)):(this.dropdown.hide(),"mix"!=this.settings.mode&&this.addTags(this.state.inputText.trim(),!0))}).catch(e=>e);break;case"Backspace":{if("mix"==this.settings.mode||this.state.editing.scope)return;let e=this.input.raw.call(this);""!=e&&8203!=e.charCodeAt(0)||(!0===this.settings.backspace?this.removeTags():"edit"==this.settings.backspace&&setTimeout(this.editTag.bind(this),0))}}}},onMouseOver(e){var s=e.target.closest(this.settings.classNames.dropdownItemSelector);s&&this.dropdown.highlightOption(s)},onMouseLeave(e){this.dropdown.highlightOption()},onClick(e){if(0==e.button&&e.target!=this.DOM.dropdown&&e.target!=this.DOM.dropdown.content){var s=e.target.closest(this.settings.classNames.dropdownItemSelector),a=this.dropdown.getSuggestionDataByNode(s);this.state.actions.selectOption=!0,setTimeout(()=>this.state.actions.selectOption=!1,50),this.settings.hooks.suggestionClick(e,{tagify:this,tagData:a,suggestionElm:s}).then(()=>{s?this.dropdown.selectOption(s,e):this.dropdown.hide()}).catch(e=>console.warn(e))}},onScroll(e){var s=e.target,a=s.scrollTop/(s.scrollHeight-s.parentNode.clientHeight)*100;this.trigger("dropdown:scroll",{percentage:Math.round(a)})}}},getSuggestionDataByNode(e){var s=e&&e.getAttribute("value");return this.suggestedListItems.find(e=>e.value==s)||null},getNextOrPrevOption(e){let s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var a=this.dropdown.getAllSuggestionsRefs(),i=a.findIndex(s=>s===e);return s?a[i+1]:a[i-1]},highlightOption(e,s){var a,i=this.settings.classNames.dropdownItemActive;(this.state.ddItemElm&&(this.state.ddItemElm.classList.remove(i),this.state.ddItemElm.removeAttribute("aria-selected")),e)?(a=this.dropdown.getSuggestionDataByNode(e),this.state.ddItemData=a,this.state.ddItemElm=e,e.classList.add(i),e.setAttribute("aria-selected",!0),s&&(e.parentNode.scrollTop=e.clientHeight+e.offsetTop-e.parentNode.clientHeight),this.settings.autoComplete&&(this.input.autocomplete.suggest.call(this,a),this.dropdown.position())):(this.state.ddItemData=null,this.state.ddItemElm=null,this.input.autocomplete.suggest.call(this))},selectOption(e,s){var a=this.settings.dropdown,i=a.clearOnSelect,r=a.closeOnSelect;if(!e)return this.addTags(this.state.inputText,!0),void(r&&this.dropdown.hide());s=s||{};var n=e.getAttribute("value"),o=this.suggestedListItems.find(e=>(e.value??e)==n);this.trigger("dropdown:select",{data:o,elm:e,event:s}),n&&(o||"noMatch"==n)?(this.state.editing?this.onEditTagDone(null,p({__isValid:!0},this.normalizeTags([o])[0])):this["mix"==this.settings.mode?"addMixTags":"addTags"]([o||this.input.raw.call(this)],i),this.DOM.input.parentNode&&(setTimeout(()=>{this.DOM.input.focus(),this.toggleFocusClass(!0)}),r&&setTimeout(this.dropdown.hide.bind(this)),e.addEventListener("transitionend",()=>{this.dropdown.fillHeaderFooter(),setTimeout(()=>e.remove(),100)},{once:!0}),e.classList.add(this.settings.classNames.dropdownItemHidden))):r&&setTimeout(this.dropdown.hide.bind(this))},selectAll(e){this.suggestedListItems.length=0,this.dropdown.hide(),this.dropdown.filterListItems("");var s=this.dropdown.filterListItems("");return e||(s=this.state.dropdown.suggestions),this.addTags(s,!0),this},filterListItems(e,s){var a,i,r,n,o,c=this.settings,l=c.dropdown,p=(s=s||{},[]),h=[],f=c.whitelist,m=l.maxItems>=0?l.maxItems:1/0,g=l.searchKeys,b=0;if(!(e="select"==c.mode&&this.value.length&&this.value[0][c.tagTextProp]==e?"":e)||!g.length)return p=l.includeSelectedTags?f:f.filter(e=>!this.isTagDuplicate(d(e)?e.value:e)),this.state.dropdown.suggestions=p,p.slice(0,m);for(o=l.caseSensitive?""+e:(""+e).toLowerCase();b<f.length;b++){let e,c,m=Object.keys(a=f[b]instanceof Object?f[b]:{value:f[b]}).some(e=>g.includes(e))?g:["value"];l.fuzzySearch&&!s.exact?(r=m.reduce((e,s)=>e+" "+(a[s]||""),"").toLowerCase().trim(),l.accentedSearch&&(r=u(r),o=u(o)),e=0==r.indexOf(o),c=r===o,i=function(e,s){return s.toLowerCase().split(" ").every(s=>e.includes(s.toLowerCase()))}(r,o)):(e=!0,i=m.some(e=>{var i=""+(a[e]||"");return l.accentedSearch&&(i=u(i),o=u(o)),l.caseSensitive||(i=i.toLowerCase()),c=i===o,s.exact?i===o:0==i.indexOf(o)})),n=!l.includeSelectedTags&&this.isTagDuplicate(d(a)?a.value:a),i&&!n&&(c&&e?h.push(a):"startsWith"==l.sortby&&e?p.unshift(a):p.push(a))}return this.state.dropdown.suggestions=h.concat(p),"function"==typeof l.sortby?l.sortby(h.concat(p),o):h.concat(p).slice(0,m)},getMappedValue(e){var s=this.settings.dropdown.mapValueTo;return s?"function"==typeof s?s(e):e[s]||e.value:e.value},createListHTML(e){return p([],e).map((e,a)=>{"string"!=typeof e&&"number"!=typeof e||(e={value:e});var i=this.dropdown.getMappedValue(e);return i="string"==typeof i?l(i):i,this.settings.templates.dropdownItem.apply(this,[s(s({},e),{},{mappedValue:i}),this])}).join("")}},getSetTagData:b,helpers:{sameStr:a,removeCollectionProp:i,omit:r,isObject:d,parseHTML:o,escapeHTML:l,extend:p,concatWithoutDups:h,getUID:f,isNodeTag:m},customEventsList:["change","add","remove","invalid","input","click","keydown","focus","blur","edit:input","edit:beforeUpdate","edit:updated","edit:start","edit:keydown","dropdown:show","dropdown:hide","dropdown:select","dropdown:updated","dropdown:noMatch","dropdown:scroll"],dataProps:["__isValid","__removed","__originalData","__originalHTML","__tagId"],trim(e){return this.settings.trim&&e&&"string"==typeof e?e.trim():e},parseHTML:o,templates:{wrapper:(e,s)=>`<tags class="${s.classNames.namespace} ${s.mode?`${s.classNames[s.mode+"Mode"]}`:""} ${e.className}"
                    ${s.readonly?"readonly":""}
                    ${s.disabled?"disabled":""}
                    ${s.required?"required":""}
                    ${"select"===s.mode?"spellcheck='false'":""}
                    tabIndex="-1">
            <span ${!s.readonly&&s.userInput?"contenteditable":""} tabIndex="0" data-placeholder="${s.placeholder||"&#8203;"}" aria-placeholder="${s.placeholder||""}"
                class="${s.classNames.input}"
                role="textbox"
                aria-autocomplete="both"
                aria-multiline="${"mix"==s.mode}"></span>
                &#8203;
        </tags>`,tag(e,s){let a=s.settings;return`<tag title="${e.title||e.value}"
                    contenteditable='false'
                    spellcheck='false'
                    tabIndex="${a.a11y.focusableTags?0:-1}"
                    class="${a.classNames.tag} ${e.class||""}"
                    ${this.getAttributes(e)}>
            <x title='' class="${a.classNames.tagX}" role='button' aria-label='remove tag'></x>
            <div>
                <span class="${a.classNames.tagText}">${e[a.tagTextProp]||e.value}</span>
            </div>
        </tag>`},dropdown(e){var s=e.dropdown,a="manual"==s.position,i=`${e.classNames.dropdown}`;return`<div class="${a?"":i} ${s.classname}" role="listbox" aria-labelledby="dropdown">
                    <div data-selector='tagify-suggestions-wrapper' class="${e.classNames.dropdownWrapper}"></div>
                </div>`},dropdownContent(e){var s=this.settings,a=this.state.dropdown.suggestions;return`
            ${s.templates.dropdownHeader.call(this,a)}
            ${e}
            ${s.templates.dropdownFooter.call(this,a)}
        `},dropdownItem(e){return`<div ${this.getAttributes(e)}
                    class='${this.settings.classNames.dropdownItem} ${e.class?e.class:""}'
                    tabindex="0"
                    role="option">${e.mappedValue||e.value}</div>`},dropdownHeader(e){return`<header data-selector='tagify-suggestions-header' class="${this.settings.classNames.dropdownHeader}"></header>`},dropdownFooter(e){var s=e.length-this.settings.dropdown.maxItems;return s>0?`<footer data-selector='tagify-suggestions-footer' class="${this.settings.classNames.dropdownFooter}">
                ${s} more items. Refine your search.
            </footer>`:""},dropdownItemNoMatch:null},parseTemplate(e,s){return o((e=this.settings.templates[e]||e).apply(this,s))},set whitelist(t){let e=t&&Array.isArray(t);this.settings.whitelist=e?t:[],this.setPersistedData(e?t:[],"whitelist")},get whitelist(){return this.settings.whitelist},generateClassSelectors(e){for(let s in e){let a=s;Object.defineProperty(e,a+"Selector",{get(){return"."+this[a].split(" ")[0]}})}},applySettings(e,a){_.templates=this.templates;var i=p({},_,"mix"==a.mode?{dropdown:{position:"text"}}:{}),r=this.settings=p({},i,a);if(r.disabled=e.hasAttribute("disabled"),r.readonly=r.readonly||e.hasAttribute("readonly"),r.placeholder=l(e.getAttribute("placeholder")||r.placeholder||""),r.required=e.hasAttribute("required"),this.generateClassSelectors(r.classNames),void 0===r.dropdown.includeSelectedTags&&(r.dropdown.includeSelectedTags=r.duplicates),this.isIE&&(r.autoComplete=!1),["whitelist","blacklist"].forEach(s=>{var a=e.getAttribute("data-"+s);a&&(a=a.split(r.delimiters))instanceof Array&&(r[s]=a)}),"autoComplete"in a&&!d(a.autoComplete)&&(r.autoComplete=_.autoComplete,r.autoComplete.enabled=a.autoComplete),"mix"==r.mode&&(r.pattern=r.pattern||/@/,r.autoComplete.rightKey=!0,r.delimiters=a.delimiters||null,r.tagTextProp&&!r.dropdown.searchKeys.includes(r.tagTextProp)&&r.dropdown.searchKeys.push(r.tagTextProp)),e.pattern)try{r.pattern=new RegExp(e.pattern)}catch(e){}if(r.delimiters){r._delimiters=r.delimiters;try{r.delimiters=RegExp(this.settings.delimiters,"g")}catch(e){}}r.disabled&&(r.userInput=!1),this.TEXTS=s(s({},k),r.texts||{}),("select"!=r.mode||a.dropdown?.enabled)&&r.userInput||(r.dropdown.enabled=0),r.dropdown.appendTarget=a.dropdown?.appendTarget||document.body;let n=this.getPersistedData("whitelist");Array.isArray(n)&&(this.whitelist=Array.isArray(r.whitelist)?h(r.whitelist,n):n)},getAttributes(e){var s,a=this.getCustomAttributes(e),i="";for(s in a)i+=" "+s+(void 0!==e[s]?`="${a[s]}"`:"");return i},getCustomAttributes(e){if(!d(e))return"";var s,a={};for(s in e)"__"!=s.slice(0,2)&&"class"!=s&&e.hasOwnProperty(s)&&void 0!==e[s]&&(a[s]=l(e[s]));return a},setStateSelection(){var e=window.getSelection(),s={anchorOffset:e.anchorOffset,anchorNode:e.anchorNode,range:e.getRangeAt&&e.rangeCount&&e.getRangeAt(0)};return this.state.selection=s,s},getCSSVars(){let e;var s,a=getComputedStyle(this.DOM.scope,null);this.CSSVars={tagHideTransition:(e=(s=function(e){if(!e)return{};var s=(e=e.trim().split(" ")[0]).split(/\d+/g).filter(e=>e).pop().trim();return{value:+e.split(s).filter(e=>e)[0].trim(),unit:s}}(a.getPropertyValue("--tag-hide-transition"))).value,"s"==s.unit?1e3*e:e)}},build(e){var s=this.DOM;this.settings.mixMode.integrated?(s.originalInput=null,s.scope=e,s.input=e):(s.originalInput=e,s.originalInput_tabIndex=e.tabIndex,s.scope=this.parseTemplate("wrapper",[e,this.settings]),s.input=s.scope.querySelector(this.settings.classNames.inputSelector),e.parentNode.insertBefore(s.scope,e),e.tabIndex=-1)},destroy(){this.events.unbindGlobal.call(this),this.DOM.scope.parentNode.removeChild(this.DOM.scope),this.DOM.originalInput.tabIndex=this.DOM.originalInput_tabIndex,delete this.DOM.originalInput.__tagify,this.dropdown.hide(!0),clearTimeout(this.dropdownHide__bindEventsTimeout),clearInterval(this.listeners.main.originalInputValueObserverInterval)},loadOriginalValues(e){var s,a=this.settings;if(this.state.blockChangeEvent=!0,void 0===e){let s=this.getPersistedData("value");e=s&&!this.DOM.originalInput.value?s:a.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value}if(this.removeAllTags(),e)if("mix"==a.mode)this.parseMixTags(e),(s=this.DOM.input.lastChild)&&"BR"==s.tagName||this.DOM.input.insertAdjacentHTML("beforeend","<br>");else{try{JSON.parse(e)instanceof Array&&(e=JSON.parse(e))}catch(e){}this.addTags(e,!0).forEach(e=>e&&e.classList.add(a.classNames.tagNoAnimation))}else this.postUpdate();this.state.lastOriginalValueReported=a.mixMode.integrated?"":this.DOM.originalInput.value},cloneEvent(e){var s={};for(var a in e)"path"!=a&&(s[a]=e[a]);return s},loading(e){return this.state.isLoading=e,this.DOM.scope.classList[e?"add":"remove"](this.settings.classNames.scopeLoading),this},tagLoading(e,s){return e&&e.classList[s?"add":"remove"](this.settings.classNames.tagLoading),this},toggleClass(e,s){"string"==typeof e&&this.DOM.scope.classList.toggle(e,s)},toggleScopeValidation(e){var s=!0===e||void 0===e;!this.settings.required&&e&&e===this.TEXTS.empty&&(s=!0),this.toggleClass(this.settings.classNames.tagInvalid,!s),this.DOM.scope.title=s?"":e},toggleFocusClass(e){this.toggleClass(this.settings.classNames.focus,!!e)},triggerChangeEvent:function(){if(!this.settings.mixMode.integrated){var e=this.DOM.originalInput,s=this.state.lastOriginalValueReported!==e.value,a=new CustomEvent("change",{bubbles:!0});s&&(this.state.lastOriginalValueReported=e.value,a.simulated=!0,e._valueTracker&&e._valueTracker.setValue(Math.random()),e.dispatchEvent(a),this.trigger("change",this.state.lastOriginalValueReported),e.value=this.state.lastOriginalValueReported)}},events:{customBinding(){this.customEventsList.forEach(e=>{this.on(e,this.settings.callbacks[e])})},binding(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var s,a=this.events.callbacks,i=e?"addEventListener":"removeEventListener";if(!this.state.mainEvents||!e){for(var r in this.state.mainEvents=e,e&&!this.listeners.main&&(this.events.bindGlobal.call(this),this.settings.isJQueryPlugin&&jQuery(this.DOM.originalInput).on("tagify.removeAllTags",this.removeAllTags.bind(this))),s=this.listeners.main=this.listeners.main||{focus:["input",a.onFocusBlur.bind(this)],keydown:["input",a.onKeydown.bind(this)],click:["scope",a.onClickScope.bind(this)],dblclick:["scope",a.onDoubleClickScope.bind(this)],paste:["input",a.onPaste.bind(this)],drop:["input",a.onDrop.bind(this)],compositionstart:["input",a.onCompositionStart.bind(this)],compositionend:["input",a.onCompositionEnd.bind(this)]})this.DOM[s[r][0]][i](r,s[r][1]);clearInterval(this.listeners.main.originalInputValueObserverInterval),this.listeners.main.originalInputValueObserverInterval=setInterval(a.observeOriginalInputValue.bind(this),500);var n=this.listeners.main.inputMutationObserver||new MutationObserver(a.onInputDOMChange.bind(this));n.disconnect(),"mix"==this.settings.mode&&n.observe(this.DOM.input,{childList:!0})}},bindGlobal(e){var s,a=this.events.callbacks,i=e?"removeEventListener":"addEventListener";if(this.listeners&&(e||!this.listeners.global))for(s of(this.listeners.global=this.listeners.global||[{type:this.isIE?"keydown":"input",target:this.DOM.input,cb:a[this.isIE?"onInputIE":"onInput"].bind(this)},{type:"keydown",target:window,cb:a.onWindowKeyDown.bind(this)},{type:"blur",target:this.DOM.input,cb:a.onFocusBlur.bind(this)},{type:"click",target:document,cb:a.onClickAnywhere.bind(this)}],this.listeners.global))s.target[i](s.type,s.cb)},unbindGlobal(){this.events.bindGlobal.call(this,!0)},callbacks:{onFocusBlur(e){var s=this.settings,a=e.target?this.trim(e.target.textContent):"",i=this.value?.[0]?.[s.tagTextProp],r=e.type,n=s.dropdown.enabled>=0,o={relatedTarget:e.relatedTarget},c=this.state.actions.selectOption&&(n||!s.dropdown.closeOnSelect),l=this.state.actions.addNew&&n,d=e.relatedTarget&&m.call(this,e.relatedTarget)&&this.DOM.scope.contains(e.relatedTarget);if("blur"==r){if(e.relatedTarget===this.DOM.scope)return this.dropdown.hide(),void this.DOM.input.focus();this.postUpdate(),s.onChangeAfterBlur&&this.triggerChangeEvent()}if(!c&&!l)if(this.state.hasFocus="focus"==r&&+new Date,this.toggleFocusClass(this.state.hasFocus),"mix"!=s.mode){if("focus"==r)return this.trigger("focus",o),void(0!==s.dropdown.enabled&&s.userInput||this.dropdown.show(this.value.length?"":void 0));"blur"==r&&(this.trigger("blur",o),this.loading(!1),"select"==s.mode&&(d&&(this.removeTags(),a=""),i===a&&(a="")),a&&!this.state.actions.selectOption&&s.addTagOnBlur&&this.addTags(a,!0)),this.DOM.input.removeAttribute("style"),this.dropdown.hide()}else"focus"==r?this.trigger("focus",o):"blur"==e.type&&(this.trigger("blur",o),this.loading(!1),this.dropdown.hide(),this.state.dropdown.visible=void 0,this.setStateSelection())},onCompositionStart(e){this.state.composing=!0},onCompositionEnd(e){this.state.composing=!1},onWindowKeyDown(e){var s,a=document.activeElement,i=m.call(this,a)&&this.DOM.scope.contains(document.activeElement),r=i&&a.hasAttribute("readonly");if(i&&!r)switch(s=a.nextElementSibling,e.key){case"Backspace":this.settings.readonly||(this.removeTags(a),(s||this.DOM.input).focus());break;case"Enter":setTimeout(this.editTag.bind(this),0,a)}},onKeydown(e){var s=this.settings;if(!this.state.composing&&s.userInput){"select"==s.mode&&s.enforceWhitelist&&this.value.length&&"Tab"!=e.key&&e.preventDefault();var a=this.trim(e.target.textContent);if(this.trigger("keydown",{event:e}),"mix"==s.mode){switch(e.key){case"Left":case"ArrowLeft":this.state.actions.ArrowLeft=!0;break;case"Delete":case"Backspace":if(this.state.editing)return;var i=document.getSelection(),r="Delete"==e.key&&i.anchorOffset==(i.anchorNode.length||0),o=i.anchorNode.previousSibling,l=1==i.anchorNode.nodeType||!i.anchorOffset&&o&&1==o.nodeType&&i.anchorNode.previousSibling;n(this.DOM.input.innerHTML);var d,p,h,u=this.getTagElms(),f=1===i.anchorNode.length&&i.anchorNode.nodeValue==String.fromCharCode(8203);if("edit"==s.backspace&&l)return d=1==i.anchorNode.nodeType?null:i.anchorNode.previousElementSibling,setTimeout(this.editTag.bind(this),0,d),void e.preventDefault();if(/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent)&&l instanceof Element)return h=c(l),l.hasAttribute("readonly")||l.remove(),this.DOM.input.focus(),void setTimeout(()=>{y(h),this.DOM.input.click()});if("BR"==i.anchorNode.nodeName)return;if((r||l)&&1==i.anchorNode.nodeType?p=0==i.anchorOffset?r?u[0]:null:u[Math.min(u.length,i.anchorOffset)-1]:r?p=i.anchorNode.nextElementSibling:l instanceof Element&&(p=l),3==i.anchorNode.nodeType&&!i.anchorNode.nodeValue&&i.anchorNode.previousElementSibling&&e.preventDefault(),(l||r)&&!s.backspace||"Range"!=i.type&&!i.anchorOffset&&i.anchorNode==this.DOM.input&&"Delete"!=e.key)return void e.preventDefault();if("Range"!=i.type&&p&&p.hasAttribute("readonly"))return void y(c(p));"Delete"==e.key&&f&&b(i.anchorNode.nextSibling)&&this.removeTags(i.anchorNode.nextSibling),clearTimeout(T),T=setTimeout(()=>{var e=document.getSelection();n(this.DOM.input.innerHTML),r||e.anchorNode.previousSibling,this.value=[].map.call(u,(e,s)=>{var a=b(e);if(e.parentNode||a.readonly)return a;this.trigger("remove",{tag:e,index:s,data:a})}).filter(e=>e)},20)}return!0}switch(e.key){case"Backspace":"select"==s.mode&&s.enforceWhitelist&&this.value.length?this.removeTags():this.state.dropdown.visible&&"manual"!=s.dropdown.position||""!=e.target.textContent&&8203!=a.charCodeAt(0)||(!0===s.backspace?this.removeTags():"edit"==s.backspace&&setTimeout(this.editTag.bind(this),0));break;case"Esc":case"Escape":if(this.state.dropdown.visible)return;e.target.blur();break;case"Down":case"ArrowDown":this.state.dropdown.visible||this.dropdown.show();break;case"ArrowRight":{let e=this.state.inputSuggestion||this.state.ddItemData;if(e&&s.autoComplete.rightKey)return void this.addTags([e],!0);break}case"Tab":{let i="select"==s.mode;if(!a||i)return!0;e.preventDefault()}case"Enter":if(this.state.dropdown.visible&&"manual"!=s.dropdown.position)return;e.preventDefault(),setTimeout(()=>{this.state.dropdown.visible||this.state.actions.selectOption||this.addTags(a,!0)})}}},onInput(e){this.postUpdate();var s=this.settings;if("mix"==s.mode)return this.events.callbacks.onMixTagsInput.call(this,e);var a=this.input.normalize.call(this),i=a.length>=s.dropdown.enabled,r={value:a,inputElm:this.DOM.input},n=this.validateTag({value:a});"select"==s.mode&&this.toggleScopeValidation(n),r.isValid=n,this.state.inputText!=a&&(this.input.set.call(this,a,!1),-1!=a.search(s.delimiters)?this.addTags(a)&&this.input.set.call(this):s.dropdown.enabled>=0&&this.dropdown[i?"show":"hide"](a),this.trigger("input",r))},onMixTagsInput(e){var s,a,i,r,n,o,c,l,d=this.settings,h=this.value.length,u=this.getTagElms(),f=document.createDocumentFragment(),m=window.getSelection().getRangeAt(0),g=[].map.call(u,e=>b(e).value);if("deleteContentBackward"==e.inputType&&/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent)&&this.events.callbacks.onKeydown.call(this,{target:e.target,key:"Backspace"}),v(this.getTagElms()),this.value.slice().forEach(e=>{e.readonly&&!g.includes(e.value)&&f.appendChild(this.createTagElem(e))}),f.childNodes.length&&(m.insertNode(f),this.setRangeAtStartEnd(!1,f.lastChild)),u.length!=h)return this.value=[].map.call(this.getTagElms(),e=>b(e)),void this.update({withoutChangeEvent:!0});if(this.hasMaxTags())return!0;if(window.getSelection&&(o=window.getSelection()).rangeCount>0&&3==o.anchorNode.nodeType){if((m=o.getRangeAt(0).cloneRange()).collapse(!0),m.setStart(o.focusNode,0),i=(s=m.toString().slice(0,m.endOffset)).split(d.pattern).length-1,(a=s.match(d.pattern))&&(r=s.slice(s.lastIndexOf(a[a.length-1]))),r){if(this.state.actions.ArrowLeft=!1,this.state.tag={prefix:r.match(d.pattern)[0],value:r.replace(d.pattern,"")},this.state.tag.baseOffset=o.baseOffset-this.state.tag.value.length,l=this.state.tag.value.match(d.delimiters))return this.state.tag.value=this.state.tag.value.replace(d.delimiters,""),this.state.tag.delimiters=l[0],this.addTags(this.state.tag.value,d.dropdown.clearOnSelect),void this.dropdown.hide();n=this.state.tag.value.length>=d.dropdown.enabled;try{c=(c=this.state.flaggedTags[this.state.tag.baseOffset]).prefix==this.state.tag.prefix&&c.value[0]==this.state.tag.value[0],this.state.flaggedTags[this.state.tag.baseOffset]&&!this.state.tag.value&&delete this.state.flaggedTags[this.state.tag.baseOffset]}catch(e){}(c||i<this.state.mixMode.matchedPatternCount)&&(n=!1)}else this.state.flaggedTags={};this.state.mixMode.matchedPatternCount=i}setTimeout(()=>{this.update({withoutChangeEvent:!0}),this.trigger("input",p({},this.state.tag,{textContent:this.DOM.input.textContent})),this.state.tag&&this.dropdown[n?"show":"hide"](this.state.tag.value)},10)},onInputIE(e){var s=this;setTimeout(function(){s.events.callbacks.onInput.call(s,e)})},observeOriginalInputValue(){this.DOM.originalInput.parentNode||this.destroy(),this.DOM.originalInput.value!=this.DOM.originalInput.tagifyValue&&this.loadOriginalValues()},onClickAnywhere(e){e.target==this.DOM.scope||this.DOM.scope.contains(e.target)||(this.toggleFocusClass(!1),this.state.hasFocus=!1)},onClickScope(e){var s=this.settings,a=e.target.closest("."+s.classNames.tag),i=new Date-this.state.hasFocus;if(e.target!=this.DOM.scope){if(!e.target.classList.contains(s.classNames.tagX))return a?(this.trigger("click",{tag:a,index:this.getNodeIndex(a),data:b(a),event:e}),void(1!==s.editTags&&1!==s.editTags.clicks||this.events.callbacks.onDoubleClickScope.call(this,e))):void(e.target==this.DOM.input&&("mix"==s.mode&&this.fixFirefoxLastTagNoCaret(),i>500)?this.state.dropdown.visible?this.dropdown.hide():0===s.dropdown.enabled&&"mix"!=s.mode&&this.dropdown.show(this.value.length?"":void 0):"select"!=s.mode||0!==s.dropdown.enabled||this.state.dropdown.visible||this.dropdown.show());this.removeTags(e.target.parentNode)}else this.DOM.input.focus()},onPaste(e){e.preventDefault();var s,a,i=this.settings;if("select"==i.mode&&i.enforceWhitelist||!i.userInput)return!1;i.readonly||(a=(s=e.clipboardData||window.clipboardData).getData("Text"),i.hooks.beforePaste(e,{tagify:this,pastedText:a,clipboardData:s}).then(s=>{void 0===s&&(s=a),s&&(this.injectAtCaret(s,window.getSelection().getRangeAt(0)),"mix"==this.settings.mode?this.events.callbacks.onMixTagsInput.call(this,e):this.settings.pasteAsTags?this.addTags(this.state.inputText+s,!0):this.state.inputText=s)}).catch(e=>e))},onDrop(e){e.preventDefault()},onEditTagInput(e,s){var a=e.closest("."+this.settings.classNames.tag),i=this.getNodeIndex(a),r=b(a),n=this.input.normalize.call(this,e),o={[this.settings.tagTextProp]:n,__tagId:r.__tagId},c=this.validateTag(o);this.editTagChangeDetected(p(r,o))||!0!==e.originalIsValid||(c=!0),a.classList.toggle(this.settings.classNames.tagInvalid,!0!==c),r.__isValid=c,a.title=!0===c?r.title||r.value:c,n.length>=this.settings.dropdown.enabled&&(this.state.editing&&(this.state.editing.value=n),this.dropdown.show(n)),this.trigger("edit:input",{tag:a,index:i,data:p({},this.value[i],{newValue:n}),event:s})},onEditTagPaste(e,s){var a=(s.clipboardData||window.clipboardData).getData("Text");s.preventDefault();var i=g(a);this.setRangeAtStartEnd(!1,i)},onEditTagFocus(e){this.state.editing={scope:e,input:e.querySelector("[contenteditable]")}},onEditTagBlur(e){if(this.state.hasFocus||this.toggleFocusClass(),this.DOM.scope.contains(e)){var s,a,i=this.settings,r=e.closest("."+i.classNames.tag),n=b(r),o=this.input.normalize.call(this,e),c={[i.tagTextProp]:o,__tagId:n.__tagId},l=n.__originalData,d=this.editTagChangeDetected(p(n,c)),h=this.validateTag(c);if(o)if(d){if(s=this.hasMaxTags(),a=p({},l,{[i.tagTextProp]:this.trim(o),__isValid:h}),i.transformTag.call(this,a,l),!0!==(h=(!s||!0===l.__isValid)&&this.validateTag(a))){if(this.trigger("invalid",{data:a,tag:r,message:h}),i.editTags.keepInvalid)return;i.keepInvalidTags?a.__isValid=h:a=l}else i.keepInvalidTags&&(delete a.title,delete a["aria-invalid"],delete a.class);this.onEditTagDone(r,a)}else this.onEditTagDone(r,l);else this.onEditTagDone(r)}},onEditTagkeydown(e,s){if(!this.state.composing)switch(this.trigger("edit:keydown",{event:e}),e.key){case"Esc":case"Escape":s.parentNode.replaceChild(s.__tagifyTagData.__originalHTML,s),this.state.editing=!1;case"Enter":case"Tab":e.preventDefault(),e.target.blur()}},onDoubleClickScope(e){var s,a,i=e.target.closest("."+this.settings.classNames.tag),r=b(i),n=this.settings;i&&n.userInput&&!1!==r.editable&&(s=i.classList.contains(this.settings.classNames.tagEditing),a=i.hasAttribute("readonly"),"select"==n.mode||n.readonly||s||a||!this.settings.editTags||this.editTag(i),this.toggleFocusClass(!0),this.trigger("dblclick",{tag:i,index:this.getNodeIndex(i),data:b(i)}))},onInputDOMChange(e){e.forEach(e=>{e.addedNodes.forEach(e=>{if("<div><br></div>"==e.outerHTML)e.replaceWith(document.createElement("br"));else if(1==e.nodeType&&e.querySelector(this.settings.classNames.tagSelector)){let s=document.createTextNode("");3==e.childNodes[0].nodeType&&"BR"!=e.previousSibling.nodeName&&(s=document.createTextNode("\n")),e.replaceWith(s,...[...e.childNodes].slice(0,-1)),y(s)}else if(m.call(this,e))if(3!=e.previousSibling?.nodeType||e.previousSibling.textContent||e.previousSibling.remove(),e.previousSibling&&"BR"==e.previousSibling.nodeName){e.previousSibling.replaceWith("\n​");let s=e.nextSibling,a="";for(;s;)a+=s.textContent,s=s.nextSibling;a.trim()&&y(e.previousSibling)}else e.previousSibling&&!b(e.previousSibling)||e.before("​")}),e.removedNodes.forEach(e=>{e&&"BR"==e.nodeName&&m.call(this,s)&&(this.removeTags(s),this.fixFirefoxLastTagNoCaret())})});var s=this.DOM.input.lastChild;s&&""==s.nodeValue&&s.remove(),s&&"BR"==s.nodeName||this.DOM.input.appendChild(document.createElement("br"))}}},fixFirefoxLastTagNoCaret(){},setRangeAtStartEnd(e,s){if(s){e="number"==typeof e?e:!!e,s=s.lastChild||s;var a=document.getSelection();if(a.focusNode instanceof Element&&!this.DOM.input.contains(a.focusNode))return!0;try{a.rangeCount>=1&&["Start","End"].forEach(i=>a.getRangeAt(0)["set"+i](s,e||s.length))}catch(e){}}},insertAfterTag(e,s){if(s=s||this.settings.mixMode.insertAfterTag,e&&e.parentNode&&s)return s="string"==typeof s?document.createTextNode(s):s,e.parentNode.insertBefore(s,e.nextSibling),s},editTagChangeDetected(e){var s=e.__originalData;for(var a in s)if(!this.dataProps.includes(a)&&e[a]!=s[a])return!0;return!1},getTagTextNode(e){return e.querySelector(this.settings.classNames.tagTextSelector)},setTagTextNode(e,s){this.getTagTextNode(e).innerHTML=l(s)},editTag(e,s){e=e||this.getLastTag(),s=s||{},this.dropdown.hide();var a=this.settings,i=this.getTagTextNode(e),r=this.getNodeIndex(e),n=b(e),o=this.events.callbacks,c=this,l=!0;if(i){if(!(n instanceof Object&&"editable"in n)||n.editable)return n=b(e,{__originalData:p({},n),__originalHTML:e.cloneNode(!0)}),b(n.__originalHTML,n.__originalData),i.setAttribute("contenteditable",!0),e.classList.add(a.classNames.tagEditing),i.addEventListener("focus",o.onEditTagFocus.bind(this,e)),i.addEventListener("blur",function(){setTimeout(()=>o.onEditTagBlur.call(c,c.getTagTextNode(e)))}),i.addEventListener("input",o.onEditTagInput.bind(this,i)),i.addEventListener("paste",o.onEditTagPaste.bind(this,i)),i.addEventListener("keydown",s=>o.onEditTagkeydown.call(this,s,e)),i.addEventListener("compositionstart",o.onCompositionStart.bind(this)),i.addEventListener("compositionend",o.onCompositionEnd.bind(this)),s.skipValidation||(l=this.editTagToggleValidity(e)),i.originalIsValid=l,this.trigger("edit:start",{tag:e,index:r,data:n,isValid:l}),i.focus(),this.setRangeAtStartEnd(!1,i),this}else console.warn("Cannot find element in Tag template: .",a.classNames.tagTextSelector)},editTagToggleValidity(e,s){var a;if(s=s||b(e))return(a=!("__isValid"in s)||!0===s.__isValid)||this.removeTagsFromValue(e),this.update(),e.classList.toggle(this.settings.classNames.tagNotAllowed,!a),s.__isValid=a,s.__isValid;console.warn("tag has no data: ",e,s)},onEditTagDone(e,s){s=s||{};var a={tag:e=e||this.state.editing.scope,index:this.getNodeIndex(e),previousData:b(e),data:s};this.trigger("edit:beforeUpdate",a,{cloneData:!1}),this.state.editing=!1,delete s.__originalData,delete s.__originalHTML,e&&s[this.settings.tagTextProp]?(e=this.replaceTag(e,s),this.editTagToggleValidity(e,s),this.settings.a11y.focusableTags?e.focus():y(e)):e&&this.removeTags(e),this.trigger("edit:updated",a),this.dropdown.hide(),this.settings.keepInvalidTags&&this.reCheckInvalidTags()},replaceTag(e,s){s&&s.value||(s=e.__tagifyTagData),s.__isValid&&1!=s.__isValid&&p(s,this.getInvalidTagAttrs(s,s.__isValid));var a=this.createTagElem(s);return e.parentNode.replaceChild(a,e),this.updateValueByDOMTags(),a},updateValueByDOMTags(){this.value.length=0,[].forEach.call(this.getTagElms(),e=>{e.classList.contains(this.settings.classNames.tagNotAllowed.split(" ")[0])||this.value.push(b(e))}),this.update()},injectAtCaret(e,s){return(s=s||this.state.selection?.range)||!e?(g(e,s),this.setRangeAtStartEnd(!1,e),this.updateValueByDOMTags(),this.update()):this.appendMixTags(e),this},input:{set(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var a=this.settings.dropdown.closeOnSelect;this.state.inputText=e,s&&(this.DOM.input.innerHTML=l(""+e)),!e&&a&&this.dropdown.hide.bind(this),this.input.autocomplete.suggest.call(this),this.input.validate.call(this)},raw(){return this.DOM.input.textContent},validate(){var e=!this.state.inputText||!0===this.validateTag({value:this.state.inputText});return this.DOM.input.classList.toggle(this.settings.classNames.inputInvalid,!e),e},normalize(e){var s=e||this.DOM.input,a=[];s.childNodes.forEach(e=>3==e.nodeType&&a.push(e.nodeValue)),a=a.join("\n");try{a=a.replace(/(?:\r\n|\r|\n)/g,this.settings.delimiters.source.charAt(0))}catch(e){}return a=a.replace(/\s/g," "),this.trim(a)},autocomplete:{suggest(e){if(this.settings.autoComplete.enabled){"string"==typeof(e=e||{value:""})&&(e={value:e});var s=this.dropdown.getMappedValue(e);if("number"!=typeof s){var a=s.substr(0,this.state.inputText.length).toLowerCase(),i=s.substring(this.state.inputText.length);s&&this.state.inputText&&a==this.state.inputText.toLowerCase()?(this.DOM.input.setAttribute("data-suggest",i),this.state.inputSuggestion=e):(this.DOM.input.removeAttribute("data-suggest"),delete this.state.inputSuggestion)}}},set(e){var s=this.DOM.input.getAttribute("data-suggest"),a=e||(s?this.state.inputText+s:null);return!!a&&("mix"==this.settings.mode?this.replaceTextWithNode(document.createTextNode(this.state.tag.prefix+a)):(this.input.set.call(this,a),this.setRangeAtStartEnd(!1,this.DOM.input)),this.input.autocomplete.suggest.call(this),this.dropdown.hide(),!0)}}},getTagIdx(e){return this.value.findIndex(s=>s.__tagId==(e||{}).__tagId)},getNodeIndex(e){var s=0;if(e)for(;e=e.previousElementSibling;)s++;return s},getTagElms(){for(var e=arguments.length,s=Array(e),a=0;a<e;a++)s[a]=arguments[a];var i="."+[...this.settings.classNames.tag.split(" "),...s].join(".");return[].slice.call(this.DOM.scope.querySelectorAll(i))},getLastTag(){var e=this.DOM.scope.querySelectorAll(`${this.settings.classNames.tagSelector}:not(.${this.settings.classNames.tagHide}):not([readonly])`);return e[e.length-1]},isTagDuplicate(e,s,i){var r=0;if("select"==this.settings.mode)return!1;for(let n of this.value)a(this.trim(""+e),n.value,s)&&i!=n.__tagId&&r++;return r},getTagIndexByValue(e){var s=[],i=this.settings.dropdown.caseSensitive;return this.getTagElms().forEach((r,n)=>{r.__tagifyTagData&&a(this.trim(r.__tagifyTagData.value),e,i)&&s.push(n)}),s},getTagElmByValue(e){var s=this.getTagIndexByValue(e)[0];return this.getTagElms()[s]},flashTag(e){e&&(e.classList.add(this.settings.classNames.tagFlash),setTimeout(()=>{e.classList.remove(this.settings.classNames.tagFlash)},100))},isTagBlacklisted(e){return e=this.trim(e.toLowerCase()),this.settings.blacklist.filter(s=>(""+s).toLowerCase()==e).length},isTagWhitelisted(e){return!!this.getWhitelistItem(e)},getWhitelistItem(e,s,i){s=s||"value";var r,n=this.settings;return(i=i||n.whitelist).some(i=>{if(a("string"==typeof i?i:i[s]||i.value,e,n.dropdown.caseSensitive,n.trim))return r="string"==typeof i?{value:i}:i,!0}),r||"value"!=s||"value"==n.tagTextProp||(r=this.getWhitelistItem(e,n.tagTextProp,i)),r},validateTag(e){var s=this.settings,a="value"in e?"value":s.tagTextProp,i=this.trim(e[a]+"");return(e[a]+"").trim()?"mix"!=s.mode&&s.pattern&&s.pattern instanceof RegExp&&!s.pattern.test(i)?this.TEXTS.pattern:!s.duplicates&&this.isTagDuplicate(i,s.dropdown.caseSensitive,e.__tagId)?this.TEXTS.duplicate:this.isTagBlacklisted(i)||s.enforceWhitelist&&!this.isTagWhitelisted(i)?this.TEXTS.notAllowed:!s.validate||s.validate(e):this.TEXTS.empty},getInvalidTagAttrs(e,s){return{"aria-invalid":!0,class:`${e.class||""} ${this.settings.classNames.tagNotAllowed}`.trim(),title:s}},hasMaxTags(){return this.value.length>=this.settings.maxTags&&this.TEXTS.exceed},setReadonly(e,s){var a=this.settings;document.activeElement.blur(),a[s||"readonly"]=e,this.DOM.scope[(e?"set":"remove")+"Attribute"](s||"readonly",!0),this.settings.userInput=!0,this.setContentEditable(!e)},setContentEditable(e){this.settings.userInput&&(this.DOM.input.contentEditable=e,this.DOM.input.tabIndex=e?0:-1)},setDisabled(e){this.setReadonly(e,"disabled")},normalizeTags(e){var s=this.settings,a=s.whitelist,i=s.delimiters,r=s.mode,n=s.tagTextProp,o=[],c=!!a&&a[0]instanceof Object,l=Array.isArray(e),d=l&&e[0].value,p=e=>(e+"").split(i).filter(e=>e).map(e=>({[n]:this.trim(e),value:this.trim(e)}));if("number"==typeof e&&(e=e.toString()),"string"==typeof e){if(!e.trim())return[];e=p(e)}else l&&(e=[].concat(...e.map(e=>null!=e.value?e:p(e))));return c&&!d&&(e.forEach(e=>{var s=o.map(e=>e.value),a=this.dropdown.filterListItems.call(this,e[n],{exact:!0});this.settings.duplicates||(a=a.filter(e=>!s.includes(e.value)));var i=a.length>1?this.getWhitelistItem(e[n],n,a):a[0];i&&i instanceof Object?o.push(i):"mix"!=r&&(null==e.value&&(e.value=e[n]),o.push(e))}),o.length&&(e=o)),e},parseMixTags(e){var s=this.settings,a=s.mixTagsInterpolator,i=s.duplicates,r=s.transformTag,n=s.enforceWhitelist,o=s.maxTags,c=s.tagTextProp,l=[];e=e.split(a[0]).map((e,s)=>{var d,p,h,u=e.split(a[1]),f=u[0],m=l.length==o;try{if(f==+f)throw Error;p=JSON.parse(f)}catch(e){p=this.normalizeTags(f)[0]||{value:f}}if(r.call(this,p),m||!(u.length>1)||n&&!this.isTagWhitelisted(p.value)||!i&&this.isTagDuplicate(p.value)){if(e)return s?a[0]+e:e}else p[d=p[c]?c:"value"]=this.trim(p[d]),h=this.createTagElem(p),l.push(p),h.classList.add(this.settings.classNames.tagNoAnimation),u[0]=h.outerHTML,this.value.push(p);return u.join("")}).join(""),this.DOM.input.innerHTML=e,this.DOM.input.appendChild(document.createTextNode("")),this.DOM.input.normalize();var d=this.getTagElms();return d.forEach((e,s)=>b(e,l[s])),this.update({withoutChangeEvent:!0}),v(d,this.state.hasFocus),e},replaceTextWithNode(e,s){if(this.state.tag||s){s=s||this.state.tag.prefix+this.state.tag.value;var a,i,r=this.state.selection||window.getSelection(),n=r.anchorNode,o=this.state.tag.delimiters?this.state.tag.delimiters.length:0;return n.splitText(r.anchorOffset-o),-1==(a=n.nodeValue.lastIndexOf(s))||(i=n.splitText(a),e&&n.parentNode.replaceChild(e,i),!0)}},selectTag(e,s){var a=this.settings;if(!a.enforceWhitelist||this.isTagWhitelisted(s.value)){this.input.set.call(this,s[a.tagTextProp]||s.value,!0),this.state.actions.selectOption&&setTimeout(()=>this.setRangeAtStartEnd(!1,this.DOM.input));var i=this.getLastTag();return i?this.replaceTag(i,s):this.appendTag(e),this.value[0]=s,this.update(),this.trigger("add",{tag:e,data:s}),[e]}},addEmptyTag(e){var s=p({value:""},e||{}),a=this.createTagElem(s);b(a,s),this.appendTag(a),this.editTag(a,{skipValidation:!0})},addTags(e,s,a){var i=[],r=this.settings,n=[],o=document.createDocumentFragment();if(a=a||r.skipInvalid,!e||0==e.length)return i;switch(e=this.normalizeTags(e),r.mode){case"mix":return this.addMixTags(e);case"select":s=!1,this.removeAllTags()}return this.DOM.input.removeAttribute("style"),e.forEach(e=>{var s,c={},l=Object.assign({},e,{value:e.value+""});if(e=Object.assign({},l),r.transformTag.call(this,e),e.__isValid=this.hasMaxTags()||this.validateTag(e),!0!==e.__isValid){if(a)return;if(p(c,this.getInvalidTagAttrs(e,e.__isValid),{__preInvalidData:l}),e.__isValid==this.TEXTS.duplicate&&this.flashTag(this.getTagElmByValue(e.value)),!r.createInvalidTags)return void n.push(e.value)}if("readonly"in e&&(e.readonly?c["aria-readonly"]=!0:delete e.readonly),s=this.createTagElem(e,c),i.push(s),"select"==r.mode)return this.selectTag(s,e);o.appendChild(s),e.__isValid&&!0===e.__isValid?(this.value.push(e),this.trigger("add",{tag:s,index:this.value.length-1,data:e})):(this.trigger("invalid",{data:e,index:this.value.length,tag:s,message:e.__isValid}),r.keepInvalidTags||setTimeout(()=>this.removeTags(s,!0),1e3)),this.dropdown.position()}),this.appendTag(o),this.update(),e.length&&s&&(this.input.set.call(this,r.createInvalidTags?"":n.join(r._delimiters)),this.setRangeAtStartEnd(!1,this.DOM.input)),r.dropdown.enabled&&this.dropdown.refilter(),i},addMixTags(e){if((e=this.normalizeTags(e))[0].prefix||this.state.tag)return this.prefixedTextToTag(e[0]);var s=document.createDocumentFragment();return e.forEach(e=>{var a=this.createTagElem(e);s.appendChild(a)}),this.appendMixTags(s),s},appendMixTags(e){var s=!!this.state.selection;s?this.injectAtCaret(e):(this.DOM.input.focus(),(s=this.setStateSelection()).range.setStart(this.DOM.input,s.range.endOffset),s.range.setEnd(this.DOM.input,s.range.endOffset),this.DOM.input.appendChild(e),this.updateValueByDOMTags(),this.update())},prefixedTextToTag(e){var s,a=this.settings,i=this.state.tag.delimiters;return a.transformTag.call(this,e),e.prefix=e.prefix||this.state.tag?this.state.tag.prefix:(a.pattern.source||a.pattern)[0],s=this.createTagElem(e),this.replaceTextWithNode(s)||this.DOM.input.appendChild(s),setTimeout(()=>s.classList.add(this.settings.classNames.tagNoAnimation),300),this.value.push(e),this.update(),i||setTimeout(y,0,this.insertAfterTag(s)||s),this.state.tag=null,this.trigger("add",p({},{tag:s},{data:e})),s},appendTag(e){var s=this.DOM,a=s.input;s.scope.insertBefore(e,a)},createTagElem(e,a){e.__tagId=f();var i,r=p({},e,s({value:l(e.value+"")},a));return function(e){for(var s,a=document.createNodeIterator(e,NodeFilter.SHOW_TEXT,null,!1);s=a.nextNode();)s.textContent.trim()||s.parentNode.removeChild(s)}(i=this.parseTemplate("tag",[r,this])),b(i,e),i},reCheckInvalidTags(){var e=this.settings;this.getTagElms(e.classNames.tagNotAllowed).forEach((s,a)=>{var i=b(s),r=this.hasMaxTags(),n=this.validateTag(i),o=!0===n&&!r;if("select"==e.mode&&this.toggleScopeValidation(n),o)return i=i.__preInvalidData?i.__preInvalidData:{value:i.value},this.replaceTag(s,i);s.title=r||n})},removeTags(e,s,a){var i,r=this.settings;if(i=(e=e&&e instanceof HTMLElement?[e]:e instanceof Array?e:e?[e]:[this.getLastTag()]).reduce((e,s)=>{s&&"string"==typeof s&&(s=this.getTagElmByValue(s));var a=b(s);return s&&a&&!a.readonly&&e.push({node:s,idx:this.getTagIdx(a),data:b(s,{__removed:!0})}),e},[]),a="number"==typeof a?a:this.CSSVars.tagHideTransition,"select"==r.mode&&(a=0,this.input.set.call(this)),1==i.length&&"select"!=r.mode&&i[0].node.classList.contains(r.classNames.tagNotAllowed)&&(s=!0),i.length)return r.hooks.beforeRemoveTag(i,{tagify:this}).then(()=>{function e(e){e.node.parentNode&&(e.node.parentNode.removeChild(e.node),s?r.keepInvalidTags&&this.trigger("remove",{tag:e.node,index:e.idx}):(this.trigger("remove",{tag:e.node,index:e.idx,data:e.data}),this.dropdown.refilter(),this.dropdown.position(),this.DOM.input.normalize(),r.keepInvalidTags&&this.reCheckInvalidTags()))}a&&a>10&&1==i.length?(function(s){s.node.style.width=parseFloat(window.getComputedStyle(s.node).width)+"px",document.body.clientTop,s.node.classList.add(r.classNames.tagHide),setTimeout(e.bind(this),a,s)}).call(this,i[0]):i.forEach(e.bind(this)),s||(this.removeTagsFromValue(i.map(e=>e.node)),this.update(),"select"==r.mode&&this.setContentEditable(!0))}).catch(e=>{})},removeTagsFromDOM(){[].slice.call(this.getTagElms()).forEach(e=>e.parentNode.removeChild(e))},removeTagsFromValue(e){(e=Array.isArray(e)?e:[e]).forEach(e=>{var s=b(e),a=this.getTagIdx(s);a>-1&&this.value.splice(a,1)})},removeAllTags(e){e=e||{},this.value=[],"mix"==this.settings.mode?this.DOM.input.innerHTML="":this.removeTagsFromDOM(),this.dropdown.refilter(),this.dropdown.position(),this.state.dropdown.visible&&setTimeout(()=>{this.DOM.input.focus()}),"select"==this.settings.mode&&(this.input.set.call(this),this.setContentEditable(!0)),this.update(e)},postUpdate(){this.state.blockChangeEvent=!1;var e=this.settings,s=e.classNames,a="mix"==e.mode?e.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value.trim():this.value.length+this.input.raw.call(this).length;this.toggleClass(s.hasMaxTags,this.value.length>=e.maxTags),this.toggleClass(s.hasNoTags,!this.value.length),this.toggleClass(s.empty,!a),"select"==e.mode&&this.toggleScopeValidation(this.value?.[0]?.__isValid)},setOriginalInputValue(e){var s=this.DOM.originalInput;this.settings.mixMode.integrated||(s.value=e,s.tagifyValue=s.value,this.setPersistedData(e,"value"))},update(e){clearTimeout(this.debouncedUpdateTimeout),this.debouncedUpdateTimeout=setTimeout((function(){var s=this.getInputValue();this.setOriginalInputValue(s),this.settings.onChangeAfterBlur&&(e||{}).withoutChangeEvent||this.state.blockChangeEvent||this.triggerChangeEvent(),this.postUpdate()}).bind(this),100)},getInputValue(){var e=this.getCleanValue();return"mix"==this.settings.mode?this.getMixedTagsAsString(e):e.length?this.settings.originalInputValueFormat?this.settings.originalInputValueFormat(e):JSON.stringify(e):""},getCleanValue(e){return i(e||this.value,this.dataProps)},getMixedTagsAsString(){var e="",s=this,a=this.settings,i=a.originalInputValueFormat||JSON.stringify,n=a.mixTagsInterpolator;return function a(o){o.childNodes.forEach(o=>{if(1==o.nodeType){let c=b(o);if("BR"==o.tagName&&(e+="\r\n"),c&&m.call(s,o)){if(c.__removed)return;e+=n[0]+i(r(c,s.dataProps))+n[1]}else o.getAttribute("style")||["B","I","U"].includes(o.tagName)?e+=o.textContent:"DIV"!=o.tagName&&"P"!=o.tagName||(e+="\r\n",a(o))}else e+=o.textContent})}(this.DOM.input),e}},D.prototype.removeTag=D.prototype.removeTags,D}();class $22cc8bc5a51ebc2b$export$b5c87c9f30e8974e{_name=null;_description=null;boons=0;banes=0;modifier=0;divide=0;percent=0;stress_boons=0;static GRAY="--tag-bg:#a1a1a1;--tag-text-color:#2b2a2a;--tag-hover:#bababa;--tag-remove-bg:#a1a1a1;--tag-remove-btn-color:#2b2a2a";static RED="--tag-bg:#d19d9d;--tag-text-color:#530d0d;--tag-hover:#e1b4b4;--tag-remove-bg:#d19d9d;--tag-remove-btn-color:#530d0d";static GREEN="--tag-bg:#9dd1ab;--tag-text-color:#224939;--tag-hover:#b5e0c1;--tag-remove-bg:#9dd1ab;--tag-remove-btn-color:#224939";static ORANGE="--tag-bg:#e6d7aa;--tag-text-color:#493c22;--tag-hover:#e0cfb5;--tag-remove-bg:#d1c69d;--tag-remove-btn-color:#493822";constructor({name:e=null,description:s=null,boons:a=0,banes:i=0,modifier:r=0,divide:n=0,percent:o=0,stress_boons:c=0}){this._name=e,this._description=s,this.boons=parseInt(a)||0,this.banes=parseInt(i)||0,this.modifier=parseInt(r)||0,this.divide=parseInt(n)||0,this.percent=parseInt(o)||0,this.stress_boons=parseInt(c)||0}get name(){return this._name?`${this._name} ${this.mod_str()}`:this.mod_str()}get description(){return this._description||this._name}mod_str(){let e="⊕".repeat(this.boons)+"⊖".repeat(this.banes),s=this.modifier>=0?`+${this.modifier}`:`${this.modifier}`;return e?this.modifier?e+s:e:s}tag(){return{value:this.name,title:this.description,style:$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.color(this.name)}}json(){return{boons:this.boons,banes:this.banes,modifier:this.modifier,divide:this.divide,percent:this.percent,stress_boons:this.stress_boons,name:this.name,description:this.description}}static parse(e){let s=[];try{return e.forEach(e=>{let a=new URLSearchParams(e);s.push(new $22cc8bc5a51ebc2b$export$b5c87c9f30e8974e({name:a.get("name"),description:a.get("description"),boons:a.get("boons"),banes:a.get("banes"),modifier:a.get("modifier"),divide:a.get("divide"),percent:a.get("percent"),stress_boons:a.get("stress_boons")}))}),s}catch(s){return console.error(`Error parsing modifiers object: ${e}`),[]}}static color(e){let s=$ef2b9a9b8ae02095$export$33dec5772ae42010("stress",!1),a=e.includes("+")||e.includes("⊕"),i=e.includes("-")||e.includes("⊖"),r=e.toLowerCase().startsWith("stress");return a&&i?$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.GRAY:s&&r&&a?$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.ORANGE:a?$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.GREEN:i?$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.RED:$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.GRAY}static total_modifiers(e){let s=0,a=0,i=0,r=1,n=0,o=0,c=[];return e.forEach(e=>{s+=e.boons||0,a+=e.banes||0,i+=e.modifier||0,r*=e.divide||0,n+=e.percent||0,o+=e.stress_boons||0,e.name&&c.push(e.name)}),{boons:s,banes:a,modifier:i,divide:r,percent:n,stress_boons:o,tags:c}}static list_from_string(e){let s=null;try{e&&(s=JSON.parse(e))}catch(e){console.error("Error parsing list from tagify")}return s?(Array.isArray(s)||(s=[s]),s.map(e=>$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.from_tag(e))):[]}static from_tag(e){let s="string"==typeof e||e instanceof String?e:e.value;if(!s)return{};let a=s.replace(/([a-zA-Z0-9])([+-])/g,"$1 $2").split(" "),i=a.pop(),r=a.join(" "),n=parseInt(i.replace(/^\D+/,""))||null,o=i.replace(/[0-9]/g,"");null!==n&&"-"===o.at(-1)&&(n*=-1),null!==n&&(o=o.slice(0,-1));let c=(o.match(/[+⊕]/g)||[]).length,l=(o.match(/[-⊖]/g)||[]).length,d=r.toLowerCase().startsWith("stress")&&(o.match(/[+⊕]/g)||[]).length;return new $22cc8bc5a51ebc2b$export$b5c87c9f30e8974e({name:r.replace(/[⊕⊖]/g,""),boons:c,banes:l,modifier:n||0,stress_boons:d})}}Hooks.once("init",async()=>{Handlebars.registerHelper("skillSelect",(e,s)=>{let a=RegExp.escape(Handlebars.escapeExpression(e)),i=RegExp(` value=["']${a}["']`);return s.fn(void 0).replace(i,"$& selected")})});const $71c9a09ec3eab7ed$export$3b84a4f667a9b873={"":"--",strength:"Strength",dexterity:"Dexterity",speed:"Speed",endurance:"Endurance",intelligence:"Intelligence",perception:"Perception",charisma:"Charisma",determination:"Determination"},$71c9a09ec3eab7ed$export$31ebfa08917fa7c5={"":"--",defense:"Defense",willpower:"Willpower"},$71c9a09ec3eab7ed$export$79a86e154bc9aabc={"":"--",defense:"Defense",crew:"Crew"};class $71c9a09ec3eab7ed$export$1b16fc9eb974a84d{_actor=null;_label=null;target=null;target_score=null;critical=!1;evaluated=!1;margin=null;pairs=null;results=null;skill_value=0;stat_value=0;success=!1;randomizer=null;total=null;use_pair=!1;stressed=0;panic=!1;constructor(e){Object.assign(this,e),this.validate()}validate(){if(!((this.sceneId&&this.tokenId||this.actorId||this.actor)&&this.actor&&this.actor.system&&(this.actor.system?.stats&&this.actor.system?.stats[this.stat]||this.actor.system?.scores&&this.actor.system?.scores[this.stat]||!this.stat)))throw`Test missing required data: scene=${this.sceneId}, token=${this.tokenId}, actor=${this.actorId}, stat=${this.stat}`;if(this.tn&&!isNaN(this.tn)&&(this.tn=Number(this.tn)),this.boons&&!isNaN(this.boons)?this.boons=Number(this.boons):this.boons=0,this.banes&&!isNaN(this.banes)?this.banes=Number(this.banes):this.banes=0,this.modifier&&!isNaN(this.modifier)?this.modifier=Number(this.modifier):this.modifier=0,this.stress_boons&&!isNaN(this.stress_boons)?this.stress_boons=Number(this.stress_boons):this.stress_boons=0,this.effects){if(Array.isArray(this.effects)&&this.effects.every(e=>e instanceof $a92622f457efc12a$export$a32b0b1c1ac59d04))return;let e=null;Array.isArray(e="string"==typeof this.effects?JSON.parse(this.effects):this.effects)||(e=[e]);for(let s=0;s<e.length;s++)e[s]=new $a92622f457efc12a$export$a32b0b1c1ac59d04(e[s],this);this.effects=e}}set actor(e){this._actor=e}get actor(){if(this._actor)return this._actor;if(this.sceneId&&this.tokenId){let e=game.scenes.get(sceneId);if(!e)return null;let s=e.items.get(tokenId);if(!s)return null;let a=new Token(s);return this._actor=a.actor,this._actor}return this._actor=game.actors.get(this.actorId)||null,this._actor}get label(){return this._label||(this._label=$ef2b9a9b8ae02095$export$44f4605f44e8fbf2(this.stat,this.skill,this.tn)),this._label}roll_syntax(){let e=this.boons-this.banes;return 0===e?"1d10":e>0?`${e+1}d10kh1`:`${-1*e+1}d10kl1`}make_pairs(){if(this.banes>=this.boons)return[null,!1];let e=[],s=0;for(let a of this.results.dice[0].results)e.includes(a.result)&&a.result>s&&(s=a.result),e.push(a.result);let a=2*s>this.results.total;if(2*s>this.results.total){this.results._total=2*s;let e=0;for(let a of this.results.dice[0].results)a.result===s&&e<2?(a.discarded=!1,e++):a.discarded=!0}return[s,a]}lookup_skill(){let e=this.skill.match(/\(([^\)]+)\)/);e&&(e=e[e.length-1]);let s=e?this.skill.split(" ")[0]:this.skill,a=[];return(e?(e=e.replace(/[()]/g,""),a=this.actor.items.filter(a=>"skill"===a.type&&a.name===s&&a.system.specialization===e)):a=this.actor.items.filter(e=>"skill"===e.type&&e.name===s),a.length||(a=this.actor.items.filter(e=>"skill"===e.type&&e.name===this.skill)),a.length)?Number(a[0].system.rank):0}calc_total(){let e=this.stat?this.stat in(this.actor.system?.stats||[])?this.actor.system?.stats[this.stat].value:this.actor.system?.scores[this.stat].value:0,s=!!this.skill,a=s&&"Unskilled"!==this.skill?this.lookup_skill():0;s&&!a&&(e=Math.floor(e/2));let i=this.pairs&&2*this.pairs>this.results.total?2*this.pairs:this.results.total;return[i+e+a+this.modifier,i,e,a]}check_stress(){if(!$ef2b9a9b8ae02095$export$33dec5772ae42010("stress",!1))return[0,!1];{let e=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.stress(this.actor)||0,s=this.stress_boons?this.results.dice[0].results.slice(-1*this.stress_boons):[],a=!1;for(let i of s)i.result<=e&&(a=!0);return[e,a]}}lookup_tn(){if("string"!=typeof this.tn)return[this.tn,null,null];let e="defense"===this.tn.toLowerCase(),s="willpower"===this.tn.toLowerCase();if(!e&&!s)return!1;let a=game?.user?.targets?.values()?.next()?.value?.actor,i=a?.system?.scores;return i?[e?i.defense.tn:i.willpower.tn,a,this.tn]:[null,null,null]}double_ones(){let e=0;for(let s of this.results.dice[0].results)1===s.result&&e++;return e>=2}calc_margin(){if(!this.tn)return[null,null,null];let e=Math.abs(this.total-this.tn),s=this.total>=this.tn,a=e>=this.tn||this.total<this.tn/2;return this.banes>this.boons&&this.double_ones()&&(s&&(s=!1,e=0),a=!0),[s,a,e]}async evaluate(){let e=new Roll(this.roll_syntax());return this.results=await e.evaluate(),[this.pairs,this.use_pair]=this.make_pairs(),[this.total,this.randomizer,this.stat_value,this.skill_value]=this.calc_total(),[this.stressed,this.panic]=this.check_stress(),[this.tn,this.target,this.target_score]=this.lookup_tn(),[this.success,this.critical,this.margin]=this.calc_margin(),this.evaluated=!0,this}async apply_effects(e){this.effects||(this.effects=[]);let s=e?.properties||this.properties||[];if(!this.effects_evaluated){if($53b5035feb70b083$export$4b017698e4946e33.has_property(s,"Auto")){let e=this.basic_attack_damage()||{value:0,damage_type:"sm"};for(let a=this.margin-5;a>0;a-=5)this.effects.push(new $a92622f457efc12a$export$a32b0b1c1ac59d04({type:"damage",value:e.value,damage_type:e.damage_type,margin:a,when:"success",target:"target",properties:s},this));this.effects.push(new $a92622f457efc12a$export$a32b0b1c1ac59d04({type:"message",key:"Ammo",value:`Automatic fire consumes ${$53b5035feb70b083$export$4b017698e4946e33.property_value(s,"Auto")} shots.`},this))}$53b5035feb70b083$export$4b017698e4946e33.has_property(s,"Stun")&&this.effects.push(new $a92622f457efc12a$export$a32b0b1c1ac59d04({type:"consequence",name:"Stunned",when:"success",target:"target"},this));let e=["defense","damage","consequence","message"];this.effects.sort((s,a)=>e.indexOf(s.type)>e.indexOf(a.type)?1:e.indexOf(s.type)<e.indexOf(a.type)?-1:e.indexOf(s.type)===e.indexOf(a.type)?0:void 0),this.effects_evaluated=!0}let a=this.success?"success":this.tn?"failure":"always";for(let s of this.effects)s.apply(a,e)}basic_attack_damage(){let e=this.effects.filter(e=>"damage"===e.type);return e.length?e[0]:null}flavor(){let e=this.target?`<div><strong>Target:</strong> ${this.target.name} (${$ef2b9a9b8ae02095$export$9a00dee1beb8f576(this.target_score)} ${this.tn})</div>`:"",s=(this.critical?"Critical ":"")+(this.target_score?this.success?"Hit!":"Miss!":this.success?"Success!":"Failure!"),a=(this.critical?"critical ":"")+(this.success?"success":"failure"),i=this.tn?`<div><strong>Result:</strong> <span class="${a}">${s}</span> Margin ${this.margin}</div>`:"",r="";if(this.panic&&(r+='<div><strong>Panic:</strong> <span class="panic">Make a Panic test!</span></div>'),this.effects)for(let e of this.effects)r+=e.message;let n=$ef2b9a9b8ae02095$export$33dec5772ae42010("luck_label","Luck"),o="";return this.stat&&(o+=`<span class="tag">${$ef2b9a9b8ae02095$export$9a00dee1beb8f576(this.stat)} +${this.stat_value}</span>`),this.skill&&"Unskilled"!==this.skill&&(o+=`<span class="tag">${this.skill} +${this.skill_value}</span>`),this.skill&&0===this.skill_value&&(o+='<span class="tag">Unskilled</span>'),this.tags&&this.tags.length&&this.tags.forEach(e=>o+=`<span class="tag">${e}</span>`),this.use_pair&&(o+='<span class="tag">Pairs!</span>'),this.use_luck&&(o+=`<span class="tag">${n}</span>`),this.edited&&(o+='<span class="tag">Edited</span>'),`<h4 class="action">${this.label}</h4>
                ${e} 
                ${i} 
                ${r}
                <hr />
                <div class="tags">${o}</div>`}dice_html(){let e=$ef2b9a9b8ae02095$export$33dec5772ae42010("stress",!1),s='<ol class="dice-rolls">';for(let a=0;a<this.results.dice[0].results.length;a++){let i=this.results.dice[0].results[a],r=i.discarded?"discarded":"",n=e&&a>=this.results.dice[0].results.length-this.stress_boons?"stress":"";e&&i.result<=this.stressed&&(n+=" panic"),s+=`<li class="roll die d10 ${r} ${n}">${i.result}</li>`}return s+"</ol>"}content(){let e=this.stat_value?`+ <span title="Stat">${this.stat_value}</span>`:"",s=this.skill_value?`+ <span title="Skill">${this.skill_value}</span>`:"",a=this.modifier?`+ <span title="Modifier">${this.modifier}</span>`:"",i=JSON.stringify($71c9a09ec3eab7ed$export$1b16fc9eb974a84d.to_json(this));return`
            <div class="dice-roll">
                <div class="dice-result">
                    <div class="dice-formula">
                        ${this.results.formula} ${s} ${e} ${a}
                    </div>
                    <div class="dice-tooltip">
                        <section class="tooltip-part">
                            <div class="dice">
                                <header class="part-header flexrow">
                                    <span class="part-formula">${this.results.formula}</span>
                                    <span class="part-total">${this.results.total}</span>
                                </header>
                                ${this.dice_html()}
                            </div>
                        </section>
                    </div>
                    <h4 class="dice-total">${this.total}</h4>
                </div>
            </div>
            <input type="hidden" class="test-json" value='${i}' />`}async to_chat({whisper:e=!1,rolls:s=null}){s&&(Array.isArray(s)||(s=[s]),s=s.map(e=>JSON.stringify(e.toJSON()))),await ChatMessage.create({content:this.content(),flavor:this.flavor(),rolls:s||(e?[]:[this.results]),speaker:ChatMessage.getSpeaker({actor:this.actor}),whisper:e?game.users.filter(e=>e.isGM||e.character?.id===this.actor?.id).map(e=>e.id):[]})}static to_json(e){let s={};for(let[a,i]of Object.entries(e))if("string"==typeof i||"number"==typeof i||"boolean"==typeof i||null===i)s[a]=i;else if("_actor"===a||"target"===a)s[a]={uuid:i.uuid};else if("effects"===a){let i=[];for(let s of e.effects)i.push($a92622f457efc12a$export$a32b0b1c1ac59d04.to_json(s));s[a]=i}else"results"===a&&(s[a]={_evaluated:i._evaluated,_formula:i._formula,_total:i._total,_terms:i.terms[0].results});return s}static from_json(e){let s={};for(let[a,i]of Object.entries(e))"string"==typeof i||"number"==typeof i||"boolean"==typeof i||null===i?s[a]=e[a]:"_actor"===a||"target"===a?i instanceof game.sagamachine.SagaMachineActor?s[a]=i:s[a]=$ef2b9a9b8ae02095$export$99454b2c58b3846f(i):"effects"===a?s[a]=i:"results"===a&&(s[a]=new Roll(i._formula),s[a]._evaluated=i._evaluated,s[a]._formula=i._formula,s[a]._total=i._total,s[a].terms=[new foundry.dice.terms.Die({faces:10})],s[a].terms[0].results=i._terms);return new $71c9a09ec3eab7ed$export$1b16fc9eb974a84d(s)}}async function $71c9a09ec3eab7ed$export$5803ef6f71bdd50f(e,s=null){let a=$ef2b9a9b8ae02095$export$99454b2c58b3846f(e),i="vehicle"===a.type?$71c9a09ec3eab7ed$export$79a86e154bc9aabc:$71c9a09ec3eab7ed$export$31ebfa08917fa7c5;new Dialog({title:"Make Test",content:await renderTemplate(`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/apps/test-dialog.html`,{actor:{...a.sheet.getData().data},STAT_OPTIONS:$71c9a09ec3eab7ed$export$3b84a4f667a9b873,SCORE_OPTIONS:i,...e}),render:s=>{let i=a.modifiers(e),r=s.find("input[name=modifiers]");if(!r)return;let n=new($parcel$interopDefault($3311d4ef469e3627$exports))(r[0],{duplicates:!0,transformTag:e=>{e.style=$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.color(e.value),isNaN(parseInt(e.value.split(" ").at(-1)))&&(e.value=e.value.replaceAll("+","⊕").replaceAll("-","⊖"))}}),o=foundry.utils.deepClone(n.value),c=i.map(e=>e.tag());n.addTags(c);let l=s.find("input[name=properties]");new($parcel$interopDefault($3311d4ef469e3627$exports))(l[0],{duplicates:!0,transformTag:e=>{e.style=$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.GRAY}}),s.find("select[name=stat], select[name=score], select[name=skill], input[name=tn], input[name=properties]").on("change",i=>{let r=JSON.parse(JSON.stringify(e));r.stat=s.find("select[name=stat]").val(),r.score=s.find("select[name=score]").val(),r.skill=s.find("select[name=skill]").val(),r.tn=s.find("input[name=tn]").val(),r.properties=JSON.parse(s.find("input[name=properties]").val()||"[]").map(e=>e.value).join(",");let c=a.modifiers(r);n.removeAllTags(),n.addTags(o),n.addTags(c.map(e=>e.tag()))})},buttons:{roll:{label:"Make Test",callback:async i=>{i.find("select[name=stat] > option:selected").trigger("focus"),setTimeout(async()=>{let r=i.find("select[name=stat] > option:selected").val(),n=i.find("select[name=score] > option:selected").val(),o=i.find("select[name=skill] > option:selected").val(),{boons:c,banes:l,modifier:d,tags:p,stress_boons:h}=$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.total_modifiers($22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.list_from_string(i.find("input[name=modifiers]").val())),u=new $71c9a09ec3eab7ed$export$1b16fc9eb974a84d({actor:a,stat:r||n,skill:o||null,boons:c||0,banes:l||0,modifier:d||0,stress_boons:h||0,tags:p,tn:i.find("input[name=tn]").val()||null,effects:i.find("input[name=effects]").val()||null});await u.evaluate(),await u.apply_effects(e);let f=!!e.whisper;await u.to_chat({whisper:f}),s&&await s(u)},200)},icon:'<i class="fas fa-check"></i>'}},default:"roll"}).render({force:!0,width:450})}const $b3d0fcc9cab9bd05$export$7065c91b0a27b3b9=()=>{let e=[],s=["Bleeding","Bolstered","Dazed","Defeated","Desire","Disabled","Dying","Fatigue","Fear","Fixation","Grave Wound","Hidden","Hindered","Prone","Stunned","Wound"];return $ef2b9a9b8ae02095$export$33dec5772ae42010("stress",!1)&&s.splice(14,0,"Stressed"),s.forEach(s=>e.push({icon:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/consequences/${s.slugify()}.svg`,statuses:[s.slugify()],name:s,id:s.slugify(),flags:{core:{overlay:["Defeated"].includes(s)},system:{subject_prompt:["Bleeding","Desire","Fear","Fixation"].includes(s),value_prompt:["Fatigue","Grave Wound","Wound"].includes(s),remove_others:["Desire","Fixation"].includes(s),no_consequence:["Defeated","Unconscious"].includes(s)}}})),e};async function $b3d0fcc9cab9bd05$export$ce53e9a4e8384701({name:e,actor:s,skip_actor:a=!1,skip_global:i=!1,skip_new:r=!1}){let n=null;return a||(n=s?.items.filter(s=>s.name===e&&"consequence"===s.type).values().next()?.value),i||n||(n=game.items.filter(s=>s.name===e&&"consequence"===s.type).values().next()?.value),r||n||(n=await Item.create({name:e.capitalize(),type:"consequence",system:{rank:1}})),n}async function $b3d0fcc9cab9bd05$export$bce7246a7036e38(e){let s=new Set(e.items.filter(e=>"consequence"===e.type&&e.system.rank>0&&game.sagamachine.standard_consequences.includes(e.name)).map(e=>e.name.slugify())),a=e.statuses,i=s.difference(a),r=a.difference(s);r.delete("defeated"),r.delete("unconscious");let n=[];CONFIG.statusEffects.forEach(e=>{i.has(e.id)&&n.push(foundry.utils.deepClone(e))}),n.length&&await e.createEmbeddedDocuments("ActiveEffect",n),r.size&&await e.deleteEmbeddedDocuments("ActiveEffect",e.effects.filter(e=>r.has(e.name.slugify())).map(e=>e.id));let o=new Set(e.effects.map(e=>e.name));if(o.size!==e.effects.size)for(let s of o){if(!game.sagamachine.standard_consequences.includes(s))return;let a=e.effects.filter(e=>e.name===s);a.length>1&&(a.shift(),await e.deleteEmbeddedDocuments("ActiveEffect",a.map(e=>e.id)))}}async function $b3d0fcc9cab9bd05$export$40b3570d78570c16(e,s=!1){for(let s of e.parent.effects.filter(s=>s.origin===e.uuid))s.delete();if(s)return;let a=[];for(let s of e.effects)a.push(s.clone({parent:e.parent,origin:e.uuid}));e.parent.createEmbeddedDocuments("ActiveEffect",a)}function $b3d0fcc9cab9bd05$export$b65e028fee10b7bb(e,s){let a=e=>Function(`'use strict'; return (${e})`)(),i=new URLSearchParams(e.replaceAll("+","%2b"));for(let e of["boons","banes","modifier","divide","percent"]){var r;i.has(e)&&i.set(e,a((r=i.get(e),r=r.replaceAll("@rank",s.system.rank),s.parent&&(r=r.replaceAll("@str",s.parent.system.stats.strength.value).replaceAll("@dex",s.parent.system.stats.dexterity.value).replaceAll("@spd",s.parent.system.stats.speed.value).replaceAll("@end",s.parent.system.stats.endurance.value).replaceAll("@int",s.parent.system.stats.intelligence.value).replaceAll("@per",s.parent.system.stats.perception.value).replaceAll("@chr",s.parent.system.stats.charisma.value).replaceAll("@det",s.parent.system.stats.determination.value)),r)))}return i.toString()}async function $b3d0fcc9cab9bd05$export$7801755dddf1fd51(e){let s=await fromUuid(e.origin);if(!s)return!0;for(let a of e.changes)a.value=$b3d0fcc9cab9bd05$export$b65e028fee10b7bb(a.value,s);return await e.updateSource({changes:e.changes}),!0}async function $b3d0fcc9cab9bd05$export$31930d543788113d(e){let s=e.target,a=e.statuses.first();if(e?.flags?.system?.no_consequence)return;let i=s.items.filter(e=>e.name.slugify()===a&&"consequence"===e.type).values().next()?.value;i||((i=game.items.filter(s=>s.name===e.name&&"consequence"===s.type).values().next()?.value)||(i=await Item.create({name:a.capitalize(),type:"consequence",system:{rank:1}})),e?.flags?.system?.subject_prompt&&new Dialog({title:`Specify Subject of ${i.name}`,content:`
                    <form>
                        <div class="form-group">
                            <label for="subject">Subject</label>
                            <input type="text" name="subject" value="" autofocus>
                        </div>
                    </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async a=>{let r=a.find("[name=subject]").val().trim();i.update({"system.specialization":r,"system.rank":1}),i.system.specialization=r,e?.flags?.system?.remove_others&&s.items.filter(e=>e.name===i.name&&"consequence"===e.type&&e.system.specialization!==r).forEach(e=>e.delete())}}},default:"Confirm"}).render({force:!0}),e?.flags?.system?.value_prompt&&new Dialog({title:`Specify Descriptor and Value of ${i.name}`,content:`
                    <form>
                        <div class="grid grid-2col">
                            <label for="subject">Descriptor (optional)</label>
                            <input type="text" name="subject" value="" autofocus>
                            <label for="value">Value</label>
                            <input type="number" name="value" value="1">
                        </div>
                    </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async e=>{let s=e.find("[name=subject]").val().trim(),a=parseInt(e.find("[name=value]").val())||1;i.update({"system.specialization":s,"system.rank":a})}}},default:"Confirm"}).render({force:!0}),[i]=await s.createEmbeddedDocuments("Item",[i]))}async function $b3d0fcc9cab9bd05$export$efd50a08c6cb878d(e){let s=e.target,a=s.items.filter(s=>s.name===e.name&&"consequence"===s.type);a.length&&await s.deleteEmbeddedDocuments("Item",a.map(e=>e.id))}function $b3d0fcc9cab9bd05$export$df951736c406196b(e){let s=e.target,a=s.items.filter(s=>s.name===e.name&&"consequence"===s.type);if(!a.length)return!0;if(a.length>1||e?.flags?.system?.value_prompt){let i='<form><div class="grid grid-2col">';return a.forEach(s=>{let a=e?.flags?.system?.value_prompt||s.system.rank>1?s.system.rank:"";i+=`<input type="radio" name="consequence" value="${s.id}" />
                            <label for="consequence">${s.system.full_name} ${a}</label>`}),i+="</div></form>",new Dialog({title:`Select Which ${a[0].name} to Remove`,content:i,buttons:{Confirm:{icon:"<i class='fa fa-trash'></i>",label:"Remove",callback:async e=>{let a=e.find("input[name=consequence]:checked").val();a&&await s.deleteEmbeddedDocuments("Item",[a])}}},default:"Confirm"}).render({force:!0}),!1}return!0}class $927f0cb3cff0a1f2$export$c49d3afcc675f1b5 extends Actor{async prepareDerivedData(){super.prepareDerivedData(),"character"===this.type&&await $927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.calculate_scores(this),"stash"===this.type&&await $927f0cb3cff0a1f2$export$251803a9103f8263.calculate_scores(this),"vehicle"===this.type&&await $927f0cb3cff0a1f2$export$d98152187a58a356.calculate_scores(this)}getRollData(){let e=super.getRollData();if(e.stats){for(let s of Object.keys(e.stats))e[s]=e.stats[s].value;for(let s of Object.keys(e.scores))e[s]=e.scores[s].value}return e}getInitiativeRoll(e=null){return new Roll(e?e:this.is_npc()?$c76bcdf2af710582$export$bd4feec9a9a5101a.NPC_TURN:this.system.fast_turn?$c76bcdf2af710582$export$bd4feec9a9a5101a.FAST_TURN:$c76bcdf2af710582$export$bd4feec9a9a5101a.SLOW_TURN)}calculate_score(e,s,a={}){let i=Array.isArray(s)?$ef2b9a9b8ae02095$export$9c490b34b2f16a34(s):s,r=this.total_modifiers({base_score:e,...a}),n=1+r.percent/100;return Math.floor((i+r.modifier)*n/(r.divide||1))}armor_properties(){let e=this.items.filter(e=>"item"===e.type&&"Armors"===e.system.group&&e.system.equipped),s={Armor:0,Bulky:0,Powered:0};for(let a of e)a.system.armor>s.Armor&&(s.Armor=a.system.armor),a.system.bulky>s.Bulky&&(s.Bulky=a.system.bulky),a.system.powered>s.Powered&&(s.Powered=a.system.powered),a.system.properties.includes("Sealed")&&(s.Sealed=!0);return s}armor_value(){if(this.system.scores.armor.properties.Armor)return this.system.scores.armor.properties.Armor;let e=this.items.filter(e=>"item"===e.type&&"Armors"===e.system.group&&e.system.equipped),s=0;for(let a of e){let e=a.system.armor;e>s&&(s=e)}return s}encumbrance_total(){return this.items.filter(e=>"item"===e.type).reduce((e,s)=>s.system.encumbrance+e,0)}wound_total(){return this.items.filter(e=>"consequence"===e.type&&("wound"===e.name.toLowerCase()||"grave wound"===e.name.toLowerCase()||"fatigue"===e.name.toLowerCase())).map(e=>e.system.rank).reduce((e,s)=>e+s,0)}has_trait(e,s=null){let a=this.items.filter(s=>"trait"===s.type&&s.name.toLowerCase()===e.toLowerCase());if(!s)return!!a.length;let i=!1;for(let e of a)for(let a of e.system.specialization&&e.system.specialization.split(","))a.trim().toLowerCase()===s&&(i=!0);return i}has_immunity(e){return this.has_trait("Immunity",e)}has_vulnerability(e){return this.has_trait("Vulnerability",e)}has_resistance(e){return this.has_trait("Resistance",e)}dying_tn(){return Math.abs(Math.min(this.system.scores.health.max-this.system.scores.health.value,0))}async apply_damage(e,s,a,i){a="true"===a||!0===a;let r=(i=Number(i))===$a92622f457efc12a$export$a32b0b1c1ac59d04.IGNORES_ALL_ARMOR?Number(e):Number(e)-Math.max(this.system.scores.armor.value-Math.max(i,0),0);if(this.has_immunity(s)&&(ChatMessage.create({content:"The character has immunity. Ignoring damage.",whisper:[game.user.id]}),r=0),this.has_vulnerability(s)&&(ChatMessage.create({content:"The character has vulnerability. Doubling damage.",whisper:[game.user.id]}),r*=2),this.has_resistance(s)&&(ChatMessage.create({content:"The character has resistance. Halving damage.",whisper:[game.user.id]}),r=Math.floor(r/2)),r<=0)return;this.system.scores.health.value+r>=this.system.scores.health.max&&(a=!0,"fat"===s?ChatMessage.create({content:`Wound Total exceeds Health. ${this.name} must succeed at an <strong>End-${this.system.scores.health.fatigue+r}</strong> test or fall unconscious for [[1d10]] hours.`}):ChatMessage.create({content:`Wound Total exceeds Health. ${this.name} takes a Grave Wound.`}));let n=Math.floor(this.system.scores.health.value/this.system.scores.health.max),o=Math.max(Math.floor((this.system.scores.health.value+r)/this.system.scores.health.max)-n,+(this.system.scores.health.value>this.system.scores.health.max&&"fat"!==s));if("fat"===s&&0===n&&o--,o>0){let e=!1,s=this?.items.filter(e=>"Dying"===e.name&&"consequence"===e.type).values().next()?.value;s?e=!0:(s=await $b3d0fcc9cab9bd05$export$ce53e9a4e8384701({name:"Dying",actor:this,skip_actor:!0}),[s]=await this.createEmbeddedDocuments("Item",[s]));let a=e?s.system.rank+o:o;if(await s.update({"system.rank":a}),a>=3&&!this.statuses.has("defeated")){let e=null;if(CONFIG.statusEffects.forEach(s=>{"defeated"===s.id&&(e=s)}),e){let s=foundry.utils.deepClone(e);ActiveEffect.create(s,{parent:this}),ChatMessage.create({content:`Dying consequences exceed 3 or more. ${this.name} is dead.`})}}}let c=null;c="fat"===s?"Fatigue":a?"Grave Wound":"Wound";let l=game.items.filter(e=>e.name===c&&"consequence"===e.type).values().next()?.value;l||(l=await Item.create({name:c,type:"consequence",system:{specialized:!0,specialization:"describe injury",rank:1}}));let[d]=await this.createEmbeddedDocuments("Item",[l]);await d.update({"system.rank":r});let p=await $a92622f457efc12a$export$a8bf75e7367c8d41.generate_wound(s,a);new Dialog({title:`Describe ${c}`,content:`
                <form>
                    <div class="form-group">
                        <label for="descriptor">Descriptor</label>
                        <input type="text" name="descriptor" value="${p.descriptor}" autofocus>
                    </div>
                </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async e=>{let s=e.find("[name=descriptor]").val();p.descriptor!==s&&(p.description=""),await d.update({"system.specialization":s,"system.description":p.description})}}},default:"Confirm"}).render({force:!0})}async encumbrance_consequences(){if(this.isOwner)if(this.system.scores.encumbrance.value>this.system.scores.encumbrance.max){if(this.items.filter(e=>"Hindered"===e.name&&"Encumbered"===e.system.specialization&&"consequence"===e.type).length)return;let e=await $b3d0fcc9cab9bd05$export$ce53e9a4e8384701({name:"Hindered",actor:this,skip_actor:!0});[e]=await this.createEmbeddedDocuments("Item",[e]),await e.update({"system.specialization":"Encumbered","system.specialized":!0})}else{let e=this.items.filter(e=>"Hindered"===e.name&&"Encumbered"===e.system.specialization&&"consequence"===e.type);e.length&&await this.deleteEmbeddedDocuments("Item",e.map(e=>e.id))}}is_pc(){return"character"===this.type&&!this.system.npc}is_npc(){return"character"===this.type&&!!this.system.npc}total_modifiers(e){return $22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.total_modifiers(this.modifiers(e))}modifiers(e){let s=null;return(e.base_score&&(s=foundry.utils.deepClone(this.system.modifiers.scores[e.base_score])),("Defense"===e.tn||"Willpower"===e.tn)&&(s=foundry.utils.deepClone(this.system.modifiers.other.attack)),s?.length||"defense"!==e.score&&"willpower"!==e.score||(s=foundry.utils.deepClone(this.system.modifiers.other.defense)),!s?.length&&e.stat&&(s=foundry.utils.deepClone(this.system.modifiers.stats[e.stat])),s||(s=[]),Array.isArray(s))?(e.boons&&s.push(`boons=${e.boons}`),e.banes&&s.push(`banes=${e.banes}`),e.modifier&&s.push(`modifier=${e.modifier}`),e.divide&&s.push(`divide=${e.divide}`),!$53b5035feb70b083$export$4b017698e4946e33.is_attack(e)||$53b5035feb70b083$export$4b017698e4946e33.is_power(e)||$53b5035feb70b083$export$4b017698e4946e33.strength_met(e,this)||s.push("name=Low Str&banes=1"),("strength"===e.stat||"dexterity"===e.stat||"speed"===e.stat||"endurance"===e.stat)&&this.system.scores.health.fatigue&&this.system.scores.health.value>=this.system.scores.health.max&&s.push("name=Fatigue&banes=1"),("speed"===e.stat||"Athletics"===e.skill)&&this.system.scores.armor.properties.Bulky&&s.push("name=Bulky&banes=1"),"strength"===e.stat&&this.system.scores.armor.properties.Powered&&s.push("name=Powered&boons=2"),$53b5035feb70b083$export$4b017698e4946e33.is_attack(e)&&$53b5035feb70b083$export$4b017698e4946e33.has_property(e.properties,"Auto")&&s.push("name=Auto&boons=1"),$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.parse(s)):(console.error("Mods object is not array"),[])}async test(e){let s=new $71c9a09ec3eab7ed$export$1b16fc9eb974a84d({actor:this,...e});return!1!==e.evaluate&&await s.evaluate(),!1!==e.apply_effects&&await s.apply_effects(e),e.chat&&await s.to_chat({whisper:!!e.whisper}),s}}class $927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483{static async calculate_scores(e){e.system.scores.armor.properties=e.armor_properties(),e.system.scores.armor.custom||(e.system.scores.armor.value=e.calculate_score("armor",e.armor_value())),e.system.scores.defense.custom||(e.system.scores.defense.value=e.calculate_score("defense",[e.system.stats.dexterity.value,e.system.stats.speed.value,e.system.stats.perception.value])),e.system.scores.willpower.custom||(e.system.scores.willpower.value=e.calculate_score("willpower",[e.system.stats.intelligence.value,e.system.stats.charisma.value,e.system.stats.determination.value])),e.system.scores.health.custom||(e.system.scores.health.max=e.calculate_score("health",e.system.stats.strength.value+e.system.stats.endurance.value)),e.system.scores.health.value=e.wound_total(),e.system.scores.health.fatigue=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.fatigue(e),e.system.scores.move.custom||(e.system.scores.move.value=e.calculate_score("move",[e.system.stats.speed.value,e.system.stats.endurance.value,e.system.stats.determination.value],{modifier:-1*e.system.scores.armor.properties.Bulky||0,divide:e.system.scores.health.fatigue&&e.system.scores.health.value>=e.system.scores.health.max?2:1})),e.system.scores.encumbrance.custom||(e.system.scores.encumbrance.max=e.calculate_score("encumbrance",[e.system.stats.strength.value,e.system.stats.dexterity.value,e.system.stats.endurance.value],{modifier:e.system.scores.armor.properties.Powered||0})),e.system.scores.encumbrance.value=e.encumbrance_total();let s=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.experiences_spent(e);e.system.experiences.spent=s.total,e.system.experiences.spent_stats=s.stats,e.system.experiences.spent_skills=s.skills,e.system.experiences.spent_traits=s.traits,e.system.experiences.unspent=e.system.experiences.total-e.system.experiences.spent,e.system.experiences.level=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.power_level(e)}static fatigue(e){return e.items.filter(e=>"consequence"===e.type&&"fatigue"===e.name.toLowerCase()).map(e=>e.system.rank).reduce((e,s)=>e+s,0)}static stress(e){return e.items.filter(e=>"consequence"===e.type&&"stressed"===e.name.toLowerCase()).map(e=>e.system.rank).reduce((e,s)=>e+s,0)}static luck_cost(e){return 6*e-30}static stat_cost(e,s=0){let a=s?[...Array(s+1).keys()].reduce((e,s)=>e+s,0):0;return[...Array(e+1).keys()].reduce((e,s)=>e+s,-1*a)}static experiences_spent(e){let s=0;for(let a of["strength","dexterity","speed","endurance","intelligence","perception","charisma","determination"])s+=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.stat_cost(e.system.stats[a].value);s-=$ef2b9a9b8ae02095$export$33dec5772ae42010("level",120);let a=0,i=0;for(let s of e.items)"skill"===s.type&&(a+=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.stat_cost(s.system.rank,s.system.free_ranks)),"trait"===s.type&&(i+=s.system.ranked?s.system.cost*s.system.rank:s.system.cost);return{total:s+a+i+($ef2b9a9b8ae02095$export$33dec5772ae42010("luck_exp",!1)?$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.luck_cost(e.system.scores.luck.max):0),stats:s,skills:a,traits:i}}static power_level(e){let s=e.system.experiences.spent+$ef2b9a9b8ae02095$export$33dec5772ae42010("level",120);if(s<150)return"Mundane";if(s<200)return"Novice";if(s<250)return"Exceptional";if(s<300)return"Distinguished";if(s<350)return"Renowned";else return"Legendary"}static parry_bonus(e){let s=e.items.filter(e=>"item"===e.type&&"Weapons"===e.system.group&&e.system.equipped),a=0;for(let e of s){let s=e.system.parry;s>a&&(a=s)}return a}static primary_weapon(e){let s=e.items.filter(e=>"item"===e.type&&"Weapons"===e.system.group&&e.system.equipped),a=null,i=0;for(let e of s){let s=Number(e?.system?.actions?.[0]?.system?.action_effects.filter(e=>"damage"===e.type)?.[0]?.value)||0;s>i&&(i=s,a=e)}return a}static async merge_attack_option(e){if("true"!==e.option)return e;{let s=await fromUuid(e.uuid);if(!s)return e;let a=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.primary_weapon(s);if(!a)return e;let i=a?.system?.actions?.[0];return i?{uuid:e.uuid,type:e.type,stat:e.stat||i.system.stat,skill:e.skill||i.system.stat,tn:e.tn,modifiers:$53b5035feb70b083$export$4b017698e4946e33.merge_modifiers(i?.system?.modifiers,e.modifiers),properties:$53b5035feb70b083$export$4b017698e4946e33.merge_properties(i?.system?.properties,e.properties,!0),effects:JSON.stringify(i.system.action_effects.concat(JSON.parse(e.effects)))}:e}}}class $927f0cb3cff0a1f2$export$251803a9103f8263{static async calculate_scores(e){e.system.wealth.total=$927f0cb3cff0a1f2$export$251803a9103f8263.wealth_total(e),e.system.encumbrance.value=e.encumbrance_total()}static wealth_total(e){return e.items.filter(e=>"item"===e.type).reduce((e,s)=>s.system.cost*s.system.quantity+e,0)+e.system.wealth.money}}class $927f0cb3cff0a1f2$export$d98152187a58a356{static async calculate_scores(e){e.system.scores.armor.properties=e.armor_properties(),e.system.scores.armor.custom||(e.system.scores.armor.value=e.calculate_score("armor",e.armor_value())),e.system.scores.handling.boons=(e.system.scores.handling.label.match(/\+/g)||[]).length,e.system.scores.handling.banes=(e.system.scores.handling.label.match(/-/g)||[]).length,e.system.scores.defense.custom||(e.system.scores.defense.tn=e.calculate_score("defense",10+e.system.scores.handling.boons-(e.system.scores.size.value+e.system.scores.handling.banes))),e.system.scores.health.custom||(e.system.scores.health.max=e.calculate_score("health",15*2**e.system.scores.size.value)),e.system.scores.health.value=e.wound_total(),e.system.scores.space.value=$927f0cb3cff0a1f2$export$d98152187a58a356.loads_total(e)}static loads_total(e){return e.items.filter(e=>"item"===e.type).reduce((e,s)=>s.system.loads+e,0)}}Hooks.once("init",async()=>{Handlebars.registerHelper("is_GM",()=>game.user.isGM),Handlebars.registerHelper("is_weapon",e=>e?.system?.group?.toLowerCase()==="weapons"),Handlebars.registerHelper("is_wearable",e=>"armors"===e.system.group.toLowerCase()||"apparel"===e.system.group.toLowerCase()),Handlebars.registerHelper("has_uses",e=>Number.isFinite(parseInt(e.system.uses))),Handlebars.registerHelper("if_equal",(e,s,a)=>e===s?a.fn(void 0):a.inverse(void 0)),Handlebars.registerHelper("system_path",e=>`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/${e}`),await $ef2b9a9b8ae02095$export$76270d92bc7c69ae([{name:"character-header",path:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/partials/character-header.html`},{name:"character-sidebar",path:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/partials/character-sidebar.html`},{name:"character-inventory",path:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/partials/character-inventory.html`}])});const $d6f753df42abb3a6$export$80c8f1fa094e6c5={Broke:"Broke",Poor:"Poor",Struggling:"Struggling",Average:"Average",Comfortable:"Comfortable",Wealthy:"Wealthy","Very Wealthy":"Very Wealthy","Filthy Rich":"Filthy Rich"},$d6f753df42abb3a6$export$9e27b50feea479b8={Stash:"Stash",Merchant:"Merchant"},$d6f753df42abb3a6$export$a49669a6e3059265={common:"Common",uncommon:"Uncommon",rare:"Rare",exotic:"Exotic"},$d6f753df42abb3a6$export$b3cb66a2a96a3e6b={"++":"⊕⊕","+":"⊕","":"—","-":"⊖","--":"⊖⊖"};class $d6f753df42abb3a6$export$c7f6895f6cb1258b extends foundry.appv1.sheets.ActorSheet{get id(){return`saga-machine-actor-${this.document.uuid.replace(/\./g,"-")}`}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["saga-machine","sheet","actor"],width:850,height:650,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"basics"}],scrollY:[".basics",".combat",".inventory",".advancement"],dragDrop:[{dragSelector:".items-list .item",dropSelector:null}]})}get template(){return!game.user.isGM&&this.actor.limited?`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/actors/limited-sheet.html`:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/actors/${this.actor.type}-sheet.html`}getData(){let e=super.getData();return e.data.system.ambitions=this.items(e,"ambition",null,(e,s)=>e.system.type>s.system.type?1:-1),e.data.system.paths=this.items(e,"path"),e.data.system.origins=this.items(e,"origin"),e.data.system.all_skills=this.items(e,"skill"),e.data.system.skill_groups=this.skills_and_traits(e.data.system.all_skills,"General Skills"),e.data.system.all_traits=this.items(e,"trait"),e.data.system.trait_groups=this.skills_and_traits(e.data.system.all_traits,"General Traits",["General Traits","Weaknesses"]),e.data.system.consequences=this.items(e,"consequence"),e.data.system.equipment=this.items(e,"item"),e.data.system.containers=this.items(e,"item",e=>!!e.system.container),e}items(e,s,a,i){return a||(a=()=>!0),i||(i=(e,s)=>e.name>s.name?1:-1),e.actor.items.filter(e=>e.type===s&&a(e)).sort(i)}gather_actions(e){let s=this.items(e,"action");for(let a of e.actor.items.filter(e=>e.system.actions?.length&&!e.system.parent))for(let e of a.system.actions)s.push(new $53b5035feb70b083$export$471af1c74e831048(e,{parent:a,parentCollection:a.collection}));return s}skills_and_traits(e,s,a=null){let i=this.group_items(e,e=>e.system.group,null,null,s),r=[];if(a)for(let e of a)e in i||r.push({name:e,contents:[]});for(let e of Object.keys(i))r.push({name:e,contents:i[e]});return r.sort((e,a)=>e.name===a.name?0:e.name===s?-1:a.name===s?1:e.name<a.name?-1:+(e.name>a.name)),r}groups_and_containers({context:e,top_groups:s=["Weapons","Armors"],blank:a="Miscellanea"}){let i=this.group_items(e.data.system.equipment,e=>e.system.parent||e.system.group,e=>!e.system.container);e.data.system.equipment.filter(e=>!e.system.parent&&!e.system.container).length||(i[a]=[]);let r=[];for(let s of e.data.system.containers)s.id in i||r.push({name:s.system.full_name,container:s,contents:[],encumbrance:0,max:s.system.container});for(let s of Object.keys(i)){let a=e.data.system.containers.find(e=>e.id===s);r.push({name:a?a.system.full_name:s,container:a||null,contents:i[s],encumbrance:i[s].reduce((e,s)=>e+s.system.container_encumbrance,0),max:a?a.system.container:0})}return r.sort((e,a)=>{if(e.name===a.name)return 0;for(let i of s){if(e.name===i)return -1;if(a.name===i)return 1}return e.container&&!a.container?1:a.container&&!e.container||e.name<a.name?-1:+(e.name>a.name)}),r}group_items(e,s,a,i,r){a||(a=()=>!0),i||(i=(e,s)=>e.name>s.name?1:-1),r||(r="Miscellanea");let n=(e,s)=>s.split(".").reduce((e,s)=>e[s],e),o={};for(let i of e){if(!a(i))continue;let e="function"==typeof s?s(i):n(i,s);e&&"string"==typeof e||(e=r),e in o?o[e].push(i):o[e]=[i]}for(let e of Object.keys(o))o[e].sort(i);return o}calc_health_progress_bar(e){e.data.system.scores.health.max?e.data.system.scores.health.percent=Math.round(e.data.system.scores.health.value/e.data.system.scores.health.max*100):e.data.system.scores.health.percent=0}activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".item-create").on("click",this.on_item_create.bind(this)),e.find(".item-edit").on("click",this.on_item_edit.bind(this)),e.find(".item-delete").on("click",this.on_item_delete.bind(this)),e.find(".item-remove").on("click",this.on_item_remove.bind(this)),e.find(".item-input").on("change",this.on_item_update.bind(this)),e.find(".expandable").on("click",this.expand_description.bind(this)),e.find(".chatable").on("click",this.chat_description.bind(this)),this.init_origins_menu(e),this.attach_drag_events(e),this.attach_drop_events(e))}_onDragStart(e){"Test"===e.currentTarget.dataset.type&&e.stopPropagation(),this.attach_uuid(e.currentTarget.dataset);let s={"key-alt":e.altKey,"key-ctrl":e.ctrlKey,"key-shift":e.shiftKey,"key-meta":e.metaKey};e.dataTransfer.setData("text/plain",JSON.stringify({...e.currentTarget.dataset,...s})),super._onDragStart(e)}async on_item_create(e){e.preventDefault();let s=$(e.currentTarget).data("type"),a={name:$(e.currentTarget).data("name")||`New ${s}`,type:s,system:$(e.currentTarget).data("system")||{}},i=await this.actor.createEmbeddedDocuments("Item",[a]);return i?.[0]}async on_item_edit(e){let s=$(e.currentTarget).parents(".item");this.actor.items.get(s.data("id")).sheet.render({force:!0})}async on_item_delete(e){let s=$(e.currentTarget).parents(".item"),a=this.actor.items.get(s.data("id"));if(a.system.container){let e=this.actor.items.filter(e=>"item"===e.type&&e.system.parent===a.id);await this.actor.updateEmbeddedDocuments("Item",e.map(e=>Object({_id:e.id,"system.parent":null})))}await a.delete(),s&&s.length&&(s[0].style.display="none"),await this.render()}async on_item_remove(e){let s=$(e.currentTarget).parents(".item"),a={_id:this.actor.items.get(s.data("id")).id,"system.parent":null};this.actor.updateEmbeddedDocuments("Item",[a])}async on_item_update(e){let s=$(e.currentTarget).parents(".item"),a=e.currentTarget.getAttribute("data-name"),i={_id:s.data("id")};i[a]=Number(e.currentTarget.value),this.actor.updateEmbeddedDocuments("Item",[i])}async on_action_edit(e){let s=$(e.currentTarget).parents(".item");if("Actor"===s.data("parent-type"))await this.on_item_edit(e);else{let e=this.actor.items.get(s.data("parentId")),a=$53b5035feb70b083$export$4b017698e4946e33.parent_action_index(e,s.data("id"));if(a>e.system.actions.length||a<0)return;new $53b5035feb70b083$export$471af1c74e831048(e.system.actions[a],{parent:e,parentCollection:e.collection}).sheet.render({force:!0})}}async on_action_delete(e){let s=$(e.currentTarget).parents(".item");if("Actor"===s.data("parent-type"))await this.on_item_delete(e);else{let e=this.actor.items.get(s.data("parentId")),a=$53b5035feb70b083$export$4b017698e4946e33.parent_action_index(e,s.data("id"));e.system.actions.splice(a,1),e.update({"system.actions":e.system.actions}),s.remove()}}async expand_description(e){let s=null,a=$(e.target).closest(".item").find(".item-description");if(!a.length){let i=$(e.target).closest(".item").data("id");s=$(e.target).closest(".items-inline").find(".item-description"),a=$(e.target).closest(".items-inline").find(`.item-description[data-id='${i}']`)}if(s)for(let e of s)e!==a[0]&&$(e).is(":visible")&&$(e).slideUp(200);a.slideToggle(200)}async chat_description(e){let s=$(e.target).closest(".item").data("id");if(!s)return;let a=this.actor.items.get(s);if(a)if(a.system.actions&&a.system.actions.length){let s=[];for(let e of a.system.actions)s.push(new $53b5035feb70b083$export$471af1c74e831048(e,{parent:a,parentCollection:a.collection}));let i=[{action:"display",icon:"fa-solid fa-message",label:"Display in Chat",callback:()=>this.to_chat(a)}];for(let a of s)i.push({action:`do_${a.name}`,icon:"fa-solid fa-hand",label:a.name,callback:()=>this.on_test(e,{type:"Test",option:a.system.attack_option,stat:a.system.stat,skill:a.system.skill,tn:a.system.tn,modifiers:a.system.modifiers,properties:a.system.properties,effects:a.sheet.effects_str})});new foundry.applications.api.DialogV2({window:{title:"Choose Action"},content:"<p>What would you like to do?</p>",buttons:i,default:"display",close:()=>{}}).render({force:!0})}else this.to_chat(a)}init_origins_menu(e){let s=$ef2b9a9b8ae02095$export$33dec5772ae42010("origin_label","Origin"),a=$ef2b9a9b8ae02095$export$33dec5772ae42010("path_label","Path"),i=[{name:s,icon:`<img class="menu-img" src="${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/origin.svg" />`,condition:!0,callback:async e=>(await this.actor.createEmbeddedDocuments("Item",[{name:`New ${s}`,type:"origin"}]),console.log(this),!0)},{name:a,icon:`<img class="menu-img" src="${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/defaults/path.svg" />`,condition:!0,callback:async e=>{await this.actor.createEmbeddedDocuments("Item",[{name:`New ${a}`,type:"path"}])}}];foundry.applications.ux.ContextMenu.create(this,e?.[0],".origins-add",i,{eventName:"click",jQuery:!1})}attach_drag_events(e){e.find(".rollable").each((e,s)=>{s.setAttribute("draggable",!0),s.addEventListener("dragstart",e=>this._onDragStart(e),!1)}),e.find(".items-list .item input, .items-list .item select").on("mousedown",function(e){e.stopPropagation(),$(e.target).closest(".item").attr("draggable",!1)}),e.find(".items-list .item").on("mousedown",function(e){$(e.target).attr("draggable",!0)}).on({dragstart:function(e){e.stopPropagation();let s=e.originalEvent&&e.originalEvent.dataTransfer?e.originalEvent.dataTransfer:e.dataTransfer;s&&(s.effectAllowed="move",s.setData("text/html",""))}})}attach_drop_events(e){e.find(".item-group").on("drop",async e=>{let s=null;try{s=JSON.parse((e.dataTransfer||e.originalEvent?.dataTransfer).getData("text/plain"))}catch(e){}if(!s||!s.uuid||"Item"!==s.type)return;let a=await fromUuid(s.uuid);if("item"!==a.type)return;let i=$(e.currentTarget).data("id");i&&(a.system.container_encumbrance+$(e.currentTarget).data("encumbrance")<=$(e.currentTarget).data("max")?await a.update({"system.parent":i}):await a.update({"system.parent":null}))})}async on_score_toggle(e){e.preventDefault();let s=$(e.target);s.hasClass("score-secondary")?this.adjust_score(s,-1):this.toggle_custom(s)}async on_score_increment(e){e.preventDefault();let s=$(e.target);s.hasClass("score-secondary")&&this.adjust_score(s,1)}attach_uuid(e){e.uuid||(e.uuid=this.actor.uuid)}adjust_score(e,s){let a=e.attr("name"),i=this.get_score(a,[]),r={};r[a]=i+s,this.actor.update(r)}toggle_custom(e){let s=e.hasClass("score-input")?e:e.find(".score-input");if(!s.length)return;let a=s.attr("name"),i=this.get_score(a,["max","value","tn"]);if(!i)return;s.prop("disabled",!!i.custom);let r=this.get_score_custom(a),n={};n[r]=!i.custom,this.actor.update(n)}get_score(e,s){let a=e.split("."),i=this.actor;for(let e of a)if(i&&!s.includes(e))i=i[e]?i[e]:null;else break;return i}get_score_custom(e){return e.substring(0,e.lastIndexOf("."))+".custom"}to_chat(e){ChatMessage.create({flavor:`<header class="item-header"><img src="${e.img}" alt="${e.name}" /><h2>${e.name}</h2></header>`,content:e.system.description,speaker:ChatMessage.getSpeaker({actor:this.actor})})}async on_test(e,s=null){e.preventDefault(),s||(s=e.currentTarget.dataset),this.attach_uuid(s),s=await $927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.merge_attack_option(s),await $71c9a09ec3eab7ed$export$5803ef6f71bdd50f(s)}}class $d6f753df42abb3a6$export$eaa36efd5f1a839 extends $d6f753df42abb3a6$export$c7f6895f6cb1258b{get template(){return!game.user.isGM&&this.actor.limited?`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/actors/limited-sheet.html`:this.actor.is_pc()?`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/actors/pc-sheet.html`:`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/actors/npc-sheet.html`}getData(){let e=super.getData();return e.data.system.scores.luck.label=$ef2b9a9b8ae02095$export$33dec5772ae42010("luck_label","Luck"),e.data.system.wealth.money_label=$ef2b9a9b8ae02095$export$33dec5772ae42010("money_label","Money"),e.data.system.LIFESTYLES=$d6f753df42abb3a6$export$80c8f1fa094e6c5,e.data.system.equipment_groups=this.groups_and_containers({context:e,top_groups:["Weapons","Armors"],blank:"Miscellanea"}),e.data.system.actions=this.gather_actions(e),e.data.system.action_groups=this.skills_and_traits(e.data.system.actions,"Attacks"),this.calc_health_progress_bar(e),e.data.system.defenses=this.gather_defenses(e),e}activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".rollable").click(this.on_test.bind(this)),e.find(".score").on("contextmenu",this.on_score_toggle.bind(this)),e.find(".score").on("click",this.on_score_increment.bind(this)),e.find(".item-equip").click(this.on_item_equip.bind(this)),e.find(".item-carry").click(this.on_item_carry.bind(this)),e.find(".items-inline > .item").on("contextmenu",this.on_npc_edit.bind(this)),e.find(".defense-test").on("click",this.on_defense_test.bind(this)),e.find(".dodge-toggle").on("click",this.on_dodge.bind(this)),e.find(".parry-toggle").on("click",this.on_parry.bind(this)),e.find(".resist-toggle").on("click",this.on_resist.bind(this)),e.find(".action-edit").on("click",this.on_action_edit.bind(this)),e.find(".action-delete").on("click",this.on_action_delete.bind(this)))}async on_dodge(e){e.preventDefault();let s=!this.actor.system.scores.defense.dodge_on;this.actor.system.scores.defense.parry_on&&await this.on_parry(e);let a=async e=>{e.total>this.actor.system.scores.defense.tn&&await this.actor.update({"system.scores.defense.tn":e.total,"system.scores.defense.dodge_on":!0,"system.scores.defense.round_tn":this.actor.system.scores.defense.tn})};if(s){let e={type:"Test",score:"defense"};this.attach_uuid(e),await $71c9a09ec3eab7ed$export$5803ef6f71bdd50f(e,a)}else await ChatMessage.create({flavor:`<div>Removing Dodge.</div><div><strong>Defense TN:</strong> ${this.actor.system.scores.defense.round_tn}</div>`,whisper:game.users.filter(e=>e.character?.id===this.actor?.id).map(e=>e.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.defense.tn":this.actor.system.scores.defense.round_tn,"system.scores.defense.dodge_on":!1})}async on_resist(e){e.preventDefault();let s=!this.actor.system.scores.willpower.resist_on,a=async e=>{e.total>this.actor.system.scores.willpower.tn&&await this.actor.update({"system.scores.willpower.tn":e.total,"system.scores.willpower.resist_on":!0,"system.scores.willpower.round_tn":this.actor.system.scores.willpower.tn})};if(s){let e={type:"Test",score:"willpower"};this.attach_uuid(e),await $71c9a09ec3eab7ed$export$5803ef6f71bdd50f(e,a)}else await ChatMessage.create({flavor:`<div>Removing Resist.</div><div><strong>Willpower TN:</strong> ${this.actor.system.scores.willpower.round_tn}</div>`,whisper:game.users.filter(e=>e.character?.id===this.actor?.id).map(e=>e.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.willpower.tn":this.actor.system.scores.willpower.round_tn,"system.scores.willpower.resist_on":!1})}async on_parry(e){this.actor.system.scores.defense.dodge_on&&await this.on_dodge(e);let s=!this.actor.system.scores.defense.parry_on,a=$927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.parry_bonus(this.actor),i=s?this.actor.system.scores.defense.tn+a:this.actor.system.scores.defense.tn-a;s?await ChatMessage.create({flavor:`<div>${this.actor.name} Parries!</div><div><strong>Defense TN:</strong> ${i}</div>`,speaker:ChatMessage.getSpeaker({actor:this.actor})}):await ChatMessage.create({flavor:`<div>Removing Parry bonus.</div><div><strong>Defense TN:</strong> ${i}</div>`,whisper:game.users.filter(e=>e.character?.id===this.actor?.id).map(e=>e.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.defense.tn":i,"system.scores.defense.parry_on":s})}async on_defense_test(e){let s=this.actor.system.scores.defense.test;if(s){for(let e of this.gather_actions(this))if(e.id===s){let s={type:"Test",stat:e.system.stat,skill:e.system.skill,tn:e.system.tn,modifiers:e.system.modifiers,properties:e.system.properties,effects:e.sheet.effects_str};return this.attach_uuid(s),await $71c9a09ec3eab7ed$export$5803ef6f71bdd50f(s)}}else await this.on_test(e)}gather_defenses(e){let s=[];for(let a of e.data.system.actions)$53b5035feb70b083$export$4b017698e4946e33.is_defense(a.system.action_effects)&&s.push(a);return s}async on_item_equip(e){let s=$(e.currentTarget).parents(".item"),a=this.actor.items.get(s.data("id"));a||(a=this.actor.items.get(s.data("parentId")));let i={_id:a.id,"system.equipped":!a.system.equipped};this.actor.updateEmbeddedDocuments("Item",[i])}async on_item_carry(e){let s=$(e.currentTarget).parents(".item"),a=this.actor.items.get(s.data("id")),i={_id:a.id,"system.carried":!a.system.carried};this.actor.updateEmbeddedDocuments("Item",[i])}async on_npc_edit(e){e.preventDefault();let s=$(e.currentTarget).closest(".item");this.actor.items.get(s.data("id")).sheet.render({force:!0})}}class $d6f753df42abb3a6$export$9059fd0f09215233 extends $d6f753df42abb3a6$export$c7f6895f6cb1258b{getData(){let e=super.getData();return e.data.system.STASH_TYPES=$d6f753df42abb3a6$export$9e27b50feea479b8,e.data.system.wealth.money_label=$ef2b9a9b8ae02095$export$33dec5772ae42010("money_label","Money"),e.data.system.equipment_groups=this.groups_and_containers({context:e,top_groups:["Weapons","Armors"],blank:"Miscellanea"}),e}activateListeners(e){super.activateListeners(e),this.isEditable&&e.find(".distribute-money").on("click",this.distribute_money.bind(this))}async distribute_money(){let e=game?.canvas?.tokens?.controlled;if(!e.length)return ui.notifications.warn("No valid character selected.");let s=this.actor.system.wealth.money%e.length,a=Math.floor(this.actor.system.wealth.money/e.length);for(let i of e)i.actor.isOwner?i.actor.update({"system.wealth.money":i.actor.system.wealth.money+a}):s+=a;this.actor.update({"system.wealth.money":s});let i="<li>"+e.map(e=>`@UUID[${e.actor.uuid}]{${e.name}}`).join("</li><li>")+"</li>";ChatMessage.create({content:`<strong>${a}\xa4</strong> each distributed from @UUID[${this.actor.uuid}]{${this.actor.name}} to:<ul style="line-height: 1.7em">${i}</ul>`})}}class $d6f753df42abb3a6$export$d55003dbaa27bba5 extends $d6f753df42abb3a6$export$c7f6895f6cb1258b{async getData(){let e=super.getData();return e.data.system.is_pc=this.actor.hasPlayerOwner,e.data.system.VEHICLE_AVAILABILITY=$d6f753df42abb3a6$export$a49669a6e3059265,e.data.system.VEHICLE_HANDLING=$d6f753df42abb3a6$export$b3cb66a2a96a3e6b,e.data.system.equipment_groups=this.groups_and_containers({context:e,top_groups:["Vehicle Components","Trade Goods"],blank:"Trade Goods"}),e.data.system.actions=this.gather_actions(e),e.data.system.action_groups=this.skills_and_traits(e.data.system.actions,"Attacks"),await this.lookup_crew(e),this.calc_health_progress_bar(e),this.calc_space_progress_bar(e),e}async activateListeners(e){super.activateListeners(e),await this.draw_positions(e),this.isEditable&&(e.find(".rollable").click(this.on_test.bind(this)),e.find(".score").on("contextmenu",this.on_score_toggle.bind(this)),e.find(".score").on("click",this.on_score_increment.bind(this)),e.find(".position-list .lock-toggle").click(this.toggle_lock.bind(this)),e.find(".position-list .position-row").on("drop",this.drop_crewman.bind(this)),e.find(".position-list img.crewman").click(this.open_crewman.bind(this)),e.find(".position-list .crew-delete").click(this.delete_crewman.bind(this)),e.find(".position-list .position-create").click(this.add_position.bind(this)),e.find(".position-list .position-delete").click(this.delete_position.bind(this)),e.find(".action-crewman").on("change",this.on_action_crewman.bind(this)),e.find(".action-edit").on("click",this.on_action_edit.bind(this)),e.find(".action-delete").on("click",this.on_action_delete.bind(this)))}calc_space_progress_bar(e){e.data.system.scores.space.max?e.data.system.scores.space.percent=Math.round(e.data.system.scores.space.value/e.data.system.scores.space.max*100):e.data.system.scores.space.percent=0}async on_test(e){e.preventDefault();let s=$(e.currentTarget).closest(".item, .position").find("select.action-crewman, input[name=character]").val();e.currentTarget.dataset.uuid=s||this.actor.uuid,await $71c9a09ec3eab7ed$export$5803ef6f71bdd50f({...e.currentTarget.dataset,...s?{}:{score:"crew",stat:null,skill:null}})}async lookup_crew(e){for(let s of e.data.system.scores.crew.positions)s.character&&(s.actor=await fromUuid(s.character),s.label=`${s.actor.name} (${s.position})`);e.data.system.scores.crew.roster=e.data.system.scores.crew.positions.filter(e=>e.character)}on_action_crewman(e){e.preventDefault(),e.stopPropagation()}async drop_crewman(e){let s=null;try{s=JSON.parse((e.dataTransfer||e.originalEvent?.dataTransfer)?.getData("text/plain"))}catch(e){}if(!s||!s.uuid||"Actor"!==s.type)return;let a=await fromUuid(s.uuid);"character"===a.type&&($(e.currentTarget).closest(".position").find("input[name=character]").val(a.uuid),this.update_positions(e))}async open_crewman(e){let s=$(e.currentTarget).data("uuid");(await fromUuid(s)).sheet.render({force:!0})}async delete_crewman(e){$(e.currentTarget).closest(".character").find("input[name=character]").val(""),this.update_positions(e)}toggle_lock(e){let s=$(e.currentTarget).closest(".lock-toggle"),a=s.closest(".position-list");s.hasClass("locked")?(s.removeClass("locked").find("i").removeClass("fa-lock").addClass("fa-unlock"),a.find(".position-create").removeClass("hidden"),a.find(".position-delete").removeClass("hidden"),a.find("select").removeAttr("disabled")):(s.addClass("locked").find("i").removeClass("fa-unlock").addClass("fa-lock"),a.find(".position-create").addClass("hidden"),a.find(".position-delete").addClass("hidden"),a.find("select").attr("disabled","disabled"))}async add_position(e){if(!this.isEditable)return;let s=this.element.find(".position.prototype"),a=this.element.find("ol.position-list");if(!s||!s.length||!a||!a.length)return;let i=s.clone();i.removeClass("prototype"),i.find("input, select").change(this.update_positions.bind(this)),a.append(i),this.update_positions(e)}async delete_position(e){let s=$(e.currentTarget).closest(".position"),a=s.closest(".position-list");s.remove(),this.update_positions(e,a)}async draw_positions(e){if(!this.actor.system.scores.crew.positions||!this.actor.system.scores.crew.positions.length)return;let s=e.find(".position.prototype"),a=e.find("ol.position-list");if(s&&s.length&&a&&a.length)for(let e of this.actor.system.scores.crew.positions){let i=s.clone();if(i.removeClass("prototype"),i.find("[name=position]").val(e.position),i.find("[name=character]").val(e.character),e.character){let s=await fromUuid(e.character);i.find(".character").addClass("filled"),i.find("img.crewman").attr("src",s.img).data("uuid",s.uuid),i.find("div.character-label").text(s.name)}a.append(i),this.isEditable&&(i.find("input, select").change(this.update_positions.bind(this)),"Captain"===e.position?i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Coordinate","charisma","Persuade",12)+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Inspire","perception","Empathy",12)):"Driver/Pilot"===e.position?i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Regain Control","speed","Vehicles",12)+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Evasive Actions","speed","Vehicles","")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Close","speed","Vehicles","",null,"Vehicles vs. Vehicles")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Escape","speed","Vehicles","",null,"Vehicles vs. Vehicles")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("On Alert","speed","Vehicles",12)):"Engineer"===e.position?i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Reroute Power","intelligence","Academics (Engineering)",12,"academics")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Boost","intelligence","Academics (Engineering)",12,"academics")):"Gunner"===e.position?i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Point Defense","dexterity","Projectiles","",null,"Projectiles vs. Projectiles")):"Jammer"===e.position?i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Jam","intelligence","Academics (Computing)",12,"academics")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Unjam","intelligence","Academics (Computing)",12,"academics")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Countermeasures","intelligence","Academics (Computing)","","academics","Academics (Computing) vs. Academics (Computing)")):"Marine"===e.position?i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Board","strength","Athletics",12)):"Mechanic"===e.position?i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Repair","dexterity","Trade (Mechanic)",10,"trade")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Jury-rig","dexterity","Trade (Mechanic)",12,"trade")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Recalibrate","dexterity","Trade (Mechanic)",12,"trade")):"Medic"===e.position&&i.find(".position-actions").html($d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Treat","dexterity","Medicine",10,null,"Dex/Medicine-10")+$d6f753df42abb3a6$export$d55003dbaa27bba5.position_action_button("Counsel","perception","Empathy",12)))}}static position_action_button(e,s,a,i,r=null,n=null){return r||(r=a.toLowerCase()),n||(n=`${a}-${i}`),`<span class="item-img rollable" data-type="Test" data-stat="${s}" data-skill="${a}" data-tn="${i}" draggable="true">
				    <img class="item-img" src="${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/skills/${r}.svg" title="${e}: ${n} test">
				    <img class="item-img" src="${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/images/d10.svg" title="${e}: ${n} test">
			    </span>`}async update_positions(e,s=null){e.preventDefault(),e.stopPropagation();let a=$(e.currentTarget).closest("ol.position-list"),i=!!a.find(".lock-toggle").hasClass("locked"),r=s?s.find(".position:not(.prototype)"):a.find(".position:not(.prototype)"),n=[];r.each((e,s)=>{let a=$(s).find("[name=position]").val().trim(),i=$(s).find("[name=character]").val().trim();n.push({position:a,character:i})}),await this.actor.update({"system.scores.crew.positions":n}),i||setTimeout(()=>this.element.find(".lock-toggle").trigger("click"),10)}}const $2ff7f2f1b7e19ff4$export$d4de1c0b65920b67={"Long-term":"Long-term","Short-term":"Short-term",Party:"Party",Quest:"Quest"},$2ff7f2f1b7e19ff4$export$78527858eb8a4178={"":"--",strength:"Strength",dexterity:"Dexterity",speed:"Speed",endurance:"Endurance",intelligence:"Intelligence",perception:"Perception",charisma:"Charisma",determination:"Determination"},$2ff7f2f1b7e19ff4$export$55fbcbf6ed18708={common:"Common",uncommon:"Uncommon",rare:"Rare",exotic:"Exotic"};class $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5 extends foundry.appv1.sheets.ItemSheet{get id(){return`saga-machine-item-${this.document.uuid.replace(/\./g,"-")}`}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["saga-machine","sheet","item"],width:600,height:360,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"basics"}],scrollY:[".basics",".actions","effects",".description"]})}get template(){return`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/templates/items/${this.item.type}-sheet.html`}getData(){return super.getData()}activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".actions .item-create").click(this.add_action.bind(this)),e.find(".actions .action-edit").click(this.edit_action.bind(this)),e.find(".actions .action-delete").click(this.delete_action.bind(this)))}toggle_items_provided(e){e.preventDefault(),$(e.target).parent().find(".items-provided").each((e,s)=>{$(s).is(":visible")?s.style.display="none":s.style.display="block"})}async on_create_effect(e){return e.preventDefault(),await ActiveEffect.create({name:"New Effect"},{parent:this.item})}async on_edit_effect(e){let s=$(e.target).closest(".effect"),a=s.data("id"),i=s.data("name"),r=a?this.item.effects.get(a):this.item.effects.getName(i);r&&r.sheet.render({force:!0})}async on_delete_effect(e){let s=$(e.target).closest(".effect"),a=s.data("id"),i=s.data("name"),r=a?this.item.effects.get(a):this.item.effects.getName(i);await r.delete(),s&&s.length&&(s[0].style.display="none"),await this.render()}async on_toggle_effect(e){let s=$(e.target).closest(".effect"),a=s.data("id"),i=s.data("name"),r=a?this.item.effects.get(a):this.item.effects.getName(i);r.update({disabled:!r.disabled})}add_action(){if(!this.isEditable)return;let e={name:this.item.name,type:"action",_id:$ef2b9a9b8ae02095$export$260ae3d8e98e4090(),img:this.item.img,system:{}};this.item.system.description&&(e.system.description=this.item.system.description),"item"===this.item.type&&(e.system.properties=this.item.system.properties,"Weapons"===this.item.system.group&&(e.system.group="Attacks")),"skill"===this.item.type&&(e.system.skill=this.item.system.full_name,e.system.stat=this.item.system.default,"Powers"===this.item.system.group&&(e.system.group="Powers"),"Maneuvers"===this.item.system.group&&(e.system.group="Attacks"),"Opening Moves"===this.item.system.group&&(e.system.group="Attacks"),"Stances"===this.item.system.group&&(e.system.group="Attacks"));let s=new $53b5035feb70b083$export$471af1c74e831048(e,{parent:this.item,parentCollection:this.item.collection});this.item.system.actions.push(s.toJSON()),this.item.update({"system.actions":this.item.system.actions})}edit_action(e){let s=$(e.target).closest(".action").data("id");s>this.item.system.actions.length||new $53b5035feb70b083$export$471af1c74e831048(this.item.system.actions[s],{parent:this.item,parentCollection:this.item.collection}).sheet.render({force:!0})}delete_action(e){let s=$(e.target).closest(".action"),a=s.data("id");this.item.system.actions.splice(a,1),this.item.update({"system.actions":this.item.system.actions}),s.remove()}items_provided(e,s){if(!s)return"&horbar;";let a=[];for(let i of s.split(",").map(e=>e.trim())){let s=this.matching_item(e,i),[r,n,o,c]=[s.item,s.name,s.specialization,s.rank];r?a.push(`<a class="content-link" draggable="true" data-uuid="${r.uuid}" data-id="${r.id}" data-type="Item" data-specialization="${o}" data-rank="${c}" data-tooltip="Item"><i class="fas fa-suitcase"></i>${i}</a>`):a.push(`<a class="content-link broken" draggable="true" data-type="${e}" data-name="${n}" data-specialization="${o}" data-rank="${c}"><i class="fas fa-unlink"></i>${i}</a>`)}return a.join(", ")}matching_item(e,s){let a=s.split(" "),i=a[a.length-1];isNaN(Number(i))&&(i="");let r=s.match(/\(([^\)]+)\)/);r=r?r[r.length-1]:"";let n=s.slice(0,s.length-i.length);(a=n.split("(")).length>1&&(n=a[0]),n=n.trim();let o=game.items.filter(s=>s.type===e&&s.name===n);return o.length?{item:o[0],name:n,specialization:r,rank:i}:{item:null,name:n,specialization:r,rank:i}}}class $2ff7f2f1b7e19ff4$export$96c1200f91678a19 extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{getData(){let e=super.getData();return e.data.system.SKILL_DEFAULTS=$2ff7f2f1b7e19ff4$export$78527858eb8a4178,e}activateListeners(e){if(super.activateListeners(e),!this.isEditable)return}}class $2ff7f2f1b7e19ff4$export$9f2a24c9f192c221 extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".effect-create").on("click",this.on_create_effect.bind(this)),e.find(".effect-edit").on("click",this.on_edit_effect.bind(this)),e.find(".effect-delete").on("click",this.on_delete_effect.bind(this)),e.find(".effect-toggle").on("click",this.on_toggle_effect.bind(this)))}}class $2ff7f2f1b7e19ff4$export$4169507366d0a707 extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{getData(){let e=super.getData();return e.data.system.skills_provided=this.items_provided("skill",e.data.system.skills),e.data.system.traits_provided=this.items_provided("trait",e.data.system.traits),e.data.system.equipment_provided=this.items_provided("item",e.data.system.equipment),e}activateListeners(e){super.activateListeners(e),this.isEditable&&e.find(".items-provided").on("contextmenu",this.toggle_items_provided.bind(this))}}class $2ff7f2f1b7e19ff4$export$6f7f838e9b4593fa extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{getData(){let e=super.getData();return e.data.system.skills_provided=this.items_provided("skill",e.data.system.skills),e.data.system.traits_provided=this.items_provided("trait",e.data.system.traits),e.data.system.equipment_provided=this.items_provided("item",e.data.system.equipment),e}activateListeners(e){super.activateListeners(e),this.isEditable&&e.find(".items-provided").on("contextmenu",this.toggle_items_provided.bind(this))}}class $2ff7f2f1b7e19ff4$export$eff3dd514a394135 extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{activateListeners(e){super.activateListeners(e),this.isEditable&&(e.find(".effect-create").on("click",this.on_create_effect.bind(this)),e.find(".effect-edit").on("click",this.on_edit_effect.bind(this)),e.find(".effect-delete").on("click",this.on_delete_effect.bind(this)),e.find(".effect-toggle").on("click",this.on_toggle_effect.bind(this)))}}class $2ff7f2f1b7e19ff4$export$7b63ff0ee2469440 extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{getData(){let e=super.getData();return e.data.system.ITEM_AVAILABILITY=$2ff7f2f1b7e19ff4$export$55fbcbf6ed18708,e}activateListeners(e){if(super.activateListeners(e),!this.isEditable)return}}class $2ff7f2f1b7e19ff4$export$f62ad08e7f4ea9c3 extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{getData(){let e=super.getData();return e.data.system.AMBITION_TYPES=$2ff7f2f1b7e19ff4$export$d4de1c0b65920b67,e}}class $2ff7f2f1b7e19ff4$export$aa81b4e329608703 extends $2ff7f2f1b7e19ff4$export$11dc603c5bc66ba5{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{width:550,height:600})}getData(){let e=super.getData();return e.data.system.STAT_OPTIONS=$71c9a09ec3eab7ed$export$3b84a4f667a9b873,e.data.system.SCORE_OPTIONS=$71c9a09ec3eab7ed$export$31ebfa08917fa7c5,e}activateListeners(e){if(super.activateListeners(e),!this.isEditable)return;for(let s of e.find(".tag-input"))"system.modifiers"===s.getAttribute("name")&&Array.isArray(this.item.system.modifiers)&&(s.value=this.item.system.modifiers.join(",")),"system.properties"===s.getAttribute("name")&&Array.isArray(this.item.system.properties)&&(s.value=this.item.system.properties.join(",")),new($parcel$interopDefault($3311d4ef469e3627$exports))(s,{duplicates:!0,transformTag:e=>{e.style=$22cc8bc5a51ebc2b$export$b5c87c9f30e8974e.color(e.value),isNaN(parseInt(e.value.split(" ").at(-1)))&&(e.value=e.value.replaceAll("+","⊕").replaceAll("-","⊖"))}});let s=e.find("select.stat[name='system.stat']"),a=e.find("select.score[name='system.stat']");s.on("change",()=>a.val("")),a.on("change",()=>s.val("")),this.draw_effects(e),e.find(".action-row .item-create").click(this.add_effect.bind(this)),e.find(".action-row .item-delete").click(this.delete_effect.bind(this))}_getSubmitData(e={}){let s=super._getSubmitData(e);if("system.stat"in s&&Array.isArray(s["system.stat"])&&s["system.stat"].length>=2&&(s["system.stat"]=s["system.stat"][0]?s["system.stat"][0]:s["system.stat"][1]),"system.modifiers"in s)try{s["system.modifiers"]=JSON.parse(s["system.modifiers"]).map(e=>e.value)}catch{}if("system.properties"in s)try{s["system.properties"]=JSON.parse(s["system.properties"]).map(e=>e.value)}catch{}return s}async _onSubmit(e,{updateData:s=null,preventClose:a=!1,preventRender:i=!1}={}){if(e.preventDefault(),!(this.item.parent instanceof $53b5035feb70b083$export$471af1c74e831048))return super._onSubmit(e,{updateData:s,preventClose:a,preventRender:i});{let e=this._getSubmitData(s);"consequence_name"in e&&delete e.consequence_name,"consequence_subject"in e&&delete e.consequence_subject,"damage_type"in e&&delete e.damage_type,"damage_value"in e&&delete e.damage_value,"effect_target"in e&&delete e.effect_target,"effect_type"in e&&delete e.effect_type,"effect_when"in e&&delete e.effect_when,"message_key"in e&&delete e.message_key,"message_value"in e&&delete e.message_value,foundry.utils.mergeObject(this.item,e);let a=$53b5035feb70b083$export$4b017698e4946e33.parent_action_index(this?.item?.parent,this.item.id);if(a>=0)return this.item.parent.system.actions[a]=this.item.toObject(!1),await this.item.parent.update({"system.actions":this.item.parent.system.actions})}}draw_effects(e){if(!this.item.system.action_effects||!this.item.system.action_effects.length)return;let s=e.find(".action-effect.prototype"),a=e.find("ol.action-list");if(s&&s.length&&a&&a.length)for(let e of this.item.system.action_effects){let i=s.clone();i.removeClass("prototype"),i.find("[name=effect_type]").val(e.type),"damage"===e.type&&i.find("[name=damage_value]").val(e.value),"damage"===e.type&&i.find("[name=damage_type]").val(e.damage_type),"consequence"===e.type&&i.find("[name=consequence_name]").val(e.name),"consequence"===e.type&&i.find("[name=consequence_subject]").val(e.subject),"message"===e.type&&i.find("[name=message_key]").val(e.key),"message"===e.type&&i.find("[name=message_value]").val(e.value),i.find("[name=effect_when]").val(e.when),i.find("[name=effect_target]").val(e.target),this.change_effect_type(i),a.append(i),this.isEditable&&i.find("input, select").change(this.update_effects.bind(this))}}change_effect_type(e){let s=e.find("[name=effect_type]").val(),a=e.find(".action-props").children();if(e.length&&s&&a.length)for(let e of a)e.classList.contains(`action-${s}`)?e.classList.remove("hidden"):e.classList.add("hidden")}add_effect(){if(!this.isEditable)return;let e=this.element.find(".action-effect.prototype"),s=this.element.find("ol.action-list");if(!e||!e.length||!s||!s.length)return;let a=e.clone();a.removeClass("prototype"),a.find("input, select").change(this.update_effects.bind(this)),s.append(a)}delete_effect(e){let s=$(e.currentTarget).closest(".action-effect"),a=s.closest(".action-list");s.remove(),this.update_effects(e,a)}async update_effects(e,s=null){e.preventDefault(),e.stopPropagation();let a=s?s.find(".action-effect:not(.prototype)"):$(e.currentTarget).closest("ol.action-list").find(".action-effect:not(.prototype)"),i=[];a.each((e,s)=>{let a=$(s).find("[name=effect_type]").val().trim(),r=$(s).find("[name=damage_value]").val().trim(),n=$(s).find("[name=damage_type]").val().trim(),o=$(s).find("[name=consequence_name]").val().trim(),c=$(s).find("[name=consequence_subject]").val().trim(),l=$(s).find("[name=message_key]").val().trim(),d=$(s).find("[name=message_value]").val().trim(),p={type:a,when:$(s).find("[name=effect_when]").val().trim(),target:$(s).find("[name=effect_target]").val().trim()};"damage"===a?p={value:r,damage_type:n,...p}:"consequence"===a?p={name:o,subject:c||null,...p}:"message"===a&&(p={key:l||null,value:d,...p});try{i.push($a92622f457efc12a$export$a32b0b1c1ac59d04.to_json(new $a92622f457efc12a$export$a32b0b1c1ac59d04(p)))}catch(e){}}),this.item.parent instanceof $53b5035feb70b083$export$471af1c74e831048?(await this.submit({updateData:{"system.action_effects":i}}),await this.render()):this.item.update({"system.action_effects":i})}get effects_str(){return JSON.stringify(this.item.system.action_effects.map(e=>$a92622f457efc12a$export$a32b0b1c1ac59d04.to_json(e)))}}async function $438530a2f2c2b115$export$ed3f1528e78b2d0c(e,s){if("Test"!==e.type)return;let a=$ef2b9a9b8ae02095$export$99454b2c58b3846f(e);if(!a)return ui.notifications.warn("You can only create macro buttons for known actors");let i=new $71c9a09ec3eab7ed$export$1b16fc9eb974a84d({actor:a,stat:(e=await $927f0cb3cff0a1f2$export$ed3c1ed9e6e8a483.merge_attack_option(e)).stat||e.score,skill:e.skill,tn:e.tn}).label,r=null;e.skill&&(r=a.items.find(s=>s.name===e.skill&&"skill"===s.type));let n=JSON.stringify(e,null,4),o=`game.sagamachine.sm_test_macro(${n});`,c=game.macros.find(e=>e.name===i&&e.command===o),l={name:i,type:"script",command:o,flags:{"sagamachine.sm_test_macro":!0}};return r&&(l.img=r.img),c||(c=await Macro.create(l)),await game.user.assignHotbarMacro(c,s),!1}async function $438530a2f2c2b115$export$4ae6666db41501cf(e){let s=$ef2b9a9b8ae02095$export$99454b2c58b3846f(e);if(!s){let a=ChatMessage.getSpeaker();a.token&&(s=game.actors.tokens[a.token]),s||(s=game.actors.get(a.actor)),e.uuid=s.uuid}await $71c9a09ec3eab7ed$export$5803ef6f71bdd50f(e)}async function $8a535ffa3223d54f$export$3d7f02c9b93e6b0(e){if(!e.find(".damage").length)return;let s=!!e.find(".critical").length,a=[];e.find(".damage").each((e,i)=>{let r=Number($(i).text()),n=$(i).parent().find(".damage-type").text(),o=Number($(i).data("pierce"))||0;a.push({damage:r,damageType:n,critical:s,pierce:o}),s=!1}),e[0].setAttribute("draggable",!0),e[0].addEventListener("dragstart",e=>{e.currentTarget.dataset.hits=JSON.stringify(a),e.dataTransfer.setData("text/plain",JSON.stringify({hits:a}))},!1)}async function $8a535ffa3223d54f$export$a54b240a5cfd4caf(e,s){if(s.hits)for(let a of s.hits)await e.apply_damage(a.damage,a.damageType,a.critical,a.pierce)}async function $8a535ffa3223d54f$export$d9445ce8959d2e19(e){e.push({name:"Push Your Luck",icon:'<i class="fas fa-dice"></i>',condition:e=>!!$(e).find(".test-json").length,callback:async e=>{let s=$(e),a=$71c9a09ec3eab7ed$export$1b16fc9eb974a84d.from_json(JSON.parse(s.find(".test-json").val()));return a?.actor?.isOwner?a?.actor?.system?.scores?.luck?.value<=0?ui.notifications.warn("The character doesn't have enough Luck."):void(a.boons++,$ef2b9a9b8ae02095$export$33dec5772ae42010("stress",!1)&&a.stress_boons++,a.use_luck=!0,await a.evaluate(),a.actor.update({"system.scores.luck.value":a.actor.system.scores.luck.value-1}),await a.apply_effects(),await a.to_chat({whisper:s.hasClass("whisper"),rolls:[a.results]})):ui.notifications.warn("You can't Push Your Luck for this character.")}})}async function $8a535ffa3223d54f$export$220dda78442aea07(e){e.push({name:"Apply Damage",icon:'<i class="fas fa-user-minus"></i>',condition:e=>!!$(e).find(".damage").length,callback:e=>{let s=$(e),a=game?.canvas?.tokens?.controlled;if(!a.length&&game.user.isGM)return void ui.notifications.warn("No valid character selected.");let i=a.filter(e=>e?.document?.actor?.isOwner);for(let e of(!i.length&&game.user.character&&(i=[game.user.character]),i)){let a=e?.document?.actor||e;if(a&&a.isOwner){let e=!!s.find(".critical").length;s.find(".damage").each((s,i)=>{let r=Number($(i).text()),n=$(i).parent().find(".damage-type").text(),o=Number($(i).data("pierce"))||0;a.apply_damage(r,n,e,o),e=!1})}}}})}async function $8a535ffa3223d54f$export$5386e3bdcb090884(e){e.push({name:"Edit Results",icon:'<i class="fa fa-edit"></i>',condition:e=>game.user.isGM,callback:e=>{let s=$(e),a=s.data("messageId"),i=$71c9a09ec3eab7ed$export$1b16fc9eb974a84d.from_json(JSON.parse(s.find(".test-json").val()));new Dialog({title:"Edit Results",content:`
                    <form class="saga-machine">
                        <div class="form-group">
                            <label for="critical">Success</label>
                            <input type="checkbox" name="success" ${i.success?"checked":""}>
                        </div>
                        <div class="form-group">
                            <label for="critical">Critical</label>
                            <input type="checkbox" name="critical" ${i.critical?"checked":""}>
                        </div>
                        <div class="form-group">
                            <label for="value">Margin</label>
                            <input type="number" name="margin" value="${i.margin}" autofocus>
                        </div>
                        <div class="sheet-body">
                            <ol class="items-list consequence-list">
                                <li class="item flexrow items-header consequence-row">
                                    <div class="item-name">Type</div>
                                    <div class="item-name">Value</div>
                                    <div class="item-controls">
                                        <a class="item-control item-create" title="Create effect"><i class="fas fa-plus"></i> Add</a>
                                    </div>
                                </li>
                
                                <li class="item flexrow consequence consequence-row prototype">
                                    <select class="item-input item-name" name="type">
                                        <option value="damage">Damage</option>
                                        <option value="consequence">Consequence</option>
                                        <option value="defense">Defense</option>
                                        <option value="message">Message</option>
                                    </select>
                                    <input class="item-input item-name" type="text" name="value" value="" />
                                    <div class="item-controls">
                                        <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                                    </div>
                                </li>
                            </ol>
                        </div>
                    </form>`,render:e=>{if(i.effects&&i.effects.length){let s=e.find(".consequence.prototype"),a=e.find("ol.consequence-list");for(let e of i.effects){let r=null;switch(e.type){case"consequence":r=e.name;break;case"damage":r=`${Number(e.value)+(Number(e.margin)||Number(i.margin))} ${e.damage_type} ${e.properties}`;break;case"message":r=`${e.key}: ${e.value}`;break;default:r=""}let n=s.clone();n.removeClass("prototype"),n.find("[name=type]").val(e.type),n.find("[name=value]").val(r),a.append(n)}}e.find(".consequence-list .item-create").click(s=>{let a=e.find(".consequence.prototype"),i=e.find("ol.consequence-list");if(!a||!a.length||!i||!i.length)return;let r=a.clone();r.removeClass("prototype"),r.find(".item-delete").click(e=>$(e.currentTarget).closest(".consequence").remove()),i.append(r)}),e.find(".consequence-list .item-delete").click(e=>$(e.currentTarget).closest(".consequence").remove())},buttons:{Edit:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async e=>{i.success=e.find("input[name=success]").is(":checked"),i.critical=e.find("input[name=critical]").is(":checked"),i.margin=Number(e.find("input[name=margin]").val()),i.edited=!0;let s=[];e.find(".consequence:not(.prototype)").each((e,a)=>{let r=$(a).find("select[name=type]").val(),n=$(a).find("input[name=value]").val(),o={};if("consequence"===r)o.name=n.trim();else if("message"===r){let e=n.split(": ");e.length>=2?[o.key,o.value]=[e[0],e[1]]:[o.key,o.value]=["Message",e[0]]}else if("damage"===r){let e=n.split(" ");o.value=Number(e?.[0])-i.margin,o.damage_type=e?.[1],e.length>=3&&(o.properties=$53b5035feb70b083$export$4b017698e4946e33.parse_properties(e.slice(2).join(" ")))}let c=new $a92622f457efc12a$export$a32b0b1c1ac59d04({type:r,...o},i);c.apply(i.success?"success":"failure"),s.push(c),i.effects=s}),await ChatMessage.updateDocuments([{_id:a,content:i.content(),flavor:i.flavor()}],{})}}}}).render({force:!0})}})}async function $bdfaba09eb94a304$export$a6324e54748ebe3(e,s,a,i){game.user.id===i&&"character"===e.type&&await e.encumbrance_consequences(),game.user.id===i&&game.combat&&(game.user.isGM||e.isOwner)&&game.combat.update_combatant_initiative(e,s?.system?.fast_turn)}async function $bdfaba09eb94a304$export$4bf3fd4b252a8de8(e,s,a){game.user.id===a&&e.parent&&"character"===e.parent.type&&"item"===e.type&&await e.parent.encumbrance_consequences(),game.user.id===a&&e.parent&&"item"===e.type&&e.system.parent&&await e.remove_from_container(),game.user.id===a&&"consequence"===e.type&&e.parent&&await $b3d0fcc9cab9bd05$export$bce7246a7036e38(e.parent)}async function $bdfaba09eb94a304$export$38a029996c573874(e,s,a,i){game.user.id===i&&e.parent&&"character"===e.parent.type&&"item"===e.type&&await e.parent.encumbrance_consequences(),game.user.id===i&&"consequence"===e.type&&e.parent&&await $b3d0fcc9cab9bd05$export$bce7246a7036e38(e.parent)}async function $bdfaba09eb94a304$export$4a9b7a56f490dcad(e,s,a){game.user.id===a&&e.parent&&"character"===e.parent.type&&"item"===e.type&&await e.parent.encumbrance_consequences(),game.user.id===a&&"consequence"===e.type&&e.parent&&await $b3d0fcc9cab9bd05$export$bce7246a7036e38(e.parent)}function $bdfaba09eb94a304$export$9dc996de602aaf4f(e,s,a,i){return game.user.id===i&&e.modifiesActor&&e.parent&&"character"===e.parent.type&&e.origin&&$b3d0fcc9cab9bd05$export$7801755dddf1fd51(e),!0}async function $bdfaba09eb94a304$export$d367f85a279edb03(e,s,a){game.user.id===a&&!e.origin&&e.statuses?.size&&e.target&&await $b3d0fcc9cab9bd05$export$31930d543788113d(e),game.user.id===a&&!e.modifiesActor&&e.transfer&&e.parent&&e.parent.parent&&"character"===e.parent.parent.type&&await $b3d0fcc9cab9bd05$export$40b3570d78570c16(e.parent)}async function $bdfaba09eb94a304$export$60945f152bbb5568(e,s,a,i){game.user.id===i&&!e.modifiesActor&&e.transfer&&e.parent&&e.parent.parent&&"character"===e.parent.parent.type&&await $b3d0fcc9cab9bd05$export$40b3570d78570c16(e.parent)}function $bdfaba09eb94a304$export$7e03fe5bbd47fde3(e,s,a){let i=!0;return game.user.id===a&&!e.origin&&e.statuses?.size&&(e?.flags?.system?.subject_prompt||e?.flags?.system?.value_prompt)&&(i&&=$b3d0fcc9cab9bd05$export$df951736c406196b(e)),i}async function $bdfaba09eb94a304$export$3cc25891b8a467f7(e,s,a){game.user.id===a&&!e.origin&&e.statuses?.size&&e.target&&await $b3d0fcc9cab9bd05$export$efd50a08c6cb878d(e),game.user.id===a&&!e.modifiesActor&&e.transfer&&e.parent&&e.parent.parent&&"character"===e.parent.parent.type&&await $b3d0fcc9cab9bd05$export$40b3570d78570c16(e.parent,!0)}async function $bdfaba09eb94a304$export$40058aa05d265e4f(e,s,a,i){game.user.id===i&&s.round&&s.round!==e.round&&await e.start_of_round()}async function $bdfaba09eb94a304$export$b326b618cce92063(e,s,a){await $438530a2f2c2b115$export$ed3f1528e78b2d0c(s,a)}async function $bdfaba09eb94a304$export$e6333a552b7032f3(e,s,a){await $8a535ffa3223d54f$export$3d7f02c9b93e6b0($(s))}async function $bdfaba09eb94a304$export$5c0c0cc3fc780035(e,s,a){await $8a535ffa3223d54f$export$a54b240a5cfd4caf(e,a)}async function $bdfaba09eb94a304$export$61c10505fc99de78(e,s){await $8a535ffa3223d54f$export$d9445ce8959d2e19(s),await $8a535ffa3223d54f$export$220dda78442aea07(s),await $8a535ffa3223d54f$export$5386e3bdcb090884(s)}function $06e5b67bd4d1ea64$export$f4ed8f8c82a836f9(e,s,a){s.default=a,game.settings.register("saga-machine",e,s)}const $06e5b67bd4d1ea64$export$3277948426b5bf5c={name:"Starting Power Level",hint:"The starting power level of all player characters.",scope:"world",config:!0,type:Number,default:120,choices:{85:"Mundane",120:"Novice",160:"Exceptional",200:"Distinguished",240:"Renowned",280:"Legendary",150:"Shadows Over Sol"}},$06e5b67bd4d1ea64$export$bc4c654b208fcde2={name:"Name for Luck",hint:"Luck, Edge, Karma, Moxie, etc.",scope:"world",config:!0,type:String,default:"Luck",choices:{Luck:"Luck",Edge:"Edge",Karma:"Karma",Moxie:"Moxie"}},$06e5b67bd4d1ea64$export$1f55ffeba98e912e={name:"Name for Money",hint:"Money, Coins, Credits, etc.",scope:"world",config:!0,type:String,default:"Money",choices:{Money:"Money",Microcredits:"Microcredits",Dollars:"Dollars","Bronze Pennies":"Bronze Pennies",Coins:"Coins"}},$06e5b67bd4d1ea64$export$44ba513cca23cc31={name:"Name for Origins",hint:"Origins, Genelines, Species, etc.",scope:"world",config:!0,type:String,default:"Origin",choices:{Origin:"Origin",Geneline:"Geneline",Species:"Species",Background:"Background",People:"People"}},$06e5b67bd4d1ea64$export$9b24ff5253e45161={name:"Name for Paths",hint:"Paths, Roles, Careers, etc.",scope:"world",config:!0,type:String,default:"Path",choices:{Path:"Path",Role:"Role",Career:"Career",Archetype:"Archetype"}},$06e5b67bd4d1ea64$export$228ad5dcb372b11={name:"Starting Luck Affects Experience",hint:"Used in Shadows Over Sol",scope:"world",config:!0,type:Boolean,default:!1},$06e5b67bd4d1ea64$export$a0f669c9193be7da={name:"Use Stress & Mental Breaks",hint:"This campaign uses the optional Stress rules.",scope:"world",config:!0,type:Boolean,default:!1},$06e5b67bd4d1ea64$export$34967b20022f14d6={name:"Theme",hint:"The visual theme for character sheets and UI. Requires reload to take effect.",scope:"world",config:!0,type:String,default:"unified",choices:{unified:"Unified",sos:"Shadows Over Sol"},onChange:()=>{window.location.reload()}};function $e5bb71d34bdbe053$export$d2e759d1e37455cc({level:e=100,luck_label:s="Luck",money_label:a="Money",origin_label:i="Origin",path_label:r="Path",luck_exp:n=!1,stress:o=!1,theme:c="unified"}={}){CONFIG.debug.hooks=!0,Hooks.once("init",async()=>{console.log("Initializing Saga Machine"),game.sagamachine={SagaMachineActor:$927f0cb3cff0a1f2$export$c49d3afcc675f1b5,SagaMachineItem:$53b5035feb70b083$export$471af1c74e831048,sm_test_macro:$438530a2f2c2b115$export$4ae6666db41501cf},CONFIG.Actor.documentClass=$927f0cb3cff0a1f2$export$c49d3afcc675f1b5,CONFIG.Item.documentClass=$53b5035feb70b083$export$471af1c74e831048,CONFIG.Combatant.documentClass=$c76bcdf2af710582$export$ca8ad600a8ec4279,CONFIG.Combat.documentClass=$c76bcdf2af710582$export$c9b99f4a745fcbd1,foundry.documents.collections.Actors.unregisterSheet("core",foundry.appv1.sheets.ActorSheet),foundry.documents.collections.Items.unregisterSheet("core",foundry.appv1.sheets.ItemSheet),foundry.documents.collections.Actors.registerSheet("saga-machine",$d6f753df42abb3a6$export$eaa36efd5f1a839,{types:["character"],makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("saga-machine",$d6f753df42abb3a6$export$9059fd0f09215233,{types:["stash"],makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("saga-machine",$d6f753df42abb3a6$export$d55003dbaa27bba5,{types:["vehicle"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$96c1200f91678a19,{types:["skill"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$9f2a24c9f192c221,{types:["trait"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$4169507366d0a707,{types:["origin"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$6f7f838e9b4593fa,{types:["path"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$eff3dd514a394135,{types:["consequence"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$7b63ff0ee2469440,{types:["item"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$f62ad08e7f4ea9c3,{types:["ambition"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$2ff7f2f1b7e19ff4$export$aa81b4e329608703,{types:["action"],makeDefault:!0}),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("level",$06e5b67bd4d1ea64$export$3277948426b5bf5c,e),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("luck_label",$06e5b67bd4d1ea64$export$bc4c654b208fcde2,s),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("money_label",$06e5b67bd4d1ea64$export$1f55ffeba98e912e,a),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("origin_label",$06e5b67bd4d1ea64$export$44ba513cca23cc31,i),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("path_label",$06e5b67bd4d1ea64$export$9b24ff5253e45161,r),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("luck_exp",$06e5b67bd4d1ea64$export$228ad5dcb372b11,n),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("stress",$06e5b67bd4d1ea64$export$a0f669c9193be7da,o),$06e5b67bd4d1ea64$export$f4ed8f8c82a836f9("theme",$06e5b67bd4d1ea64$export$34967b20022f14d6,c);let l=game.settings.get("saga-machine","theme"),d=`${$ef2b9a9b8ae02095$export$8e68967fd29d5cd0()}/styles/${l}.css`,p=document.createElement("link");p.rel="stylesheet",p.type="text/css",p.href=d,document.head.appendChild(p),CONFIG.statusEffects=$b3d0fcc9cab9bd05$export$7065c91b0a27b3b9(),CONFIG.specialStatusEffects.DEFEATED="defeated",CONFIG.specialStatusEffects.INCAPACITATED="unconscious",CONFIG.specialStatusEffects.INVISIBLE="hidden",game.sagamachine.standard_consequences=CONFIG.statusEffects.map(e=>e.name),Hooks.on("updateActor",$bdfaba09eb94a304$export$a6324e54748ebe3),Hooks.on("createItem",$bdfaba09eb94a304$export$4bf3fd4b252a8de8),Hooks.on("updateItem",$bdfaba09eb94a304$export$38a029996c573874),Hooks.on("deleteItem",$bdfaba09eb94a304$export$4a9b7a56f490dcad),Hooks.on("preCreateActiveEffect",$bdfaba09eb94a304$export$9dc996de602aaf4f),Hooks.on("createActiveEffect",$bdfaba09eb94a304$export$d367f85a279edb03),Hooks.on("updateActiveEffect",$bdfaba09eb94a304$export$60945f152bbb5568),Hooks.on("preDeleteActiveEffect",$bdfaba09eb94a304$export$7e03fe5bbd47fde3),Hooks.on("deleteActiveEffect",$bdfaba09eb94a304$export$3cc25891b8a467f7),Hooks.on("preUpdateCombat",$bdfaba09eb94a304$export$40058aa05d265e4f),Hooks.on("hotbarDrop",$bdfaba09eb94a304$export$b326b618cce92063),Hooks.on("renderChatMessageHTML",$bdfaba09eb94a304$export$e6333a552b7032f3),Hooks.on("dropActorSheetData",$bdfaba09eb94a304$export$5c0c0cc3fc780035),Hooks.on("getChatMessageContextOptions",$bdfaba09eb94a304$export$61c10505fc99de78)})}$e5bb71d34bdbe053$export$d2e759d1e37455cc({level:"150",luck_label:"Edge",money_label:"Microcredits",origin_label:"Geneline",path_label:"Role",luck_exp:!0,stress:!0,theme:"sos"});
//# sourceMappingURL=sos2e.js.map
