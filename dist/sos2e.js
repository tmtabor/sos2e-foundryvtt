function $parcel$interopDefault(m){return m&&m.__esModule?m.default:m}function $81dc50ef4a81fbcd$export$9a00dee1beb8f576(m){return m.charAt(0).toUpperCase()+m.slice(1)}function $81dc50ef4a81fbcd$export$99454b2c58b3846f({uuid:m=null,scene_id:x=null,token_id:k=null,actor_id:D=null}){return m?fromUuidSync(m)||null:x&&k?game.scenes.get(x)?.tokens.get(k)?.actor||null:D&&game.actors.get(D)||null}function $81dc50ef4a81fbcd$export$9c490b34b2f16a34(m){let x=Math.floor(m.length/2),k=[...m].sort((m,x)=>m-x);return m.length%2!=0?k[x]:(k[x-1]+k[x])/2}function $81dc50ef4a81fbcd$export$6d905af60429adc0(m){return m[Math.floor(Math.random()*m.length)]}function $81dc50ef4a81fbcd$export$55aae15f3c7dd534(m){if("strength"===m.toLowerCase())return"Str";if("dexterity"===m.toLowerCase())return"Dex";if("speed"===m.toLowerCase())return"Spd";if("endurance"===m.toLowerCase())return"End";if("intelligence"===m.toLowerCase())return"Int";else if("perception"===m.toLowerCase())return"Per";else if("charisma"===m.toLowerCase())return"Chr";else if("determination"===m.toLowerCase())return"Det";else return $81dc50ef4a81fbcd$export$9a00dee1beb8f576(m)}function $81dc50ef4a81fbcd$export$44f4605f44e8fbf2(m,x,k){return(m?$81dc50ef4a81fbcd$export$55aae15f3c7dd534(m):"")+(x?`/${x}`:"")+(k?isNaN(k)?` vs. ${k}`:`-${k}`:"")}function $81dc50ef4a81fbcd$export$260ae3d8e98e4090(){return btoa(Number(1e4*Math.random()).toString()).substring(1,17)}function $81dc50ef4a81fbcd$export$33dec5772ae42010(m,x=null){try{return game.settings.get("saga-machine",m)}catch(m){return x}}let $7c3e2ddbe0c064b6$export$471af1c74e831048=class $7c3e2ddbe0c064b6$export$471af1c74e831048 extends Item{async prepareDerivedData(){super.prepareDerivedData(),this.full_name(),this.actor&&this.actor.isOwner&&this.id&&this.actor.items.get(this.id)&&this.parse_properties()}async _onCreate(m,x,k){await super._onCreate(m,x,k),this.isOwner&&this.id&&m.img===foundry.documents.BaseItem.DEFAULT_ICON&&("skill"===this.type&&this.update({img:"systems/saga-machine/images/defaults/skill.svg"}),"trait"===this.type&&this.update({img:"systems/saga-machine/images/defaults/trait.svg"}),"origin"===this.type&&this.update({img:"systems/saga-machine/images/defaults/origin.svg"}),"path"===this.type&&this.update({img:"systems/saga-machine/images/defaults/path.svg"}),"ambition"===this.type&&this.update({img:"systems/saga-machine/images/defaults/ambition.svg"}),"consequence"===this.type&&this.update({img:"systems/saga-machine/images/defaults/consequence.svg"}),"action"===this.type&&this.update({img:"systems/saga-machine/images/defaults/action.svg"}))}full_name(){let m=this.name+(this.system.specialized?` (${this.system.specialization})`:"");"trait"===this.type&&this.system.ranked&&(m+=` ${this.system.rank}`),this.system.full_name=m}parse_properties(){"item"===this.type&&("string"==typeof this.system.properties&&(this.system.properties=this.system.properties.split(",").map(m=>m.trim())),this.system.container=this.property_value("Container"),this.system.armor=$7c3e2ddbe0c064b6$export$c1ee35a8710d4530.calc_armor(this),this.system.bulky=this.property_value("Bulky"),this.system.parry=this.property_value("Parry"),this.system.powered=this.property_value("Powered"),this.system.hands=this.property_value("Hands")||1,this.system.unit_encumbrance=$7c3e2ddbe0c064b6$export$c1ee35a8710d4530.calc_unit_encumbrance(this),this.system.container_encumbrance=$7c3e2ddbe0c064b6$export$c1ee35a8710d4530.calc_container_encumbrance(this),this.system.encumbrance=$7c3e2ddbe0c064b6$export$c1ee35a8710d4530.calc_encumbrance(this),this.system.unit_loads=$7c3e2ddbe0c064b6$export$c1ee35a8710d4530.calc_unit_loads(this),this.system.loads=$7c3e2ddbe0c064b6$export$c1ee35a8710d4530.calc_loads(this))}property_value(m){for(let x of this.system.properties)if(x.toLowerCase().startsWith(`${m.toLowerCase()} `)){let[m,k]=x.split(" ");return Number(k)}return 0}async remove_from_container(){"item"===this.type&&this.update({"system.parent":null})}};let $7c3e2ddbe0c064b6$export$4b017698e4946e33=class $7c3e2ddbe0c064b6$export$4b017698e4946e33{static parent_action_index(m,x){let k=m?.system?.actions;if(!k)return -1;for(let m=0;m<k.length;m++)if(k[m]._id===x)return m;return -1}static is_power(m){return!!m.properties&&$7c3e2ddbe0c064b6$export$4b017698e4946e33.has_property(m.properties,"Power")}static is_attack(m){return"Defense"===m.tn||"Willpower"===m.tn}static strength_met(m,x=null){x||(x=$81dc50ef4a81fbcd$export$99454b2c58b3846f(m));let k=x?.system?.stats?.strength?.value;if(null==k)return!0;let D=$7c3e2ddbe0c064b6$export$4b017698e4946e33.damage(m),S=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(m.properties),C=$7c3e2ddbe0c064b6$export$4b017698e4946e33.property_value(S,"Str");return $7c3e2ddbe0c064b6$export$4b017698e4946e33.property_value(S,"Hands")>=2?k>=(C||D/2):k>=(C||D)}static damage(m){if(!m.effects)return 0;let x=JSON.parse(m.effects);Array.isArray(x)||(x=[x]);for(let m=0;m<x.length;m++){let k=new $5ba9a332765ece17$export$a32b0b1c1ac59d04(x[m]);if("damage"===k.type)return k.base_damage()}return 0}static is_defense(m){if(!m||!m.length)return!1;for(let x=0;x<m.length;x++)if("defense"===m[x].type)return!0;return!1}static merge_modifiers(m,x){return m=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(m),(x=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(x)).concat(m)}static merge_properties(m,x,k=!1){m=$7c3e2ddbe0c064b6$export$4b017698e4946e33.property_set(m);let D=[],S=(x=$7c3e2ddbe0c064b6$export$4b017698e4946e33.property_set(x)).concat(m).filter(m=>!(D.indexOf(m.property)>=0)&&!!D.push(m.property));return k?S.map(m=>`${m.property} ${m.value??""}`.trim()):S}static property_set(m){return $7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(m).map(m=>{let[x,k]=m.split(" ");return{property:x,value:Number(k)||null}})}static parse_properties(m){return"string"==typeof m?m.split(",").map(m=>m.trim()):Array.isArray(m)?m:[]}static property_value(m,x){for(let k of $7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(m))if(k.toLowerCase().startsWith(`${x.toLowerCase()} `)){let[,m]=k.split(" ");return Number(m)}return 0}static has_property(m,x){return $7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(m).map(m=>m.split(" ")[0]).includes(x)}};let $7c3e2ddbe0c064b6$export$c1ee35a8710d4530=class $7c3e2ddbe0c064b6$export$c1ee35a8710d4530{static calc_unit_encumbrance(m){if(m.system.load)return 100;if(m.system.properties.includes("Neg"))return 0;for(let x of m.system.properties){if(x.startsWith("Implant ")||x.startsWith("Software "))return 0;if(x.startsWith("Big ")){let[m,k]=x.split(" ");return Number(k)}}return 1}static calc_unit_loads(m){return m.system.unit_encumbrance/100}static calc_container_encumbrance(m){return m.system.unit_encumbrance*m.system.quantity}static calc_encumbrance(m){return!m.system.carried||m.system.parent||m.system.equipped&&m.system.properties.includes("Worn")?0:m.system.unit_encumbrance*m.system.quantity}static calc_loads(m){return Math.floor(m.system.unit_loads*m.system.quantity)}static calc_armor(m){return"Armors"!==m.system.group?0:Number.isFinite(parseInt(m.system.uses))?parseInt(m.system.uses):m.property_value("Armor")||0}};let $5ba9a332765ece17$export$a32b0b1c1ac59d04=class $5ba9a332765ece17$export$a32b0b1c1ac59d04{test=null;type=null;target="self";when="always";message="";static IGNORES_ALL_ARMOR=-1;constructor(m,x=null){Object.assign(this,m),x&&(this.test=x),this.validate(m)}validate(){if(!["consequence","damage","defense","message"].includes(this.type))throw`Unknown type ${this.type}`}right_time(m){return"always"===this.when||this.when===m}format_message(m,x){return`<div><strong>${m}:</strong> ${x}</div>`}effect(){return"damage"===this.type?`${this.value} ${this.damage_type}`:"consequence"===this.type?this.name:"Special"}consequence_link(m=null){m||(m=this.name);let x=game.items.filter(x=>"consequence"===x.type&&x.name===m);return x&&x.length?`<a class="content-link" draggable="true" data-link="" data-uuid="${x[0].uuid}" data-id="${x[0].id}" data-type="Item" data-tooltip="Item"><i class="fas fa-suitcase"></i>${m}</a>`:m}base_damage(){let m=0,x=String(this.value).toLowerCase();return x.includes("@str")&&(m+=Number(this?.test?.actor?.system?.stats?.strength?.value)),x.includes("@dex")&&(m+=Number(this?.test?.actor?.system?.stats?.dexterity?.value)),x.includes("@spd")&&(m+=Number(this?.test?.actor?.system?.stats?.speed?.value)),x.includes("@end")&&(m+=Number(this?.test?.actor?.system?.stats?.endurance?.value)),x.includes("@int")&&(m+=Number(this?.test?.actor?.system?.stats?.intelligence?.value)),x.includes("@per")&&(m+=Number(this?.test?.actor?.system?.stats?.perception?.value)),x.includes("@chr")&&(m+=Number(this?.test?.actor?.system?.stats?.charisma?.value)),x.includes("@det")&&(m+=Number(this?.test?.actor?.system?.stats?.determination?.value)),m+=Number(x=x.replace(/[^\d.-]/g,""))}apply(m="always",x){return x||(x=this),"consequence"===this.type&&this.right_time(m)&&this.apply_consequence(),"damage"===this.type&&this.right_time(m)&&this.apply_damage(x),"defense"===this.type&&this.right_time(m)&&this.apply_defense(),"message"===this.type&&this.right_time(m)&&this.apply_message(),this}apply_message(){this.message=this.format_message(this.key?this.key:"Message",this.value)}apply_consequence(){let m=this.name?this.name:"Unknown",x=this.subject?`${m} (${this.subject})`:m,k=this.consequence_link(x);k||(k=x),this.message=this.format_message("Consequence",k)}apply_damage(m){let x=this.base_damage(),k=this.margin?Number(this.margin):this.test&&this.test.margin?Number(this.test.margin):0;this.properties=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(m.properties);let D=$7c3e2ddbe0c064b6$export$4b017698e4946e33.has_property(this.properties,"Ignores")?$5ba9a332765ece17$export$a32b0b1c1ac59d04.IGNORES_ALL_ARMOR:$7c3e2ddbe0c064b6$export$4b017698e4946e33.property_value(this.properties,"Pierce"),S=x+k;S<0&&(S=0),$7c3e2ddbe0c064b6$export$4b017698e4946e33.has_property(this.properties,"Feeble")&&(S=Math.floor(S/2));let C=this.damage_type?this.damage_type:"";this.message=this.format_message("Damage",`<span class="damage" data-pierce="${D}">${S}</span> <span class="damage-type">${C}</span>`)}apply_defense(){if(!this.test)return;let m=null;"self"===this.target?m=this.test.actor:"target"===this.target&&this.test.target&&(m=this.test.target);let x=m.system.scores.defense.value+this.test.randomizer,k=m.system.scores.willpower.value+this.test.randomizer;m.update({"system.scores.defense.tn":x,"system.scores.defense.roll":this.test.randomizer,"system.scores.defense.parry_on":!1,"system.scores.defense.dodge_on":!1,"system.scores.willpower.tn":k,"system.scores.willpower.roll":this.test.randomizer,"system.scores.willpower.resist_on":!1}),this.message=this.format_message("Defense",`TN ${x}`)+this.format_message("Willpower",`TN ${k}`)}static to_json(m){let x={};for(let[k,D]of Object.entries(m))("string"==typeof D||"number"==typeof D||"boolean"==typeof D||null===D||"properties"===k)&&(x[k]=D);return x}static from_json(m){return new $5ba9a332765ece17$export$a32b0b1c1ac59d04(m)}};let $5ba9a332765ece17$var$Wound=class $5ba9a332765ece17$var$Wound{descriptor;description;constructor(m,x){this.descriptor=m||"",this.description=x||""}};let $5ba9a332765ece17$export$a8bf75e7367c8d41=class $5ba9a332765ece17$export$a8bf75e7367c8d41{static async generate_wound(m,x){let k=new $5ba9a332765ece17$var$Wound;if(x&&"fat"!==m){let m=game.tables.getName("Grave Wounds");if(m)return k.description=(await m.draw()).results[0].text,k.descriptor=k.description.split(":")[0],k;k.descriptor=$81dc50ef4a81fbcd$export$6d905af60429adc0(["grave ","deep ","severe ","critical ","serious ","major "])}switch("fat"!==m&&(k.descriptor+=$81dc50ef4a81fbcd$export$6d905af60429adc0(["arm ","leg ","abdomen ","chest ","head ","neck ","hand ","foot ","knee ","elbow ","forearm ","shin ","side ","back ","cheek ","brow ","shoulder ","hip ","thigh ","groin ","rib ","skull ","face "])),m){case"burn":case"cor":case"fr":case"tox":k.descriptor+=$81dc50ef4a81fbcd$export$6d905af60429adc0(["burn","sore","lesion"]);break;case"cut":k.descriptor+=$81dc50ef4a81fbcd$export$6d905af60429adc0(["slash","cut","slice"]);break;case"fat":k.descriptor+=$81dc50ef4a81fbcd$export$6d905af60429adc0(["tired","weakened","winded"]);break;case"pi":k.descriptor+=$81dc50ef4a81fbcd$export$6d905af60429adc0(["stab","puncture","gash"]);break;case"sm":k.descriptor+=$81dc50ef4a81fbcd$export$6d905af60429adc0(["bruise","trauma","rent"]);break;default:k.descriptor+=$81dc50ef4a81fbcd$export$6d905af60429adc0(["wound","gash","laceration"])}return k}};const $be5000aeda79555a$export$bd4feec9a9a5101a={FAST_TURN:"3",NPC_TURN:"2",SLOW_TURN:"1"};let $be5000aeda79555a$export$ca8ad600a8ec4279=class $be5000aeda79555a$export$ca8ad600a8ec4279 extends Combatant{getInitiativeRoll(m){return this.actor?this.isNPC?this.actor.getInitiativeRoll($be5000aeda79555a$export$bd4feec9a9a5101a.NPC_TURN):this.actor.getInitiativeRoll():new Roll($be5000aeda79555a$export$bd4feec9a9a5101a.NPC_TURN)}getInitiativeValue(){return this.isNPC?Number($be5000aeda79555a$export$bd4feec9a9a5101a.NPC_TURN):this.actor.system.fast_turn?Number($be5000aeda79555a$export$bd4feec9a9a5101a.FAST_TURN):Number($be5000aeda79555a$export$bd4feec9a9a5101a.SLOW_TURN)}};let $be5000aeda79555a$export$c9b99f4a745fcbd1=class $be5000aeda79555a$export$c9b99f4a745fcbd1 extends Combat{async rollInitiative(m,{formula:x=null,updateTurn:k=!0,messageOptions:D={}}={}){let S=[];for(let[k,D]of("string"==typeof m?[m]:m).entries()){let m=this.combatants.get(D);if(!m?.isOwner)continue;let k=m.getInitiativeRoll(x);await k.evaluate(),S.push({_id:D,initiative:k.total})}return S.length&&(await this.updateEmbeddedDocuments("Combatant",S),k&&this.combatant?.id&&await this.update({turn:this.turns.findIndex(m=>m.id===this.combatant?.id)})),this}async update_combatant_initiative(m,x){if(null!=x)for(let x of game.combat.combatants.filter(x=>x.actorId===m.id))await game.combat.setInitiative(x.id,x.getInitiativeValue())}chase_label(m,x=!1){let k=x?m?.system?.scores?.willpower:m?.system?.scores?.defense;if(!k)return'<span class="defense-tn">&mdash;</span>';let D=m.system.scores.defense.roll,S="",C="";switch(D){case 1:S="critical failure",C="If this is a chase, the character encounters an obstacle.";break;case 9:case 10:S="critical success",C="If this is a chase, the character gains a leg up."}return`<span class="defense-tn ${S}" title="${C}">${k.tn}</span>`}async start_of_round(){let new_round=async m=>{for(let m of(await this.rollAll(),this.combatants))"character"===m.actor.type&&await m.actor.test({stat:"defense",effects:[{type:"defense"}],whisper:!0,chat:!0,...m.actor.total_modifiers({score:"defense"})});let x=`<h3>Round ${this.round}</h3><p><strong>Choose a Fast or Slow turn now!</strong></p><table class="sm-table">`;for(let m of this.combatants){if(m.hidden)continue;let k=Array.from(m.actor.statuses.map(m=>m.split(/\s|-/).map(m=>m.capitalize()).join(" "))).sort().join(", ");x+=`<tr><td><strong>${m.name}</strong></td><td>${k||"&mdash;"}</td></tr>`}for(let m of(x+="</table>",await ChatMessage.create({content:x}),x='<h4><strong>Defenses This Round</strong></h4><table class="sm-table">',this.combatants))x+=`<tr><td><strong>${m.name}</strong></td><td>Defense ${this.chase_label(m.actor)}</td><td>Willpower ${this.chase_label(m.actor,!0)}</td></tr>`;for(let m of(x+="</table>",await ChatMessage.create({content:x,whisper:game.users.filter(m=>m.isGM).map(m=>m.id)}),this.combatants))m.actor.statuses.has("dying")&&!m.actor.statuses.has("defeated")&&(await ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:m.actor}),content:`<p><strong>${m.name} is Dying!</strong></p><ul><li>Limited to 1 AP.</li><li>Making an Endurance test.<ul><li><em>Crit Success:</em> Lose a Dying.</li><li><em>Failure:</em> Gain a Dying.</li><li><em>3 Dying:</em> ${m.name} dies.</li></ul></li></ul>`}),await m.actor.test({stat:"endurance",tn:m.actor.dying_tn(),chat:!0,effects:[{type:"consequence",name:"Dying",when:"failure",target:"self"}],...m.actor.total_modifiers({score:"defense"})})),m.actor.statuses.has("bleeding")&&!m.actor.statuses.has("defeated")&&m.actor.items.filter(m=>"consequence"===m.type&&"Bleeding"===m.name).forEach(x=>{if(x.system.rank>0){let k=new $5ba9a332765ece17$export$a32b0b1c1ac59d04({type:"damage",value:x.system.rank,damage_type:x.system.specialization,properties:"Ignores",when:"always",target:"self"}).apply();ChatMessage.create({speaker:ChatMessage.getSpeaker({actor:m.actor}),content:`<p><strong>${m.name} is Bleeding!</strong></p><ul><li>Right-click and select Apply Damage.</li><li>${k.message}</li></ul>`})}})};new foundry.applications.api.DialogV2({window:{title:"Begin New Round?"},content:"<p>Do you want to begin a new round? Make sure to prompt your players to set their defenses first, if necessary.</p>",buttons:[{action:"yes",label:"Yes",icon:"fas fa-check",callback:new_round},{action:"no",label:"No",icon:"fas fa-times",callback:()=>{}}],default:"yes"}).render({force:!0})}};Hooks.on("renderCombatTracker",(m,x)=>{try{let k=m.viewed?.combatants,D=x instanceof HTMLElement?x:x?.[0]??null;if(!D||!k)return;D.querySelectorAll(".combatant").forEach(m=>{let x=m.getAttribute("data-combatant-id"),D=k.get(x);if(!D)return;let S=D.isNPC?"NPC":D.actor?.system?.fast_turn?"FAST":"SLOW",C=m.querySelector(".token-initiative");C&&(C.innerHTML=`<a class="combatant-control dlturnorder" title="Change Turn">${S}</a>`)}),D.querySelectorAll(".dlturnorder").forEach(x=>{x.addEventListener("click",async x=>{x.preventDefault();let D=x.currentTarget instanceof Element?x.currentTarget.closest("li"):null,S=D?.dataset?.combatantId;if(!S)return;let C=k.get(S);C&&!C.isNPC&&(game.user.isGM||C.actor?.isOwner)&&(await C.actor.update({"system.fast_turn":!C.actor.system.fast_turn}),m.viewed&&m.viewed.setupTurns())})})}catch(m){console.error("SagaMachine renderCombatTracker hook error:",m)}});var $0a478c99c1d3517f$exports={};$0a478c99c1d3517f$exports=function(){"use strict";function t1(m,x){var k=Object.keys(m);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(m);x&&(D=D.filter(function(x){return Object.getOwnPropertyDescriptor(m,x).enumerable})),k.push.apply(k,D)}return k}function e(m){for(var x=1;x<arguments.length;x++){var k=null!=arguments[x]?arguments[x]:{};x%2?t1(Object(k),!0).forEach(function(x){i(m,x,k[x])}):Object.getOwnPropertyDescriptors?Object.defineProperties(m,Object.getOwnPropertyDescriptors(k)):t1(Object(k)).forEach(function(x){Object.defineProperty(m,x,Object.getOwnPropertyDescriptor(k,x))})}return m}function i(m,x,k){var D;return(x="symbol"==typeof(D=function(m,x){if("object"!=typeof m||null===m)return m;var k=m[Symbol.toPrimitive];if(void 0!==k){var D=k.call(m,x||"default");if("object"!=typeof D)return D;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===x?String:Number)(m)}(x,"string"))?D:String(D))in m?Object.defineProperty(m,x,{value:k,enumerable:!0,configurable:!0,writable:!0}):m[x]=k,m}let a=(m,x,k,D)=>(m=""+m,x=""+x,D&&(m=m.trim(),x=x.trim()),k?m==x:m.toLowerCase()==x.toLowerCase()),n=(m,x)=>m&&Array.isArray(m)&&m.map(m=>o(m,x));function o(m,x){var k,D={};for(k in m)0>x.indexOf(k)&&(D[k]=m[k]);return D}function r(m){var x=document.createElement("div");return m.replace(/\&#?[0-9a-z]+;/gi,function(m){return x.innerHTML=m,x.innerText})}function l(m){return(new DOMParser).parseFromString(m.trim(),"text/html").body.firstElementChild}function d(m,x){for(x=x||"previous";m=m[x+"Sibling"];)if(3==m.nodeType)return m}function h(m){return"string"==typeof m?m.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/`|'/g,"&#039;"):m}function g(m){var x=Object.prototype.toString.call(m).split(" ")[1].slice(0,-1);return m===Object(m)&&"Array"!=x&&"Function"!=x&&"RegExp"!=x&&"HTMLUnknownElement"!=x}function p(m,x,k){function s(m,x){for(var k in x)if(x.hasOwnProperty(k)){if(g(x[k])){g(m[k])?s(m[k],x[k]):m[k]=Object.assign({},x[k]);continue}if(Array.isArray(x[k])){m[k]=Object.assign([],x[k]);continue}m[k]=x[k]}}return m instanceof Object||(m={}),s(m,x),k&&s(m,k),m}function c(){let m=[],x={};for(let k of arguments)for(let D of k)g(D)?x[D.value]||(m.push(D),x[D.value]=1):m.includes(D)||m.push(D);return m}function u(m){return String.prototype.normalize?"string"==typeof m?m.normalize("NFD").replace(/[\u0300-\u036f]/g,""):void 0:m}function v(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,m=>(m^crypto.getRandomValues(new Uint8Array(1))[0]&15>>m/4).toString(16))}function f(m){return m&&m.classList&&m.classList.contains(this.settings.classNames.tag)}function T(m,x){var k=window.getSelection();return x=x||k.getRangeAt(0),"string"==typeof m&&(m=document.createTextNode(m)),x&&(x.deleteContents(),x.insertNode(m)),m}function w(m,x,k){return m?(x&&(m.__tagifyTagData=k?x:p({},m.__tagifyTagData||{},x)),m.__tagifyTagData):(console.warn("tag element doesn't exist",m,x),x)}function b(m){if(m&&m.parentNode){var x=window.getSelection(),k=x.getRangeAt(0);x.rangeCount&&(k.setStartAfter(m),k.collapse(!0),x.removeAllRanges(),x.addRange(k))}}function y(m,x){m.forEach(m=>{if(w(m.previousSibling)||!m.previousSibling){var k=document.createTextNode("​");m.before(k),x&&b(k)}})}var m={delimiters:",",pattern:null,tagTextProp:"value",maxTags:1/0,callbacks:{},addTagOnBlur:!0,onChangeAfterBlur:!0,duplicates:!1,whitelist:[],blacklist:[],enforceWhitelist:!1,userInput:!0,keepInvalidTags:!1,createInvalidTags:!0,mixTagsAllowedAfter:/,|\.|\:|\s/,mixTagsInterpolator:["[[","]]"],backspace:!0,skipInvalid:!1,pasteAsTags:!0,editTags:{clicks:2,keepInvalid:!0},transformTag:()=>{},trim:!0,a11y:{focusableTags:!1},mixMode:{insertAfterTag:" "},autoComplete:{enabled:!0,rightKey:!1},classNames:{namespace:"tagify",mixMode:"tagify--mix",selectMode:"tagify--select",input:"tagify__input",focus:"tagify--focus",tagNoAnimation:"tagify--noAnim",tagInvalid:"tagify--invalid",tagNotAllowed:"tagify--notAllowed",scopeLoading:"tagify--loading",hasMaxTags:"tagify--hasMaxTags",hasNoTags:"tagify--noTags",empty:"tagify--empty",inputInvalid:"tagify__input--invalid",dropdown:"tagify__dropdown",dropdownWrapper:"tagify__dropdown__wrapper",dropdownHeader:"tagify__dropdown__header",dropdownFooter:"tagify__dropdown__footer",dropdownItem:"tagify__dropdown__item",dropdownItemActive:"tagify__dropdown__item--active",dropdownItemHidden:"tagify__dropdown__item--hidden",dropdownInital:"tagify__dropdown--initial",tag:"tagify__tag",tagText:"tagify__tag-text",tagX:"tagify__tag__removeBtn",tagLoading:"tagify__tag--loading",tagEditing:"tagify__tag--editable",tagFlash:"tagify__tag--flash",tagHide:"tagify__tag--hide"},dropdown:{classname:"",enabled:2,maxItems:10,searchKeys:["value","searchBy"],fuzzySearch:!0,caseSensitive:!1,accentedSearch:!0,includeSelectedTags:!1,highlightFirst:!1,closeOnSelect:!0,clearOnSelect:!0,position:"all",appendTarget:null},hooks:{beforeRemoveTag:()=>Promise.resolve(),beforePaste:()=>Promise.resolve(),suggestionClick:()=>Promise.resolve()}};function O(){for(let m in this.dropdown={},this._dropdown)this.dropdown[m]="function"==typeof this._dropdown[m]?this._dropdown[m].bind(this):this._dropdown[m];this.dropdown.refs()}let x="@yaireo/tagify/";var k,D={empty:"empty",exceed:"number of tags exceeded",pattern:"pattern mismatch",duplicate:"already exists",notAllowed:"not allowed"};function _(m,k){var D;let S,C;if(!m){console.warn("Tagify:","input element not found",m);let x=new Proxy(this,{get:()=>()=>x});return x}if(m.__tagify)return console.warn("Tagify: ","input element is already Tagified - Same instance is returned.",m),m.__tagify;p(this,function(m){var x=document.createTextNode("");function i(m,k,D){D&&k.split(/\s+/g).forEach(k=>x[m+"EventListener"].call(x,k,D))}return{off(m,x){return i("remove",m,x),this},on(m,x){return x&&"function"==typeof x&&i("add",m,x),this},trigger(k,D,S){var C;if(S=S||{cloneData:!0},k)if(m.settings.isJQueryPlugin)"remove"==k&&(k="removeTag"),jQuery(m.DOM.originalInput).triggerHandler(k,[D]);else{try{var N="object"==typeof D?D:{value:D};if((N=S.cloneData?p({},N):N).tagify=this,D.event&&(N.event=this.cloneEvent(D.event)),D instanceof Object)for(var I in D)D[I]instanceof HTMLElement&&(N[I]=D[I]);C=new CustomEvent(k,{detail:N})}catch(m){console.warn(m)}x.dispatchEvent(C)}}}}(this)),this.isFirefox=/firefox|fxios/i.test(navigator.userAgent)&&!/seamonkey/i.test(navigator.userAgent),this.isIE=window.document.documentMode,k=k||{},this.getPersistedData=(D=k.id,m=>{let k;if(1==localStorage.getItem(x+D+"/v",1))try{k=JSON.parse(localStorage[x+D+"/"+m])}catch(m){}return k}),this.setPersistedData=(S=k.id)?(localStorage.setItem(x+S+"/v",1),(m,k)=>{let D=JSON.stringify(m);m&&k&&(localStorage.setItem(x+S+"/"+k,D),dispatchEvent(new Event("storage")))}):()=>{},this.clearPersistedData=(C=k.id,m=>{let k=x+"/"+C+"/";if(m)localStorage.removeItem(k+m);else for(let m in localStorage)m.includes(k)&&localStorage.removeItem(m)}),this.applySettings(m,k),this.state={inputText:"",editing:!1,composing:!1,actions:{},mixMode:{},dropdown:{},flaggedTags:{}},this.value=[],this.listeners={},this.DOM={},this.build(m),O.call(this),this.getCSSVars(),this.loadOriginalValues(),this.events.customBinding.call(this),this.events.binding.call(this),m.autofocus&&this.DOM.input.focus(),m.__tagify=this}return _.prototype={_dropdown:{refs(){this.DOM.dropdown=this.parseTemplate("dropdown",[this.settings]),this.DOM.dropdown.content=this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-wrapper']")},getHeaderRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-header']")},getFooterRef(){return this.DOM.dropdown.querySelector("[data-selector='tagify-suggestions-footer']")},getAllSuggestionsRefs(){return[...this.DOM.dropdown.content.querySelectorAll(this.settings.classNames.dropdownItemSelector)]},show(m){var x,k,D,S=this.settings,C="mix"==S.mode&&!S.enforceWhitelist,N=!S.whitelist||!S.whitelist.length,I="manual"==S.dropdown.position;if(m=void 0===m?this.state.inputText:m,!(N&&!C&&!S.templates.dropdownItemNoMatch||!1===S.dropdown.enable||this.state.isLoading||this.settings.readonly)){if(clearTimeout(this.dropdownHide__bindEventsTimeout),this.suggestedListItems=this.dropdown.filterListItems(m),m&&!this.suggestedListItems.length&&(this.trigger("dropdown:noMatch",m),S.templates.dropdownItemNoMatch&&(D=S.templates.dropdownItemNoMatch.call(this,{value:m}))),!D){if(this.suggestedListItems.length)m&&C&&!this.state.editing.scope&&!a(this.suggestedListItems[0].value,m)&&this.suggestedListItems.unshift({value:m});else{if(!m||!C||this.state.editing.scope)return this.input.autocomplete.suggest.call(this),void this.dropdown.hide();this.suggestedListItems=[{value:m}]}k=""+(g(x=this.suggestedListItems[0])?x.value:x),S.autoComplete&&k&&0==k.indexOf(m)&&this.input.autocomplete.suggest.call(this,x)}this.dropdown.fill(D),S.dropdown.highlightFirst&&this.dropdown.highlightOption(this.DOM.dropdown.content.querySelector(S.classNames.dropdownItemSelector)),this.state.dropdown.visible||setTimeout(this.dropdown.events.binding.bind(this)),this.state.dropdown.visible=m||!0,this.state.dropdown.query=m,this.setStateSelection(),I||setTimeout(()=>{this.dropdown.position(),this.dropdown.render()}),setTimeout(()=>{this.trigger("dropdown:show",this.DOM.dropdown)})}},hide(m){var x=this.DOM,k=x.scope,D=x.dropdown,S="manual"==this.settings.dropdown.position&&!m;if(D&&document.body.contains(D)&&!S)return window.removeEventListener("resize",this.dropdown.position),this.dropdown.events.binding.call(this,!1),k.setAttribute("aria-expanded",!1),D.parentNode.removeChild(D),setTimeout(()=>{this.state.dropdown.visible=!1},100),this.state.dropdown.query=this.state.ddItemData=this.state.ddItemElm=this.state.selection=null,this.state.tag&&this.state.tag.value.length&&(this.state.flaggedTags[this.state.tag.baseOffset]=this.state.tag),this.trigger("dropdown:hide",D),this},toggle(m){this.dropdown[this.state.dropdown.visible&&!m?"hide":"show"]()},render(){var m,x,k=((x=this.DOM.dropdown.cloneNode(!0)).style.cssText="position:fixed; top:-9999px; opacity:0",document.body.appendChild(x),m=x.clientHeight,x.parentNode.removeChild(x),m),D=this.settings;return"number"==typeof D.dropdown.enabled&&D.dropdown.enabled>=0&&(this.DOM.scope.setAttribute("aria-expanded",!0),document.body.contains(this.DOM.dropdown)||(this.DOM.dropdown.classList.add(D.classNames.dropdownInital),this.dropdown.position(k),D.dropdown.appendTarget.appendChild(this.DOM.dropdown),setTimeout(()=>this.DOM.dropdown.classList.remove(D.classNames.dropdownInital)))),this},fill(m){m="string"==typeof m?m:this.dropdown.createListHTML(m||this.suggestedListItems);var x=this.settings.templates.dropdownContent.call(this,m);this.DOM.dropdown.content.innerHTML=x?x.replace(/\>[\r\n ]+\</g,"><").split(/>\s+</).join("><").trim():""},fillHeaderFooter(){var m=this.dropdown.filterListItems(this.state.dropdown.query),x=this.parseTemplate("dropdownHeader",[m]),k=this.parseTemplate("dropdownFooter",[m]),D=this.dropdown.getHeaderRef(),S=this.dropdown.getFooterRef();x&&D?.parentNode.replaceChild(x,D),k&&S?.parentNode.replaceChild(k,S)},refilter(m){m=m||this.state.dropdown.query||"",this.suggestedListItems=this.dropdown.filterListItems(m),this.dropdown.fill(),this.suggestedListItems.length||this.dropdown.hide(),this.trigger("dropdown:updated",this.DOM.dropdown)},position(m){var x=this.settings.dropdown;if("manual"!=x.position){var k,D,S,C,N,I,M=this.DOM.dropdown,E=x.placeAbove,A=x.appendTarget===document.body,L=A?window.pageYOffset:x.appendTarget.scrollTop,P=document.fullscreenElement||document.webkitFullscreenElement||document.documentElement,R=P.clientHeight,q=Math.max(P.clientWidth||0,window.innerWidth||0)>480?x.position:"all",V=this.DOM["input"==q?"input":"scope"];if(m=m||M.clientHeight,this.state.dropdown.visible){if("text"==q?(S=(k=function(){let m=document.getSelection();if(m.rangeCount){let x,k,D=m.getRangeAt(0),S=D.startContainer,C=D.startOffset;if(C>0)return(k=document.createRange()).setStart(S,C-1),k.setEnd(S,C),{left:(x=k.getBoundingClientRect()).right,top:x.top,bottom:x.bottom};if(S.getBoundingClientRect)return S.getBoundingClientRect()}return{left:-9999,top:-9999}}()).bottom,D=k.top,C=k.left,N="auto"):(I=function(m){for(var x=0,k=0;m&&m!=P;)x+=m.offsetLeft||0,k+=m.offsetTop||0,m=m.parentNode;return{left:x,top:k}}(x.appendTarget),D=(k=V.getBoundingClientRect()).top-I.top,S=k.bottom-1-I.top,C=k.left-I.left,N=k.width+"px"),!A){let m=function(){for(var m=0,k=x.appendTarget.parentNode;k;)m+=k.scrollTop||0,k=k.parentNode;return m}();D+=m,S+=m}D=Math.floor(D),S=Math.ceil(S),E=void 0===E?R-k.bottom<m:E,M.style.cssText="left:"+(C+window.pageXOffset)+"px; width:"+N+";"+(E?"top: "+(D+L)+"px":"top: "+(S+L)+"px"),M.setAttribute("placement",E?"top":"bottom"),M.setAttribute("position",q)}}},events:{binding(){let m=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var x=this.dropdown.events.callbacks,k=this.listeners.dropdown=this.listeners.dropdown||{position:this.dropdown.position.bind(this,null),onKeyDown:x.onKeyDown.bind(this),onMouseOver:x.onMouseOver.bind(this),onMouseLeave:x.onMouseLeave.bind(this),onClick:x.onClick.bind(this),onScroll:x.onScroll.bind(this)},D=m?"addEventListener":"removeEventListener";"manual"!=this.settings.dropdown.position&&(document[D]("scroll",k.position,!0),window[D]("resize",k.position),window[D]("keydown",k.onKeyDown)),this.DOM.dropdown[D]("mouseover",k.onMouseOver),this.DOM.dropdown[D]("mouseleave",k.onMouseLeave),this.DOM.dropdown[D]("mousedown",k.onClick),this.DOM.dropdown.content[D]("scroll",k.onScroll)},callbacks:{onKeyDown(m){if(this.state.hasFocus&&!this.state.composing){var x=this.DOM.dropdown.querySelector(this.settings.classNames.dropdownItemActiveSelector),k=this.dropdown.getSuggestionDataByNode(x);switch(m.key){case"ArrowDown":case"ArrowUp":case"Down":case"Up":m.preventDefault();var D=this.dropdown.getAllSuggestionsRefs(),S="ArrowUp"==m.key||"Up"==m.key;x&&(x=this.dropdown.getNextOrPrevOption(x,!S)),x&&x.matches(this.settings.classNames.dropdownItemSelector)||(x=D[S?D.length-1:0]),this.dropdown.highlightOption(x,!0);break;case"Escape":case"Esc":this.dropdown.hide();break;case"ArrowRight":if(this.state.actions.ArrowLeft)return;case"Tab":if("mix"!=this.settings.mode&&x&&!this.settings.autoComplete.rightKey&&!this.state.editing){m.preventDefault();var C=this.dropdown.getMappedValue(k);return this.input.autocomplete.set.call(this,C),!1}return!0;case"Enter":m.preventDefault(),this.settings.hooks.suggestionClick(m,{tagify:this,tagData:k,suggestionElm:x}).then(()=>{x?(this.dropdown.selectOption(x),x=this.dropdown.getNextOrPrevOption(x,!S),this.dropdown.highlightOption(x)):(this.dropdown.hide(),"mix"!=this.settings.mode&&this.addTags(this.state.inputText.trim(),!0))}).catch(m=>m);break;case"Backspace":{if("mix"==this.settings.mode||this.state.editing.scope)return;let m=this.input.raw.call(this);""!=m&&8203!=m.charCodeAt(0)||(!0===this.settings.backspace?this.removeTags():"edit"==this.settings.backspace&&setTimeout(this.editTag.bind(this),0))}}}},onMouseOver(m){var x=m.target.closest(this.settings.classNames.dropdownItemSelector);x&&this.dropdown.highlightOption(x)},onMouseLeave(m){this.dropdown.highlightOption()},onClick(m){if(0==m.button&&m.target!=this.DOM.dropdown&&m.target!=this.DOM.dropdown.content){var x=m.target.closest(this.settings.classNames.dropdownItemSelector),k=this.dropdown.getSuggestionDataByNode(x);this.state.actions.selectOption=!0,setTimeout(()=>this.state.actions.selectOption=!1,50),this.settings.hooks.suggestionClick(m,{tagify:this,tagData:k,suggestionElm:x}).then(()=>{x?this.dropdown.selectOption(x,m):this.dropdown.hide()}).catch(m=>console.warn(m))}},onScroll(m){var x=m.target,k=x.scrollTop/(x.scrollHeight-x.parentNode.clientHeight)*100;this.trigger("dropdown:scroll",{percentage:Math.round(k)})}}},getSuggestionDataByNode(m){var x=m&&m.getAttribute("value");return this.suggestedListItems.find(m=>m.value==x)||null},getNextOrPrevOption(m){let x=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var k=this.dropdown.getAllSuggestionsRefs(),D=k.findIndex(x=>x===m);return x?k[D+1]:k[D-1]},highlightOption(m,x){var k,D=this.settings.classNames.dropdownItemActive;(this.state.ddItemElm&&(this.state.ddItemElm.classList.remove(D),this.state.ddItemElm.removeAttribute("aria-selected")),m)?(k=this.dropdown.getSuggestionDataByNode(m),this.state.ddItemData=k,this.state.ddItemElm=m,m.classList.add(D),m.setAttribute("aria-selected",!0),x&&(m.parentNode.scrollTop=m.clientHeight+m.offsetTop-m.parentNode.clientHeight),this.settings.autoComplete&&(this.input.autocomplete.suggest.call(this,k),this.dropdown.position())):(this.state.ddItemData=null,this.state.ddItemElm=null,this.input.autocomplete.suggest.call(this))},selectOption(m,x){var k=this.settings.dropdown,D=k.clearOnSelect,S=k.closeOnSelect;if(!m)return this.addTags(this.state.inputText,!0),void(S&&this.dropdown.hide());x=x||{};var C=m.getAttribute("value"),N=this.suggestedListItems.find(m=>(m.value??m)==C);this.trigger("dropdown:select",{data:N,elm:m,event:x}),C&&(N||"noMatch"==C)?(this.state.editing?this.onEditTagDone(null,p({__isValid:!0},this.normalizeTags([N])[0])):this["mix"==this.settings.mode?"addMixTags":"addTags"]([N||this.input.raw.call(this)],D),this.DOM.input.parentNode&&(setTimeout(()=>{this.DOM.input.focus(),this.toggleFocusClass(!0)}),S&&setTimeout(this.dropdown.hide.bind(this)),m.addEventListener("transitionend",()=>{this.dropdown.fillHeaderFooter(),setTimeout(()=>m.remove(),100)},{once:!0}),m.classList.add(this.settings.classNames.dropdownItemHidden))):S&&setTimeout(this.dropdown.hide.bind(this))},selectAll(m){this.suggestedListItems.length=0,this.dropdown.hide(),this.dropdown.filterListItems("");var x=this.dropdown.filterListItems("");return m||(x=this.state.dropdown.suggestions),this.addTags(x,!0),this},filterListItems(m,x){var k,D,S,C,N,I=this.settings,M=I.dropdown,E=(x=x||{},[]),A=[],L=I.whitelist,P=M.maxItems>=0?M.maxItems:1/0,R=M.searchKeys,q=0;if(!(m="select"==I.mode&&this.value.length&&this.value[0][I.tagTextProp]==m?"":m)||!R.length)return E=M.includeSelectedTags?L:L.filter(m=>!this.isTagDuplicate(g(m)?m.value:m)),this.state.dropdown.suggestions=E,E.slice(0,P);function f(m,x){return x.toLowerCase().split(" ").every(x=>m.includes(x.toLowerCase()))}for(N=M.caseSensitive?""+m:(""+m).toLowerCase();q<L.length;q++){let m,I,P=Object.keys(k=L[q]instanceof Object?L[q]:{value:L[q]}).some(m=>R.includes(m))?R:["value"];M.fuzzySearch&&!x.exact?(S=P.reduce((m,x)=>m+" "+(k[x]||""),"").toLowerCase().trim(),M.accentedSearch&&(S=u(S),N=u(N)),m=0==S.indexOf(N),I=S===N,D=f(S,N)):(m=!0,D=P.some(m=>{var D=""+(k[m]||"");return M.accentedSearch&&(D=u(D),N=u(N)),M.caseSensitive||(D=D.toLowerCase()),I=D===N,x.exact?D===N:0==D.indexOf(N)})),C=!M.includeSelectedTags&&this.isTagDuplicate(g(k)?k.value:k),D&&!C&&(I&&m?A.push(k):"startsWith"==M.sortby&&m?E.unshift(k):E.push(k))}return this.state.dropdown.suggestions=A.concat(E),"function"==typeof M.sortby?M.sortby(A.concat(E),N):A.concat(E).slice(0,P)},getMappedValue(m){var x=this.settings.dropdown.mapValueTo;return x?"function"==typeof x?x(m):m[x]||m.value:m.value},createListHTML(m){return p([],m).map((m,x)=>{"string"!=typeof m&&"number"!=typeof m||(m={value:m});var k=this.dropdown.getMappedValue(m);return k="string"==typeof k?h(k):k,this.settings.templates.dropdownItem.apply(this,[e(e({},m),{},{mappedValue:k}),this])}).join("")}},getSetTagData:w,helpers:{sameStr:a,removeCollectionProp:n,omit:o,isObject:g,parseHTML:l,escapeHTML:h,extend:p,concatWithoutDups:c,getUID:v,isNodeTag:f},customEventsList:["change","add","remove","invalid","input","click","keydown","focus","blur","edit:input","edit:beforeUpdate","edit:updated","edit:start","edit:keydown","dropdown:show","dropdown:hide","dropdown:select","dropdown:updated","dropdown:noMatch","dropdown:scroll"],dataProps:["__isValid","__removed","__originalData","__originalHTML","__tagId"],trim(m){return this.settings.trim&&m&&"string"==typeof m?m.trim():m},parseHTML:l,templates:{wrapper:(m,x)=>`<tags class="${x.classNames.namespace} ${x.mode?`${x.classNames[x.mode+"Mode"]}`:""} ${m.className}"
                    ${x.readonly?"readonly":""}
                    ${x.disabled?"disabled":""}
                    ${x.required?"required":""}
                    ${"select"===x.mode?"spellcheck='false'":""}
                    tabIndex="-1">
            <span ${!x.readonly&&x.userInput?"contenteditable":""} tabIndex="0" data-placeholder="${x.placeholder||"&#8203;"}" aria-placeholder="${x.placeholder||""}"
                class="${x.classNames.input}"
                role="textbox"
                aria-autocomplete="both"
                aria-multiline="${"mix"==x.mode}"></span>
                &#8203;
        </tags>`,tag(m,x){let k=x.settings;return`<tag title="${m.title||m.value}"
                    contenteditable='false'
                    spellcheck='false'
                    tabIndex="${k.a11y.focusableTags?0:-1}"
                    class="${k.classNames.tag} ${m.class||""}"
                    ${this.getAttributes(m)}>
            <x title='' class="${k.classNames.tagX}" role='button' aria-label='remove tag'></x>
            <div>
                <span class="${k.classNames.tagText}">${m[k.tagTextProp]||m.value}</span>
            </div>
        </tag>`},dropdown(m){var x=m.dropdown,k="manual"==x.position,D=`${m.classNames.dropdown}`;return`<div class="${k?"":D} ${x.classname}" role="listbox" aria-labelledby="dropdown">
                    <div data-selector='tagify-suggestions-wrapper' class="${m.classNames.dropdownWrapper}"></div>
                </div>`},dropdownContent(m){var x=this.settings,k=this.state.dropdown.suggestions;return`
            ${x.templates.dropdownHeader.call(this,k)}
            ${m}
            ${x.templates.dropdownFooter.call(this,k)}
        `},dropdownItem(m){return`<div ${this.getAttributes(m)}
                    class='${this.settings.classNames.dropdownItem} ${m.class?m.class:""}'
                    tabindex="0"
                    role="option">${m.mappedValue||m.value}</div>`},dropdownHeader(m){return`<header data-selector='tagify-suggestions-header' class="${this.settings.classNames.dropdownHeader}"></header>`},dropdownFooter(m){var x=m.length-this.settings.dropdown.maxItems;return x>0?`<footer data-selector='tagify-suggestions-footer' class="${this.settings.classNames.dropdownFooter}">
                ${x} more items. Refine your search.
            </footer>`:""},dropdownItemNoMatch:null},parseTemplate(m,x){return l((m=this.settings.templates[m]||m).apply(this,x))},set whitelist(t){let m=t&&Array.isArray(t);this.settings.whitelist=m?t:[],this.setPersistedData(m?t:[],"whitelist")},get whitelist(){return this.settings.whitelist},generateClassSelectors(m){for(let x in m){let k=x;Object.defineProperty(m,k+"Selector",{get(){return"."+this[k].split(" ")[0]}})}},applySettings(x,k){m.templates=this.templates;var S=p({},m,"mix"==k.mode?{dropdown:{position:"text"}}:{}),C=this.settings=p({},S,k);if(C.disabled=x.hasAttribute("disabled"),C.readonly=C.readonly||x.hasAttribute("readonly"),C.placeholder=h(x.getAttribute("placeholder")||C.placeholder||""),C.required=x.hasAttribute("required"),this.generateClassSelectors(C.classNames),void 0===C.dropdown.includeSelectedTags&&(C.dropdown.includeSelectedTags=C.duplicates),this.isIE&&(C.autoComplete=!1),["whitelist","blacklist"].forEach(m=>{var k=x.getAttribute("data-"+m);k&&(k=k.split(C.delimiters))instanceof Array&&(C[m]=k)}),"autoComplete"in k&&!g(k.autoComplete)&&(C.autoComplete=m.autoComplete,C.autoComplete.enabled=k.autoComplete),"mix"==C.mode&&(C.pattern=C.pattern||/@/,C.autoComplete.rightKey=!0,C.delimiters=k.delimiters||null,C.tagTextProp&&!C.dropdown.searchKeys.includes(C.tagTextProp)&&C.dropdown.searchKeys.push(C.tagTextProp)),x.pattern)try{C.pattern=new RegExp(x.pattern)}catch(m){}if(C.delimiters){C._delimiters=C.delimiters;try{C.delimiters=RegExp(this.settings.delimiters,"g")}catch(m){}}C.disabled&&(C.userInput=!1),this.TEXTS=e(e({},D),C.texts||{}),("select"!=C.mode||k.dropdown?.enabled)&&C.userInput||(C.dropdown.enabled=0),C.dropdown.appendTarget=k.dropdown?.appendTarget||document.body;let N=this.getPersistedData("whitelist");Array.isArray(N)&&(this.whitelist=Array.isArray(C.whitelist)?c(C.whitelist,N):N)},getAttributes(m){var x,k=this.getCustomAttributes(m),D="";for(x in k)D+=" "+x+(void 0!==m[x]?`="${k[x]}"`:"");return D},getCustomAttributes(m){if(!g(m))return"";var x,k={};for(x in m)"__"!=x.slice(0,2)&&"class"!=x&&m.hasOwnProperty(x)&&void 0!==m[x]&&(k[x]=h(m[x]));return k},setStateSelection(){var m=window.getSelection(),x={anchorOffset:m.anchorOffset,anchorNode:m.anchorNode,range:m.getRangeAt&&m.rangeCount&&m.getRangeAt(0)};return this.state.selection=x,x},getCSSVars(){let m;var x,k=getComputedStyle(this.DOM.scope,null);this.CSSVars={tagHideTransition:(m=(x=function(m){if(!m)return{};var x=(m=m.trim().split(" ")[0]).split(/\d+/g).filter(m=>m).pop().trim();return{value:+m.split(x).filter(m=>m)[0].trim(),unit:x}}(k.getPropertyValue("--tag-hide-transition"))).value,"s"==x.unit?1e3*m:m)}},build(m){var x=this.DOM;this.settings.mixMode.integrated?(x.originalInput=null,x.scope=m,x.input=m):(x.originalInput=m,x.originalInput_tabIndex=m.tabIndex,x.scope=this.parseTemplate("wrapper",[m,this.settings]),x.input=x.scope.querySelector(this.settings.classNames.inputSelector),m.parentNode.insertBefore(x.scope,m),m.tabIndex=-1)},destroy(){this.events.unbindGlobal.call(this),this.DOM.scope.parentNode.removeChild(this.DOM.scope),this.DOM.originalInput.tabIndex=this.DOM.originalInput_tabIndex,delete this.DOM.originalInput.__tagify,this.dropdown.hide(!0),clearTimeout(this.dropdownHide__bindEventsTimeout),clearInterval(this.listeners.main.originalInputValueObserverInterval)},loadOriginalValues(m){var x,k=this.settings;if(this.state.blockChangeEvent=!0,void 0===m){let x=this.getPersistedData("value");m=x&&!this.DOM.originalInput.value?x:k.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value}if(this.removeAllTags(),m)if("mix"==k.mode)this.parseMixTags(m),(x=this.DOM.input.lastChild)&&"BR"==x.tagName||this.DOM.input.insertAdjacentHTML("beforeend","<br>");else{try{JSON.parse(m)instanceof Array&&(m=JSON.parse(m))}catch(m){}this.addTags(m,!0).forEach(m=>m&&m.classList.add(k.classNames.tagNoAnimation))}else this.postUpdate();this.state.lastOriginalValueReported=k.mixMode.integrated?"":this.DOM.originalInput.value},cloneEvent(m){var x={};for(var k in m)"path"!=k&&(x[k]=m[k]);return x},loading(m){return this.state.isLoading=m,this.DOM.scope.classList[m?"add":"remove"](this.settings.classNames.scopeLoading),this},tagLoading(m,x){return m&&m.classList[x?"add":"remove"](this.settings.classNames.tagLoading),this},toggleClass(m,x){"string"==typeof m&&this.DOM.scope.classList.toggle(m,x)},toggleScopeValidation(m){var x=!0===m||void 0===m;!this.settings.required&&m&&m===this.TEXTS.empty&&(x=!0),this.toggleClass(this.settings.classNames.tagInvalid,!x),this.DOM.scope.title=x?"":m},toggleFocusClass(m){this.toggleClass(this.settings.classNames.focus,!!m)},triggerChangeEvent:function(){if(!this.settings.mixMode.integrated){var m=this.DOM.originalInput,x=this.state.lastOriginalValueReported!==m.value,k=new CustomEvent("change",{bubbles:!0});x&&(this.state.lastOriginalValueReported=m.value,k.simulated=!0,m._valueTracker&&m._valueTracker.setValue(Math.random()),m.dispatchEvent(k),this.trigger("change",this.state.lastOriginalValueReported),m.value=this.state.lastOriginalValueReported)}},events:{customBinding(){this.customEventsList.forEach(m=>{this.on(m,this.settings.callbacks[m])})},binding(){let m=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var x,k=this.events.callbacks,D=m?"addEventListener":"removeEventListener";if(!this.state.mainEvents||!m){for(var S in this.state.mainEvents=m,m&&!this.listeners.main&&(this.events.bindGlobal.call(this),this.settings.isJQueryPlugin&&jQuery(this.DOM.originalInput).on("tagify.removeAllTags",this.removeAllTags.bind(this))),x=this.listeners.main=this.listeners.main||{focus:["input",k.onFocusBlur.bind(this)],keydown:["input",k.onKeydown.bind(this)],click:["scope",k.onClickScope.bind(this)],dblclick:["scope",k.onDoubleClickScope.bind(this)],paste:["input",k.onPaste.bind(this)],drop:["input",k.onDrop.bind(this)],compositionstart:["input",k.onCompositionStart.bind(this)],compositionend:["input",k.onCompositionEnd.bind(this)]})this.DOM[x[S][0]][D](S,x[S][1]);clearInterval(this.listeners.main.originalInputValueObserverInterval),this.listeners.main.originalInputValueObserverInterval=setInterval(k.observeOriginalInputValue.bind(this),500);var C=this.listeners.main.inputMutationObserver||new MutationObserver(k.onInputDOMChange.bind(this));C.disconnect(),"mix"==this.settings.mode&&C.observe(this.DOM.input,{childList:!0})}},bindGlobal(m){var x,k=this.events.callbacks,D=m?"removeEventListener":"addEventListener";if(this.listeners&&(m||!this.listeners.global))for(x of(this.listeners.global=this.listeners.global||[{type:this.isIE?"keydown":"input",target:this.DOM.input,cb:k[this.isIE?"onInputIE":"onInput"].bind(this)},{type:"keydown",target:window,cb:k.onWindowKeyDown.bind(this)},{type:"blur",target:this.DOM.input,cb:k.onFocusBlur.bind(this)},{type:"click",target:document,cb:k.onClickAnywhere.bind(this)}],this.listeners.global))x.target[D](x.type,x.cb)},unbindGlobal(){this.events.bindGlobal.call(this,!0)},callbacks:{onFocusBlur(m){var x=this.settings,k=m.target?this.trim(m.target.textContent):"",D=this.value?.[0]?.[x.tagTextProp],S=m.type,C=x.dropdown.enabled>=0,N={relatedTarget:m.relatedTarget},I=this.state.actions.selectOption&&(C||!x.dropdown.closeOnSelect),M=this.state.actions.addNew&&C,E=m.relatedTarget&&f.call(this,m.relatedTarget)&&this.DOM.scope.contains(m.relatedTarget);if("blur"==S){if(m.relatedTarget===this.DOM.scope)return this.dropdown.hide(),void this.DOM.input.focus();this.postUpdate(),x.onChangeAfterBlur&&this.triggerChangeEvent()}if(!I&&!M)if(this.state.hasFocus="focus"==S&&+new Date,this.toggleFocusClass(this.state.hasFocus),"mix"!=x.mode){if("focus"==S)return this.trigger("focus",N),void(0!==x.dropdown.enabled&&x.userInput||this.dropdown.show(this.value.length?"":void 0));"blur"==S&&(this.trigger("blur",N),this.loading(!1),"select"==x.mode&&(E&&(this.removeTags(),k=""),D===k&&(k="")),k&&!this.state.actions.selectOption&&x.addTagOnBlur&&this.addTags(k,!0)),this.DOM.input.removeAttribute("style"),this.dropdown.hide()}else"focus"==S?this.trigger("focus",N):"blur"==m.type&&(this.trigger("blur",N),this.loading(!1),this.dropdown.hide(),this.state.dropdown.visible=void 0,this.setStateSelection())},onCompositionStart(m){this.state.composing=!0},onCompositionEnd(m){this.state.composing=!1},onWindowKeyDown(m){var x,k=document.activeElement,D=f.call(this,k)&&this.DOM.scope.contains(document.activeElement),S=D&&k.hasAttribute("readonly");if(D&&!S)switch(x=k.nextElementSibling,m.key){case"Backspace":this.settings.readonly||(this.removeTags(k),(x||this.DOM.input).focus());break;case"Enter":setTimeout(this.editTag.bind(this),0,k)}},onKeydown(m){var x=this.settings;if(!this.state.composing&&x.userInput){"select"==x.mode&&x.enforceWhitelist&&this.value.length&&"Tab"!=m.key&&m.preventDefault();var D=this.trim(m.target.textContent);if(this.trigger("keydown",{event:m}),"mix"==x.mode){switch(m.key){case"Left":case"ArrowLeft":this.state.actions.ArrowLeft=!0;break;case"Delete":case"Backspace":if(this.state.editing)return;var S=document.getSelection(),C="Delete"==m.key&&S.anchorOffset==(S.anchorNode.length||0),N=S.anchorNode.previousSibling,I=1==S.anchorNode.nodeType||!S.anchorOffset&&N&&1==N.nodeType&&S.anchorNode.previousSibling;r(this.DOM.input.innerHTML);var M,E,A,L=this.getTagElms(),P=1===S.anchorNode.length&&S.anchorNode.nodeValue==String.fromCharCode(8203);if("edit"==x.backspace&&I)return M=1==S.anchorNode.nodeType?null:S.anchorNode.previousElementSibling,setTimeout(this.editTag.bind(this),0,M),void m.preventDefault();if(/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent)&&I instanceof Element)return A=d(I),I.hasAttribute("readonly")||I.remove(),this.DOM.input.focus(),void setTimeout(()=>{b(A),this.DOM.input.click()});if("BR"==S.anchorNode.nodeName)return;if((C||I)&&1==S.anchorNode.nodeType?E=0==S.anchorOffset?C?L[0]:null:L[Math.min(L.length,S.anchorOffset)-1]:C?E=S.anchorNode.nextElementSibling:I instanceof Element&&(E=I),3==S.anchorNode.nodeType&&!S.anchorNode.nodeValue&&S.anchorNode.previousElementSibling&&m.preventDefault(),(I||C)&&!x.backspace||"Range"!=S.type&&!S.anchorOffset&&S.anchorNode==this.DOM.input&&"Delete"!=m.key)return void m.preventDefault();if("Range"!=S.type&&E&&E.hasAttribute("readonly"))return void b(d(E));"Delete"==m.key&&P&&w(S.anchorNode.nextSibling)&&this.removeTags(S.anchorNode.nextSibling),clearTimeout(k),k=setTimeout(()=>{var m=document.getSelection();r(this.DOM.input.innerHTML),C||m.anchorNode.previousSibling,this.value=[].map.call(L,(m,x)=>{var k=w(m);if(m.parentNode||k.readonly)return k;this.trigger("remove",{tag:m,index:x,data:k})}).filter(m=>m)},20)}return!0}switch(m.key){case"Backspace":"select"==x.mode&&x.enforceWhitelist&&this.value.length?this.removeTags():this.state.dropdown.visible&&"manual"!=x.dropdown.position||""!=m.target.textContent&&8203!=D.charCodeAt(0)||(!0===x.backspace?this.removeTags():"edit"==x.backspace&&setTimeout(this.editTag.bind(this),0));break;case"Esc":case"Escape":if(this.state.dropdown.visible)return;m.target.blur();break;case"Down":case"ArrowDown":this.state.dropdown.visible||this.dropdown.show();break;case"ArrowRight":{let m=this.state.inputSuggestion||this.state.ddItemData;if(m&&x.autoComplete.rightKey)return void this.addTags([m],!0);break}case"Tab":{let k="select"==x.mode;if(!D||k)return!0;m.preventDefault()}case"Enter":if(this.state.dropdown.visible&&"manual"!=x.dropdown.position)return;m.preventDefault(),setTimeout(()=>{this.state.dropdown.visible||this.state.actions.selectOption||this.addTags(D,!0)})}}},onInput(m){this.postUpdate();var x=this.settings;if("mix"==x.mode)return this.events.callbacks.onMixTagsInput.call(this,m);var k=this.input.normalize.call(this),D=k.length>=x.dropdown.enabled,S={value:k,inputElm:this.DOM.input},C=this.validateTag({value:k});"select"==x.mode&&this.toggleScopeValidation(C),S.isValid=C,this.state.inputText!=k&&(this.input.set.call(this,k,!1),-1!=k.search(x.delimiters)?this.addTags(k)&&this.input.set.call(this):x.dropdown.enabled>=0&&this.dropdown[D?"show":"hide"](k),this.trigger("input",S))},onMixTagsInput(m){var x,k,D,S,C,N,I,M,E=this.settings,A=this.value.length,L=this.getTagElms(),P=document.createDocumentFragment(),R=window.getSelection().getRangeAt(0),q=[].map.call(L,m=>w(m).value);if("deleteContentBackward"==m.inputType&&/(?=.*chrome)(?=.*android)/i.test(navigator.userAgent)&&this.events.callbacks.onKeydown.call(this,{target:m.target,key:"Backspace"}),y(this.getTagElms()),this.value.slice().forEach(m=>{m.readonly&&!q.includes(m.value)&&P.appendChild(this.createTagElem(m))}),P.childNodes.length&&(R.insertNode(P),this.setRangeAtStartEnd(!1,P.lastChild)),L.length!=A)return this.value=[].map.call(this.getTagElms(),m=>w(m)),void this.update({withoutChangeEvent:!0});if(this.hasMaxTags())return!0;if(window.getSelection&&(N=window.getSelection()).rangeCount>0&&3==N.anchorNode.nodeType){if((R=N.getRangeAt(0).cloneRange()).collapse(!0),R.setStart(N.focusNode,0),D=(x=R.toString().slice(0,R.endOffset)).split(E.pattern).length-1,(k=x.match(E.pattern))&&(S=x.slice(x.lastIndexOf(k[k.length-1]))),S){if(this.state.actions.ArrowLeft=!1,this.state.tag={prefix:S.match(E.pattern)[0],value:S.replace(E.pattern,"")},this.state.tag.baseOffset=N.baseOffset-this.state.tag.value.length,M=this.state.tag.value.match(E.delimiters))return this.state.tag.value=this.state.tag.value.replace(E.delimiters,""),this.state.tag.delimiters=M[0],this.addTags(this.state.tag.value,E.dropdown.clearOnSelect),void this.dropdown.hide();C=this.state.tag.value.length>=E.dropdown.enabled;try{I=(I=this.state.flaggedTags[this.state.tag.baseOffset]).prefix==this.state.tag.prefix&&I.value[0]==this.state.tag.value[0],this.state.flaggedTags[this.state.tag.baseOffset]&&!this.state.tag.value&&delete this.state.flaggedTags[this.state.tag.baseOffset]}catch(m){}(I||D<this.state.mixMode.matchedPatternCount)&&(C=!1)}else this.state.flaggedTags={};this.state.mixMode.matchedPatternCount=D}setTimeout(()=>{this.update({withoutChangeEvent:!0}),this.trigger("input",p({},this.state.tag,{textContent:this.DOM.input.textContent})),this.state.tag&&this.dropdown[C?"show":"hide"](this.state.tag.value)},10)},onInputIE(m){var x=this;setTimeout(function(){x.events.callbacks.onInput.call(x,m)})},observeOriginalInputValue(){this.DOM.originalInput.parentNode||this.destroy(),this.DOM.originalInput.value!=this.DOM.originalInput.tagifyValue&&this.loadOriginalValues()},onClickAnywhere(m){m.target==this.DOM.scope||this.DOM.scope.contains(m.target)||(this.toggleFocusClass(!1),this.state.hasFocus=!1)},onClickScope(m){var x=this.settings,k=m.target.closest("."+x.classNames.tag),D=new Date-this.state.hasFocus;if(m.target!=this.DOM.scope){if(!m.target.classList.contains(x.classNames.tagX))return k?(this.trigger("click",{tag:k,index:this.getNodeIndex(k),data:w(k),event:m}),void(1!==x.editTags&&1!==x.editTags.clicks||this.events.callbacks.onDoubleClickScope.call(this,m))):void(m.target==this.DOM.input&&("mix"==x.mode&&this.fixFirefoxLastTagNoCaret(),D>500)?this.state.dropdown.visible?this.dropdown.hide():0===x.dropdown.enabled&&"mix"!=x.mode&&this.dropdown.show(this.value.length?"":void 0):"select"!=x.mode||0!==x.dropdown.enabled||this.state.dropdown.visible||this.dropdown.show());this.removeTags(m.target.parentNode)}else this.DOM.input.focus()},onPaste(m){m.preventDefault();var x,k,D=this.settings;if("select"==D.mode&&D.enforceWhitelist||!D.userInput)return!1;D.readonly||(k=(x=m.clipboardData||window.clipboardData).getData("Text"),D.hooks.beforePaste(m,{tagify:this,pastedText:k,clipboardData:x}).then(x=>{void 0===x&&(x=k),x&&(this.injectAtCaret(x,window.getSelection().getRangeAt(0)),"mix"==this.settings.mode?this.events.callbacks.onMixTagsInput.call(this,m):this.settings.pasteAsTags?this.addTags(this.state.inputText+x,!0):this.state.inputText=x)}).catch(m=>m))},onDrop(m){m.preventDefault()},onEditTagInput(m,x){var k=m.closest("."+this.settings.classNames.tag),D=this.getNodeIndex(k),S=w(k),C=this.input.normalize.call(this,m),N={[this.settings.tagTextProp]:C,__tagId:S.__tagId},I=this.validateTag(N);this.editTagChangeDetected(p(S,N))||!0!==m.originalIsValid||(I=!0),k.classList.toggle(this.settings.classNames.tagInvalid,!0!==I),S.__isValid=I,k.title=!0===I?S.title||S.value:I,C.length>=this.settings.dropdown.enabled&&(this.state.editing&&(this.state.editing.value=C),this.dropdown.show(C)),this.trigger("edit:input",{tag:k,index:D,data:p({},this.value[D],{newValue:C}),event:x})},onEditTagPaste(m,x){var k=(x.clipboardData||window.clipboardData).getData("Text");x.preventDefault();var D=T(k);this.setRangeAtStartEnd(!1,D)},onEditTagFocus(m){this.state.editing={scope:m,input:m.querySelector("[contenteditable]")}},onEditTagBlur(m){if(this.state.hasFocus||this.toggleFocusClass(),this.DOM.scope.contains(m)){var x,k,D=this.settings,S=m.closest("."+D.classNames.tag),C=w(S),N=this.input.normalize.call(this,m),I={[D.tagTextProp]:N,__tagId:C.__tagId},M=C.__originalData,E=this.editTagChangeDetected(p(C,I)),A=this.validateTag(I);if(N)if(E){if(x=this.hasMaxTags(),k=p({},M,{[D.tagTextProp]:this.trim(N),__isValid:A}),D.transformTag.call(this,k,M),!0!==(A=(!x||!0===M.__isValid)&&this.validateTag(k))){if(this.trigger("invalid",{data:k,tag:S,message:A}),D.editTags.keepInvalid)return;D.keepInvalidTags?k.__isValid=A:k=M}else D.keepInvalidTags&&(delete k.title,delete k["aria-invalid"],delete k.class);this.onEditTagDone(S,k)}else this.onEditTagDone(S,M);else this.onEditTagDone(S)}},onEditTagkeydown(m,x){if(!this.state.composing)switch(this.trigger("edit:keydown",{event:m}),m.key){case"Esc":case"Escape":x.parentNode.replaceChild(x.__tagifyTagData.__originalHTML,x),this.state.editing=!1;case"Enter":case"Tab":m.preventDefault(),m.target.blur()}},onDoubleClickScope(m){var x,k,D=m.target.closest("."+this.settings.classNames.tag),S=w(D),C=this.settings;D&&C.userInput&&!1!==S.editable&&(x=D.classList.contains(this.settings.classNames.tagEditing),k=D.hasAttribute("readonly"),"select"==C.mode||C.readonly||x||k||!this.settings.editTags||this.editTag(D),this.toggleFocusClass(!0),this.trigger("dblclick",{tag:D,index:this.getNodeIndex(D),data:w(D)}))},onInputDOMChange(m){m.forEach(m=>{m.addedNodes.forEach(m=>{if("<div><br></div>"==m.outerHTML)m.replaceWith(document.createElement("br"));else if(1==m.nodeType&&m.querySelector(this.settings.classNames.tagSelector)){let x=document.createTextNode("");3==m.childNodes[0].nodeType&&"BR"!=m.previousSibling.nodeName&&(x=document.createTextNode("\n")),m.replaceWith(x,...[...m.childNodes].slice(0,-1)),b(x)}else if(f.call(this,m))if(3!=m.previousSibling?.nodeType||m.previousSibling.textContent||m.previousSibling.remove(),m.previousSibling&&"BR"==m.previousSibling.nodeName){m.previousSibling.replaceWith("\n​");let x=m.nextSibling,k="";for(;x;)k+=x.textContent,x=x.nextSibling;k.trim()&&b(m.previousSibling)}else m.previousSibling&&!w(m.previousSibling)||m.before("​")}),m.removedNodes.forEach(m=>{m&&"BR"==m.nodeName&&f.call(this,x)&&(this.removeTags(x),this.fixFirefoxLastTagNoCaret())})});var x=this.DOM.input.lastChild;x&&""==x.nodeValue&&x.remove(),x&&"BR"==x.nodeName||this.DOM.input.appendChild(document.createElement("br"))}}},fixFirefoxLastTagNoCaret(){},setRangeAtStartEnd(m,x){if(x){m="number"==typeof m?m:!!m,x=x.lastChild||x;var k=document.getSelection();if(k.focusNode instanceof Element&&!this.DOM.input.contains(k.focusNode))return!0;try{k.rangeCount>=1&&["Start","End"].forEach(D=>k.getRangeAt(0)["set"+D](x,m||x.length))}catch(m){}}},insertAfterTag(m,x){if(x=x||this.settings.mixMode.insertAfterTag,m&&m.parentNode&&x)return x="string"==typeof x?document.createTextNode(x):x,m.parentNode.insertBefore(x,m.nextSibling),x},editTagChangeDetected(m){var x=m.__originalData;for(var k in x)if(!this.dataProps.includes(k)&&m[k]!=x[k])return!0;return!1},getTagTextNode(m){return m.querySelector(this.settings.classNames.tagTextSelector)},setTagTextNode(m,x){this.getTagTextNode(m).innerHTML=h(x)},editTag(m,x){m=m||this.getLastTag(),x=x||{},this.dropdown.hide();var k=this.settings,D=this.getTagTextNode(m),S=this.getNodeIndex(m),C=w(m),N=this.events.callbacks,I=this,M=!0;if(D){if(!(C instanceof Object&&"editable"in C)||C.editable)return C=w(m,{__originalData:p({},C),__originalHTML:m.cloneNode(!0)}),w(C.__originalHTML,C.__originalData),D.setAttribute("contenteditable",!0),m.classList.add(k.classNames.tagEditing),D.addEventListener("focus",N.onEditTagFocus.bind(this,m)),D.addEventListener("blur",function(){setTimeout(()=>N.onEditTagBlur.call(I,I.getTagTextNode(m)))}),D.addEventListener("input",N.onEditTagInput.bind(this,D)),D.addEventListener("paste",N.onEditTagPaste.bind(this,D)),D.addEventListener("keydown",x=>N.onEditTagkeydown.call(this,x,m)),D.addEventListener("compositionstart",N.onCompositionStart.bind(this)),D.addEventListener("compositionend",N.onCompositionEnd.bind(this)),x.skipValidation||(M=this.editTagToggleValidity(m)),D.originalIsValid=M,this.trigger("edit:start",{tag:m,index:S,data:C,isValid:M}),D.focus(),this.setRangeAtStartEnd(!1,D),this}else console.warn("Cannot find element in Tag template: .",k.classNames.tagTextSelector)},editTagToggleValidity(m,x){var k;if(x=x||w(m))return(k=!("__isValid"in x)||!0===x.__isValid)||this.removeTagsFromValue(m),this.update(),m.classList.toggle(this.settings.classNames.tagNotAllowed,!k),x.__isValid=k,x.__isValid;console.warn("tag has no data: ",m,x)},onEditTagDone(m,x){x=x||{};var k={tag:m=m||this.state.editing.scope,index:this.getNodeIndex(m),previousData:w(m),data:x};this.trigger("edit:beforeUpdate",k,{cloneData:!1}),this.state.editing=!1,delete x.__originalData,delete x.__originalHTML,m&&x[this.settings.tagTextProp]?(m=this.replaceTag(m,x),this.editTagToggleValidity(m,x),this.settings.a11y.focusableTags?m.focus():b(m)):m&&this.removeTags(m),this.trigger("edit:updated",k),this.dropdown.hide(),this.settings.keepInvalidTags&&this.reCheckInvalidTags()},replaceTag(m,x){x&&x.value||(x=m.__tagifyTagData),x.__isValid&&1!=x.__isValid&&p(x,this.getInvalidTagAttrs(x,x.__isValid));var k=this.createTagElem(x);return m.parentNode.replaceChild(k,m),this.updateValueByDOMTags(),k},updateValueByDOMTags(){this.value.length=0,[].forEach.call(this.getTagElms(),m=>{m.classList.contains(this.settings.classNames.tagNotAllowed.split(" ")[0])||this.value.push(w(m))}),this.update()},injectAtCaret(m,x){return(x=x||this.state.selection?.range)||!m?(T(m,x),this.setRangeAtStartEnd(!1,m),this.updateValueByDOMTags(),this.update()):this.appendMixTags(m),this},input:{set(){let m=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",x=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var k=this.settings.dropdown.closeOnSelect;this.state.inputText=m,x&&(this.DOM.input.innerHTML=h(""+m)),!m&&k&&this.dropdown.hide.bind(this),this.input.autocomplete.suggest.call(this),this.input.validate.call(this)},raw(){return this.DOM.input.textContent},validate(){var m=!this.state.inputText||!0===this.validateTag({value:this.state.inputText});return this.DOM.input.classList.toggle(this.settings.classNames.inputInvalid,!m),m},normalize(m){var x=m||this.DOM.input,k=[];x.childNodes.forEach(m=>3==m.nodeType&&k.push(m.nodeValue)),k=k.join("\n");try{k=k.replace(/(?:\r\n|\r|\n)/g,this.settings.delimiters.source.charAt(0))}catch(m){}return k=k.replace(/\s/g," "),this.trim(k)},autocomplete:{suggest(m){if(this.settings.autoComplete.enabled){"string"==typeof(m=m||{value:""})&&(m={value:m});var x=this.dropdown.getMappedValue(m);if("number"!=typeof x){var k=x.substr(0,this.state.inputText.length).toLowerCase(),D=x.substring(this.state.inputText.length);x&&this.state.inputText&&k==this.state.inputText.toLowerCase()?(this.DOM.input.setAttribute("data-suggest",D),this.state.inputSuggestion=m):(this.DOM.input.removeAttribute("data-suggest"),delete this.state.inputSuggestion)}}},set(m){var x=this.DOM.input.getAttribute("data-suggest"),k=m||(x?this.state.inputText+x:null);return!!k&&("mix"==this.settings.mode?this.replaceTextWithNode(document.createTextNode(this.state.tag.prefix+k)):(this.input.set.call(this,k),this.setRangeAtStartEnd(!1,this.DOM.input)),this.input.autocomplete.suggest.call(this),this.dropdown.hide(),!0)}}},getTagIdx(m){return this.value.findIndex(x=>x.__tagId==(m||{}).__tagId)},getNodeIndex(m){var x=0;if(m)for(;m=m.previousElementSibling;)x++;return x},getTagElms(){for(var m=arguments.length,x=Array(m),k=0;k<m;k++)x[k]=arguments[k];var D="."+[...this.settings.classNames.tag.split(" "),...x].join(".");return[].slice.call(this.DOM.scope.querySelectorAll(D))},getLastTag(){var m=this.DOM.scope.querySelectorAll(`${this.settings.classNames.tagSelector}:not(.${this.settings.classNames.tagHide}):not([readonly])`);return m[m.length-1]},isTagDuplicate(m,x,k){var D=0;if("select"==this.settings.mode)return!1;for(let S of this.value)a(this.trim(""+m),S.value,x)&&k!=S.__tagId&&D++;return D},getTagIndexByValue(m){var x=[],k=this.settings.dropdown.caseSensitive;return this.getTagElms().forEach((D,S)=>{D.__tagifyTagData&&a(this.trim(D.__tagifyTagData.value),m,k)&&x.push(S)}),x},getTagElmByValue(m){var x=this.getTagIndexByValue(m)[0];return this.getTagElms()[x]},flashTag(m){m&&(m.classList.add(this.settings.classNames.tagFlash),setTimeout(()=>{m.classList.remove(this.settings.classNames.tagFlash)},100))},isTagBlacklisted(m){return m=this.trim(m.toLowerCase()),this.settings.blacklist.filter(x=>(""+x).toLowerCase()==m).length},isTagWhitelisted(m){return!!this.getWhitelistItem(m)},getWhitelistItem(m,x,k){x=x||"value";var D,S=this.settings;return(k=k||S.whitelist).some(k=>{if(a("string"==typeof k?k:k[x]||k.value,m,S.dropdown.caseSensitive,S.trim))return D="string"==typeof k?{value:k}:k,!0}),D||"value"!=x||"value"==S.tagTextProp||(D=this.getWhitelistItem(m,S.tagTextProp,k)),D},validateTag(m){var x=this.settings,k="value"in m?"value":x.tagTextProp,D=this.trim(m[k]+"");return(m[k]+"").trim()?"mix"!=x.mode&&x.pattern&&x.pattern instanceof RegExp&&!x.pattern.test(D)?this.TEXTS.pattern:!x.duplicates&&this.isTagDuplicate(D,x.dropdown.caseSensitive,m.__tagId)?this.TEXTS.duplicate:this.isTagBlacklisted(D)||x.enforceWhitelist&&!this.isTagWhitelisted(D)?this.TEXTS.notAllowed:!x.validate||x.validate(m):this.TEXTS.empty},getInvalidTagAttrs(m,x){return{"aria-invalid":!0,class:`${m.class||""} ${this.settings.classNames.tagNotAllowed}`.trim(),title:x}},hasMaxTags(){return this.value.length>=this.settings.maxTags&&this.TEXTS.exceed},setReadonly(m,x){var k=this.settings;document.activeElement.blur(),k[x||"readonly"]=m,this.DOM.scope[(m?"set":"remove")+"Attribute"](x||"readonly",!0),this.settings.userInput=!0,this.setContentEditable(!m)},setContentEditable(m){this.settings.userInput&&(this.DOM.input.contentEditable=m,this.DOM.input.tabIndex=m?0:-1)},setDisabled(m){this.setReadonly(m,"disabled")},normalizeTags(m){var x=this.settings,k=x.whitelist,D=x.delimiters,S=x.mode,C=x.tagTextProp,N=[],I=!!k&&k[0]instanceof Object,M=Array.isArray(m),E=M&&m[0].value,h=m=>(m+"").split(D).filter(m=>m).map(m=>({[C]:this.trim(m),value:this.trim(m)}));if("number"==typeof m&&(m=m.toString()),"string"==typeof m){if(!m.trim())return[];m=h(m)}else M&&(m=[].concat(...m.map(m=>null!=m.value?m:h(m))));return I&&!E&&(m.forEach(m=>{var x=N.map(m=>m.value),k=this.dropdown.filterListItems.call(this,m[C],{exact:!0});this.settings.duplicates||(k=k.filter(m=>!x.includes(m.value)));var D=k.length>1?this.getWhitelistItem(m[C],C,k):k[0];D&&D instanceof Object?N.push(D):"mix"!=S&&(null==m.value&&(m.value=m[C]),N.push(m))}),N.length&&(m=N)),m},parseMixTags(m){var x=this.settings,k=x.mixTagsInterpolator,D=x.duplicates,S=x.transformTag,C=x.enforceWhitelist,N=x.maxTags,I=x.tagTextProp,M=[];m=m.split(k[0]).map((m,x)=>{var E,A,L,P=m.split(k[1]),R=P[0],q=M.length==N;try{if(R==+R)throw Error;A=JSON.parse(R)}catch(m){A=this.normalizeTags(R)[0]||{value:R}}if(S.call(this,A),q||!(P.length>1)||C&&!this.isTagWhitelisted(A.value)||!D&&this.isTagDuplicate(A.value)){if(m)return x?k[0]+m:m}else A[E=A[I]?I:"value"]=this.trim(A[E]),L=this.createTagElem(A),M.push(A),L.classList.add(this.settings.classNames.tagNoAnimation),P[0]=L.outerHTML,this.value.push(A);return P.join("")}).join(""),this.DOM.input.innerHTML=m,this.DOM.input.appendChild(document.createTextNode("")),this.DOM.input.normalize();var E=this.getTagElms();return E.forEach((m,x)=>w(m,M[x])),this.update({withoutChangeEvent:!0}),y(E,this.state.hasFocus),m},replaceTextWithNode(m,x){if(this.state.tag||x){x=x||this.state.tag.prefix+this.state.tag.value;var k,D,S=this.state.selection||window.getSelection(),C=S.anchorNode,N=this.state.tag.delimiters?this.state.tag.delimiters.length:0;return C.splitText(S.anchorOffset-N),-1==(k=C.nodeValue.lastIndexOf(x))||(D=C.splitText(k),m&&C.parentNode.replaceChild(m,D),!0)}},selectTag(m,x){var k=this.settings;if(!k.enforceWhitelist||this.isTagWhitelisted(x.value)){this.input.set.call(this,x[k.tagTextProp]||x.value,!0),this.state.actions.selectOption&&setTimeout(()=>this.setRangeAtStartEnd(!1,this.DOM.input));var D=this.getLastTag();return D?this.replaceTag(D,x):this.appendTag(m),this.value[0]=x,this.update(),this.trigger("add",{tag:m,data:x}),[m]}},addEmptyTag(m){var x=p({value:""},m||{}),k=this.createTagElem(x);w(k,x),this.appendTag(k),this.editTag(k,{skipValidation:!0})},addTags(m,x,k){var D=[],S=this.settings,C=[],N=document.createDocumentFragment();if(k=k||S.skipInvalid,!m||0==m.length)return D;switch(m=this.normalizeTags(m),S.mode){case"mix":return this.addMixTags(m);case"select":x=!1,this.removeAllTags()}return this.DOM.input.removeAttribute("style"),m.forEach(m=>{var x,I={},M=Object.assign({},m,{value:m.value+""});if(m=Object.assign({},M),S.transformTag.call(this,m),m.__isValid=this.hasMaxTags()||this.validateTag(m),!0!==m.__isValid){if(k)return;if(p(I,this.getInvalidTagAttrs(m,m.__isValid),{__preInvalidData:M}),m.__isValid==this.TEXTS.duplicate&&this.flashTag(this.getTagElmByValue(m.value)),!S.createInvalidTags)return void C.push(m.value)}if("readonly"in m&&(m.readonly?I["aria-readonly"]=!0:delete m.readonly),x=this.createTagElem(m,I),D.push(x),"select"==S.mode)return this.selectTag(x,m);N.appendChild(x),m.__isValid&&!0===m.__isValid?(this.value.push(m),this.trigger("add",{tag:x,index:this.value.length-1,data:m})):(this.trigger("invalid",{data:m,index:this.value.length,tag:x,message:m.__isValid}),S.keepInvalidTags||setTimeout(()=>this.removeTags(x,!0),1e3)),this.dropdown.position()}),this.appendTag(N),this.update(),m.length&&x&&(this.input.set.call(this,S.createInvalidTags?"":C.join(S._delimiters)),this.setRangeAtStartEnd(!1,this.DOM.input)),S.dropdown.enabled&&this.dropdown.refilter(),D},addMixTags(m){if((m=this.normalizeTags(m))[0].prefix||this.state.tag)return this.prefixedTextToTag(m[0]);var x=document.createDocumentFragment();return m.forEach(m=>{var k=this.createTagElem(m);x.appendChild(k)}),this.appendMixTags(x),x},appendMixTags(m){var x=!!this.state.selection;x?this.injectAtCaret(m):(this.DOM.input.focus(),(x=this.setStateSelection()).range.setStart(this.DOM.input,x.range.endOffset),x.range.setEnd(this.DOM.input,x.range.endOffset),this.DOM.input.appendChild(m),this.updateValueByDOMTags(),this.update())},prefixedTextToTag(m){var x,k=this.settings,D=this.state.tag.delimiters;return k.transformTag.call(this,m),m.prefix=m.prefix||this.state.tag?this.state.tag.prefix:(k.pattern.source||k.pattern)[0],x=this.createTagElem(m),this.replaceTextWithNode(x)||this.DOM.input.appendChild(x),setTimeout(()=>x.classList.add(this.settings.classNames.tagNoAnimation),300),this.value.push(m),this.update(),D||setTimeout(b,0,this.insertAfterTag(x)||x),this.state.tag=null,this.trigger("add",p({},{tag:x},{data:m})),x},appendTag(m){var x=this.DOM,k=x.input;x.scope.insertBefore(m,k)},createTagElem(m,x){m.__tagId=v();var k,D=p({},m,e({value:h(m.value+"")},x));return function(m){for(var x,k=document.createNodeIterator(m,NodeFilter.SHOW_TEXT,null,!1);x=k.nextNode();)x.textContent.trim()||x.parentNode.removeChild(x)}(k=this.parseTemplate("tag",[D,this])),w(k,m),k},reCheckInvalidTags(){var m=this.settings;this.getTagElms(m.classNames.tagNotAllowed).forEach((x,k)=>{var D=w(x),S=this.hasMaxTags(),C=this.validateTag(D),N=!0===C&&!S;if("select"==m.mode&&this.toggleScopeValidation(C),N)return D=D.__preInvalidData?D.__preInvalidData:{value:D.value},this.replaceTag(x,D);x.title=S||C})},removeTags(m,x,k){var D,S=this.settings;if(D=(m=m&&m instanceof HTMLElement?[m]:m instanceof Array?m:m?[m]:[this.getLastTag()]).reduce((m,x)=>{x&&"string"==typeof x&&(x=this.getTagElmByValue(x));var k=w(x);return x&&k&&!k.readonly&&m.push({node:x,idx:this.getTagIdx(k),data:w(x,{__removed:!0})}),m},[]),k="number"==typeof k?k:this.CSSVars.tagHideTransition,"select"==S.mode&&(k=0,this.input.set.call(this)),1==D.length&&"select"!=S.mode&&D[0].node.classList.contains(S.classNames.tagNotAllowed)&&(x=!0),D.length)return S.hooks.beforeRemoveTag(D,{tagify:this}).then(()=>{function t1(m){m.node.parentNode&&(m.node.parentNode.removeChild(m.node),x?S.keepInvalidTags&&this.trigger("remove",{tag:m.node,index:m.idx}):(this.trigger("remove",{tag:m.node,index:m.idx,data:m.data}),this.dropdown.refilter(),this.dropdown.position(),this.DOM.input.normalize(),S.keepInvalidTags&&this.reCheckInvalidTags()))}k&&k>10&&1==D.length?(function(m){m.node.style.width=parseFloat(window.getComputedStyle(m.node).width)+"px",document.body.clientTop,m.node.classList.add(S.classNames.tagHide),setTimeout(t1.bind(this),k,m)}).call(this,D[0]):D.forEach(t1.bind(this)),x||(this.removeTagsFromValue(D.map(m=>m.node)),this.update(),"select"==S.mode&&this.setContentEditable(!0))}).catch(m=>{})},removeTagsFromDOM(){[].slice.call(this.getTagElms()).forEach(m=>m.parentNode.removeChild(m))},removeTagsFromValue(m){(m=Array.isArray(m)?m:[m]).forEach(m=>{var x=w(m),k=this.getTagIdx(x);k>-1&&this.value.splice(k,1)})},removeAllTags(m){m=m||{},this.value=[],"mix"==this.settings.mode?this.DOM.input.innerHTML="":this.removeTagsFromDOM(),this.dropdown.refilter(),this.dropdown.position(),this.state.dropdown.visible&&setTimeout(()=>{this.DOM.input.focus()}),"select"==this.settings.mode&&(this.input.set.call(this),this.setContentEditable(!0)),this.update(m)},postUpdate(){this.state.blockChangeEvent=!1;var m=this.settings,x=m.classNames,k="mix"==m.mode?m.mixMode.integrated?this.DOM.input.textContent:this.DOM.originalInput.value.trim():this.value.length+this.input.raw.call(this).length;this.toggleClass(x.hasMaxTags,this.value.length>=m.maxTags),this.toggleClass(x.hasNoTags,!this.value.length),this.toggleClass(x.empty,!k),"select"==m.mode&&this.toggleScopeValidation(this.value?.[0]?.__isValid)},setOriginalInputValue(m){var x=this.DOM.originalInput;this.settings.mixMode.integrated||(x.value=m,x.tagifyValue=x.value,this.setPersistedData(m,"value"))},update(m){clearTimeout(this.debouncedUpdateTimeout),this.debouncedUpdateTimeout=setTimeout((function(){var x=this.getInputValue();this.setOriginalInputValue(x),this.settings.onChangeAfterBlur&&(m||{}).withoutChangeEvent||this.state.blockChangeEvent||this.triggerChangeEvent(),this.postUpdate()}).bind(this),100)},getInputValue(){var m=this.getCleanValue();return"mix"==this.settings.mode?this.getMixedTagsAsString(m):m.length?this.settings.originalInputValueFormat?this.settings.originalInputValueFormat(m):JSON.stringify(m):""},getCleanValue(m){return n(m||this.value,this.dataProps)},getMixedTagsAsString(){var m="",x=this,k=this.settings,D=k.originalInputValueFormat||JSON.stringify,S=k.mixTagsInterpolator;return function i(k){k.childNodes.forEach(k=>{if(1==k.nodeType){let C=w(k);if("BR"==k.tagName&&(m+="\r\n"),C&&f.call(x,k)){if(C.__removed)return;m+=S[0]+D(o(C,x.dataProps))+S[1]}else k.getAttribute("style")||["B","I","U"].includes(k.tagName)?m+=k.textContent:"DIV"!=k.tagName&&"P"!=k.tagName||(m+="\r\n",i(k))}else m+=k.textContent})}(this.DOM.input),m}},_.prototype.removeTag=_.prototype.removeTags,_}();let $eafd1e11e36a1c81$export$b5c87c9f30e8974e=class $eafd1e11e36a1c81$export$b5c87c9f30e8974e{_name=null;_description=null;boons=0;banes=0;modifier=0;divide=0;percent=0;stress_boons=0;static GRAY="--tag-bg:#a1a1a1;--tag-text-color:#2b2a2a;--tag-hover:#bababa;--tag-remove-bg:#a1a1a1;--tag-remove-btn-color:#2b2a2a";static RED="--tag-bg:#d19d9d;--tag-text-color:#530d0d;--tag-hover:#e1b4b4;--tag-remove-bg:#d19d9d;--tag-remove-btn-color:#530d0d";static GREEN="--tag-bg:#9dd1ab;--tag-text-color:#224939;--tag-hover:#b5e0c1;--tag-remove-bg:#9dd1ab;--tag-remove-btn-color:#224939";static ORANGE="--tag-bg:#e6d7aa;--tag-text-color:#493c22;--tag-hover:#e0cfb5;--tag-remove-bg:#d1c69d;--tag-remove-btn-color:#493822";constructor({name:m=null,description:x=null,boons:k=0,banes:D=0,modifier:S=0,divide:C=0,percent:N=0,stress_boons:I=0}){this._name=m,this._description=x,this.boons=parseInt(k)||0,this.banes=parseInt(D)||0,this.modifier=parseInt(S)||0,this.divide=parseInt(C)||0,this.percent=parseInt(N)||0,this.stress_boons=parseInt(I)||0}get name(){return this._name?`${this._name} ${this.mod_str()}`:this.mod_str()}get description(){return this._description||this._name}mod_str(){let m="⊕".repeat(this.boons)+"⊖".repeat(this.banes),x=this.modifier>=0?`+${this.modifier}`:`${this.modifier}`;return m?this.modifier?m+x:m:x}tag(){return{value:this.name,title:this.description,style:$eafd1e11e36a1c81$export$b5c87c9f30e8974e.color(this.name)}}json(){return{boons:this.boons,banes:this.banes,modifier:this.modifier,divide:this.divide,percent:this.percent,stress_boons:this.stress_boons,name:this.name,description:this.description}}static parse(m){let x=[];try{return m.forEach(m=>{let k=new URLSearchParams(m);x.push(new $eafd1e11e36a1c81$export$b5c87c9f30e8974e({name:k.get("name"),description:k.get("description"),boons:k.get("boons"),banes:k.get("banes"),modifier:k.get("modifier"),divide:k.get("divide"),percent:k.get("percent"),stress_boons:k.get("stress_boons")}))}),x}catch(x){return console.error(`Error parsing modifiers object: ${m}`),[]}}static color(m){let x=$81dc50ef4a81fbcd$export$33dec5772ae42010("stress",!1),k=m.includes("+")||m.includes("⊕"),D=m.includes("-")||m.includes("⊖"),S=m.toLowerCase().startsWith("stress");return k&&D?$eafd1e11e36a1c81$export$b5c87c9f30e8974e.GRAY:x&&S&&k?$eafd1e11e36a1c81$export$b5c87c9f30e8974e.ORANGE:k?$eafd1e11e36a1c81$export$b5c87c9f30e8974e.GREEN:D?$eafd1e11e36a1c81$export$b5c87c9f30e8974e.RED:$eafd1e11e36a1c81$export$b5c87c9f30e8974e.GRAY}static total_modifiers(m){let x=0,k=0,D=0,S=1,C=0,N=0,I=[];return m.forEach(m=>{x+=m.boons||0,k+=m.banes||0,D+=m.modifier||0,S*=m.divide||0,C+=m.percent||0,N+=m.stress_boons||0,m.name&&I.push(m.name)}),{boons:x,banes:k,modifier:D,divide:S,percent:C,stress_boons:N,tags:I}}static list_from_string(m){let x=null;try{m&&(x=JSON.parse(m))}catch(m){console.error("Error parsing list from tagify")}return x?(Array.isArray(x)||(x=[x]),x.map(m=>$eafd1e11e36a1c81$export$b5c87c9f30e8974e.from_tag(m))):[]}static from_tag(m){let x="string"==typeof m||m instanceof String?m:m.value;if(!x)return{};let k=x.replace(/([a-zA-Z0-9])([+-])/g,"$1 $2").split(" "),D=k.pop(),S=k.join(" "),C=parseInt(D.replace(/^\D+/,""))||null,N=D.replace(/[0-9]/g,"");null!==C&&"-"===N.at(-1)&&(C*=-1),null!==C&&(N=N.slice(0,-1));let I=(N.match(/[+⊕]/g)||[]).length,M=(N.match(/[-⊖]/g)||[]).length,E=S.toLowerCase().startsWith("stress")&&(N.match(/[+⊕]/g)||[]).length;return new $eafd1e11e36a1c81$export$b5c87c9f30e8974e({name:S.replace(/[⊕⊖]/g,""),boons:I,banes:M,modifier:C||0,stress_boons:E})}};Hooks.once("init",async()=>{Handlebars.registerHelper("skillSelect",(m,x)=>{let k=RegExp.escape(Handlebars.escapeExpression(m)),D=RegExp(` value=["']${k}["']`);return x.fn(void 0).replace(D,"$& selected")})});const $3cb507794eef5f3c$export$3b84a4f667a9b873={"":"--",strength:"Strength",dexterity:"Dexterity",speed:"Speed",endurance:"Endurance",intelligence:"Intelligence",perception:"Perception",charisma:"Charisma",determination:"Determination"},$3cb507794eef5f3c$export$31ebfa08917fa7c5={"":"--",defense:"Defense",willpower:"Willpower"},$3cb507794eef5f3c$export$79a86e154bc9aabc={"":"--",defense:"Defense",crew:"Crew"};let $3cb507794eef5f3c$export$1b16fc9eb974a84d=class $3cb507794eef5f3c$export$1b16fc9eb974a84d{_actor=null;_label=null;target=null;target_score=null;critical=!1;evaluated=!1;margin=null;pairs=null;results=null;skill_value=0;stat_value=0;success=!1;randomizer=null;total=null;use_pair=!1;stressed=0;panic=!1;constructor(m){Object.assign(this,m),this.validate()}validate(){if(!((this.sceneId&&this.tokenId||this.actorId||this.actor)&&this.actor&&this.actor.system&&(this.actor.system?.stats&&this.actor.system?.stats[this.stat]||this.actor.system?.scores&&this.actor.system?.scores[this.stat]||!this.stat)))throw`Test missing required data: scene=${this.sceneId}, token=${this.tokenId}, actor=${this.actorId}, stat=${this.stat}`;if(this.tn&&!isNaN(this.tn)&&(this.tn=Number(this.tn)),this.boons&&!isNaN(this.boons)?this.boons=Number(this.boons):this.boons=0,this.banes&&!isNaN(this.banes)?this.banes=Number(this.banes):this.banes=0,this.modifier&&!isNaN(this.modifier)?this.modifier=Number(this.modifier):this.modifier=0,this.stress_boons&&!isNaN(this.stress_boons)?this.stress_boons=Number(this.stress_boons):this.stress_boons=0,this.effects){if(Array.isArray(this.effects)&&this.effects.every(m=>m instanceof $5ba9a332765ece17$export$a32b0b1c1ac59d04))return;let m=null;Array.isArray(m="string"==typeof this.effects?JSON.parse(this.effects):this.effects)||(m=[m]);for(let x=0;x<m.length;x++)m[x]=new $5ba9a332765ece17$export$a32b0b1c1ac59d04(m[x],this);this.effects=m}}set actor(m){this._actor=m}get actor(){if(this._actor)return this._actor;if(this.sceneId&&this.tokenId){let m=game.scenes.get(sceneId);if(!m)return null;let x=m.items.get(tokenId);if(!x)return null;let k=new Token(x);return this._actor=k.actor,this._actor}return this._actor=game.actors.get(this.actorId)||null,this._actor}get label(){return this._label||(this._label=$81dc50ef4a81fbcd$export$44f4605f44e8fbf2(this.stat,this.skill,this.tn)),this._label}roll_syntax(){let m=this.boons-this.banes;return 0===m?"1d10":m>0?`${m+1}d10kh1`:`${-1*m+1}d10kl1`}make_pairs(){if(this.banes>=this.boons)return[null,!1];let m=[],x=0;for(let k of this.results.dice[0].results)m.includes(k.result)&&k.result>x&&(x=k.result),m.push(k.result);let k=2*x>this.results.total;if(2*x>this.results.total){this.results._total=2*x;let m=0;for(let k of this.results.dice[0].results)k.result===x&&m<2?(k.discarded=!1,m++):k.discarded=!0}return[x,k]}lookup_skill(){let m=this.skill.match(/\(([^\)]+)\)/);m&&(m=m[m.length-1]);let x=m?this.skill.split(" ")[0]:this.skill,k=[];return(m?(m=m.replace(/[()]/g,""),k=this.actor.items.filter(k=>"skill"===k.type&&k.name===x&&k.system.specialization===m)):k=this.actor.items.filter(m=>"skill"===m.type&&m.name===x),k.length||(k=this.actor.items.filter(m=>"skill"===m.type&&m.name===this.skill)),k.length)?Number(k[0].system.rank):0}calc_total(){let m=this.stat?this.stat in(this.actor.system?.stats||[])?this.actor.system?.stats[this.stat].value:this.actor.system?.scores[this.stat].value:0,x=!!this.skill,k=x&&"Unskilled"!==this.skill?this.lookup_skill():0;x&&!k&&(m=Math.floor(m/2));let D=this.pairs&&2*this.pairs>this.results.total?2*this.pairs:this.results.total;return[D+m+k+this.modifier,D,m,k]}check_stress(){if(!$81dc50ef4a81fbcd$export$33dec5772ae42010("stress",!1))return[0,!1];{let m=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.stress(this.actor)||0,x=this.stress_boons?this.results.dice[0].results.slice(-1*this.stress_boons):[],k=!1;for(let D of x)D.result<=m&&(k=!0);return[m,k]}}lookup_tn(){if("string"!=typeof this.tn)return[this.tn,null,null];let m="defense"===this.tn.toLowerCase(),x="willpower"===this.tn.toLowerCase();if(!m&&!x)return!1;let k=game?.user?.targets?.values()?.next()?.value?.actor,D=k?.system?.scores;return D?[m?D.defense.tn:D.willpower.tn,k,this.tn]:[null,null,null]}double_ones(){let m=0;for(let x of this.results.dice[0].results)1===x.result&&m++;return m>=2}calc_margin(){if(!this.tn)return[null,null,null];let m=Math.abs(this.total-this.tn),x=this.total>=this.tn,k=m>=this.tn||this.total<this.tn/2;return this.banes>this.boons&&this.double_ones()&&(x&&(x=!1,m=0),k=!0),[x,k,m]}async evaluate(){let m=new Roll(this.roll_syntax());return this.results=await m.evaluate(),[this.pairs,this.use_pair]=this.make_pairs(),[this.total,this.randomizer,this.stat_value,this.skill_value]=this.calc_total(),[this.stressed,this.panic]=this.check_stress(),[this.tn,this.target,this.target_score]=this.lookup_tn(),[this.success,this.critical,this.margin]=this.calc_margin(),this.evaluated=!0,this}async apply_effects(m){this.effects||(this.effects=[]);let x=m?.properties||this.properties||[];if(!this.effects_evaluated){if($7c3e2ddbe0c064b6$export$4b017698e4946e33.has_property(x,"Auto")){let m=this.basic_attack_damage()||{value:0,damage_type:"sm"};for(let k=this.margin-5;k>0;k-=5)this.effects.push(new $5ba9a332765ece17$export$a32b0b1c1ac59d04({type:"damage",value:m.value,damage_type:m.damage_type,margin:k,when:"success",target:"target",properties:x},this));this.effects.push(new $5ba9a332765ece17$export$a32b0b1c1ac59d04({type:"message",key:"Ammo",value:`Automatic fire consumes ${$7c3e2ddbe0c064b6$export$4b017698e4946e33.property_value(x,"Auto")} shots.`},this))}$7c3e2ddbe0c064b6$export$4b017698e4946e33.has_property(x,"Stun")&&this.effects.push(new $5ba9a332765ece17$export$a32b0b1c1ac59d04({type:"consequence",name:"Stunned",when:"success",target:"target"},this));let m=["defense","damage","consequence","message"];this.effects.sort((x,k)=>m.indexOf(x.type)>m.indexOf(k.type)?1:m.indexOf(x.type)<m.indexOf(k.type)?-1:m.indexOf(x.type)===m.indexOf(k.type)?0:void 0),this.effects_evaluated=!0}let k=this.success?"success":this.tn?"failure":"always";for(let x of this.effects)x.apply(k,m)}basic_attack_damage(){let m=this.effects.filter(m=>"damage"===m.type);return m.length?m[0]:null}flavor(){let m=this.target?`<div><strong>Target:</strong> ${this.target.name} (${$81dc50ef4a81fbcd$export$9a00dee1beb8f576(this.target_score)} ${this.tn})</div>`:"",x=(this.critical?"Critical ":"")+(this.target_score?this.success?"Hit!":"Miss!":this.success?"Success!":"Failure!"),k=(this.critical?"critical ":"")+(this.success?"success":"failure"),D=this.tn?`<div><strong>Result:</strong> <span class="${k}">${x}</span> Margin ${this.margin}</div>`:"",S="";if(this.panic&&(S+='<div><strong>Panic:</strong> <span class="panic">Make a Panic test!</span></div>'),this.effects)for(let m of this.effects)S+=m.message;let C=$81dc50ef4a81fbcd$export$33dec5772ae42010("luck_label","Luck"),N="";return this.stat&&(N+=`<span class="tag">${$81dc50ef4a81fbcd$export$9a00dee1beb8f576(this.stat)} +${this.stat_value}</span>`),this.skill&&"Unskilled"!==this.skill&&(N+=`<span class="tag">${this.skill} +${this.skill_value}</span>`),this.skill&&0===this.skill_value&&(N+='<span class="tag">Unskilled</span>'),this.tags&&this.tags.length&&this.tags.forEach(m=>N+=`<span class="tag">${m}</span>`),this.use_pair&&(N+='<span class="tag">Pairs!</span>'),this.use_luck&&(N+=`<span class="tag">${C}</span>`),this.edited&&(N+='<span class="tag">Edited</span>'),`<h4 class="action">${this.label}</h4>
                ${m} 
                ${D} 
                ${S}
                <hr />
                <div class="tags">${N}</div>`}dice_html(){let m=$81dc50ef4a81fbcd$export$33dec5772ae42010("stress",!1),x='<ol class="dice-rolls">';for(let k=0;k<this.results.dice[0].results.length;k++){let D=this.results.dice[0].results[k],S=D.discarded?"discarded":"",C=m&&k>=this.results.dice[0].results.length-this.stress_boons?"stress":"";m&&D.result<=this.stressed&&(C+=" panic"),x+=`<li class="roll die d10 ${S} ${C}">${D.result}</li>`}return x+"</ol>"}content(){let m=this.stat_value?`+ <span title="Stat">${this.stat_value}</span>`:"",x=this.skill_value?`+ <span title="Skill">${this.skill_value}</span>`:"",k=this.modifier?`+ <span title="Modifier">${this.modifier}</span>`:"",D=JSON.stringify($3cb507794eef5f3c$export$1b16fc9eb974a84d.to_json(this));return`
            <div class="dice-roll">
                <div class="dice-result">
                    <div class="dice-formula">
                        ${this.results.formula} ${x} ${m} ${k}
                    </div>
                    <div class="dice-tooltip">
                        <section class="tooltip-part">
                            <div class="dice">
                                <header class="part-header flexrow">
                                    <span class="part-formula">${this.results.formula}</span>
                                    <span class="part-total">${this.results.total}</span>
                                </header>
                                ${this.dice_html()}
                            </div>
                        </section>
                    </div>
                    <h4 class="dice-total">${this.total}</h4>
                </div>
            </div>
            <input type="hidden" class="test-json" value='${D}' />`}async to_chat({whisper:m=!1,rolls:x=null}){x&&(Array.isArray(x)||(x=[x]),x=x.map(m=>JSON.stringify(m.toJSON()))),await ChatMessage.create({content:this.content(),flavor:this.flavor(),rolls:x||(m?[]:[this.results]),speaker:ChatMessage.getSpeaker({actor:this.actor}),whisper:m?game.users.filter(m=>m.isGM||m.character?.id===this.actor?.id).map(m=>m.id):[]})}static to_json(m){let x={};for(let[k,D]of Object.entries(m))if("string"==typeof D||"number"==typeof D||"boolean"==typeof D||null===D)x[k]=D;else if("_actor"===k||"target"===k)x[k]={uuid:D.uuid};else if("effects"===k){let D=[];for(let x of m.effects)D.push($5ba9a332765ece17$export$a32b0b1c1ac59d04.to_json(x));x[k]=D}else"results"===k&&(x[k]={_evaluated:D._evaluated,_formula:D._formula,_total:D._total,_terms:D.terms[0].results});return x}static from_json(m){let x={};for(let[k,D]of Object.entries(m))"string"==typeof D||"number"==typeof D||"boolean"==typeof D||null===D?x[k]=m[k]:"_actor"===k||"target"===k?D instanceof game.sagamachine.SagaMachineActor?x[k]=D:x[k]=$81dc50ef4a81fbcd$export$99454b2c58b3846f(D):"effects"===k?x[k]=D:"results"===k&&(x[k]=new Roll(D._formula),x[k]._evaluated=D._evaluated,x[k]._formula=D._formula,x[k]._total=D._total,x[k].terms=[new foundry.dice.terms.Die({faces:10})],x[k].terms[0].results=D._terms);return new $3cb507794eef5f3c$export$1b16fc9eb974a84d(x)}};async function $3cb507794eef5f3c$export$5803ef6f71bdd50f(m,x=null){let k=$81dc50ef4a81fbcd$export$99454b2c58b3846f(m),D="vehicle"===k.type?$3cb507794eef5f3c$export$79a86e154bc9aabc:$3cb507794eef5f3c$export$31ebfa08917fa7c5;new Dialog({title:"Make Test",content:await renderTemplate("systems/saga-machine/templates/apps/test-dialog.html",{actor:{...k.sheet.getData().data},STAT_OPTIONS:$3cb507794eef5f3c$export$3b84a4f667a9b873,SCORE_OPTIONS:D,...m}),render:x=>{let D=k.modifiers(m),S=x.find("input[name=modifiers]");if(!S)return;let C=new($parcel$interopDefault($0a478c99c1d3517f$exports))(S[0],{duplicates:!0,transformTag:m=>{m.style=$eafd1e11e36a1c81$export$b5c87c9f30e8974e.color(m.value),isNaN(parseInt(m.value.split(" ").at(-1)))&&(m.value=m.value.replaceAll("+","⊕").replaceAll("-","⊖"))}}),N=foundry.utils.deepClone(C.value),I=D.map(m=>m.tag());C.addTags(I);let M=x.find("input[name=properties]");new($parcel$interopDefault($0a478c99c1d3517f$exports))(M[0],{duplicates:!0,transformTag:m=>{m.style=$eafd1e11e36a1c81$export$b5c87c9f30e8974e.GRAY}}),x.find("select[name=stat], select[name=score], select[name=skill], input[name=tn], input[name=properties]").on("change",D=>{let S=JSON.parse(JSON.stringify(m));S.stat=x.find("select[name=stat]").val(),S.score=x.find("select[name=score]").val(),S.skill=x.find("select[name=skill]").val(),S.tn=x.find("input[name=tn]").val(),S.properties=JSON.parse(x.find("input[name=properties]").val()||"[]").map(m=>m.value).join(",");let I=k.modifiers(S);C.removeAllTags(),C.addTags(N),C.addTags(I.map(m=>m.tag()))})},buttons:{roll:{label:"Make Test",callback:async D=>{D.find("select[name=stat] > option:selected").trigger("focus"),setTimeout(async()=>{let S=D.find("select[name=stat] > option:selected").val(),C=D.find("select[name=score] > option:selected").val(),N=D.find("select[name=skill] > option:selected").val(),{boons:I,banes:M,modifier:E,tags:A,stress_boons:L}=$eafd1e11e36a1c81$export$b5c87c9f30e8974e.total_modifiers($eafd1e11e36a1c81$export$b5c87c9f30e8974e.list_from_string(D.find("input[name=modifiers]").val())),P=new $3cb507794eef5f3c$export$1b16fc9eb974a84d({actor:k,stat:S||C,skill:N||null,boons:I||0,banes:M||0,modifier:E||0,stress_boons:L||0,tags:A,tn:D.find("input[name=tn]").val()||null,effects:D.find("input[name=effects]").val()||null});await P.evaluate(),await P.apply_effects(m);let R=!!m.whisper;await P.to_chat({whisper:R}),x&&await x(P)},200)},icon:'<i class="fas fa-check"></i>'}},default:"roll"}).render({force:!0,width:450})}const $a67d2793a1b43c8e$export$7065c91b0a27b3b9=()=>{let m=[],x=["Bleeding","Bolstered","Dazed","Defeated","Desire","Disabled","Dying","Fatigue","Fear","Fixation","Grave Wound","Hidden","Hindered","Prone","Stunned","Wound"];return $81dc50ef4a81fbcd$export$33dec5772ae42010("stress",!1)&&x.splice(14,0,"Stressed"),x.forEach(x=>m.push({icon:`systems/saga-machine/images/consequences/${x.slugify()}.svg`,statuses:[x.slugify()],name:x,id:x.slugify(),flags:{core:{overlay:["Defeated"].includes(x)},system:{subject_prompt:["Bleeding","Desire","Fear","Fixation"].includes(x),value_prompt:["Fatigue","Grave Wound","Wound"].includes(x),remove_others:["Desire","Fixation"].includes(x),no_consequence:["Defeated","Unconscious"].includes(x)}}})),m};async function $a67d2793a1b43c8e$export$ce53e9a4e8384701({name:m,actor:x,skip_actor:k=!1,skip_global:D=!1,skip_new:S=!1}){let C=null;return k||(C=x?.items.filter(x=>x.name===m&&"consequence"===x.type).values().next()?.value),D||C||(C=game.items.filter(x=>x.name===m&&"consequence"===x.type).values().next()?.value),S||C||(C=await Item.create({name:m.capitalize(),type:"consequence",system:{rank:1}})),C}async function $a67d2793a1b43c8e$export$bce7246a7036e38(m){let x=new Set(m.items.filter(m=>"consequence"===m.type&&m.system.rank>0&&game.sagamachine.standard_consequences.includes(m.name)).map(m=>m.name.slugify())),k=m.statuses,D=x.difference(k),S=k.difference(x);S.delete("defeated"),S.delete("unconscious");let C=[];CONFIG.statusEffects.forEach(m=>{D.has(m.id)&&C.push(foundry.utils.deepClone(m))}),C.length&&await m.createEmbeddedDocuments("ActiveEffect",C),S.size&&await m.deleteEmbeddedDocuments("ActiveEffect",m.effects.filter(m=>S.has(m.name.slugify())).map(m=>m.id));let N=new Set(m.effects.map(m=>m.name));if(N.size!==m.effects.size)for(let x of N){if(!game.sagamachine.standard_consequences.includes(x))return;let k=m.effects.filter(m=>m.name===x);k.length>1&&(k.shift(),await m.deleteEmbeddedDocuments("ActiveEffect",k.map(m=>m.id)))}}async function $a67d2793a1b43c8e$export$40b3570d78570c16(m,x=!1){for(let x of m.parent.effects.filter(x=>x.origin===m.uuid))x.delete();if(x)return;let k=[];for(let x of m.effects)k.push(x.clone({parent:m.parent,origin:m.uuid}));m.parent.createEmbeddedDocuments("ActiveEffect",k)}function $a67d2793a1b43c8e$export$b65e028fee10b7bb(m,x){function substitute_variables(m,x){return m=m.replaceAll("@rank",x.system.rank),x.parent&&(m=m.replaceAll("@str",x.parent.system.stats.strength.value).replaceAll("@dex",x.parent.system.stats.dexterity.value).replaceAll("@spd",x.parent.system.stats.speed.value).replaceAll("@end",x.parent.system.stats.endurance.value).replaceAll("@int",x.parent.system.stats.intelligence.value).replaceAll("@per",x.parent.system.stats.perception.value).replaceAll("@chr",x.parent.system.stats.charisma.value).replaceAll("@det",x.parent.system.stats.determination.value)),m}let do_math=m=>Function(`'use strict'; return (${m})`)(),k=new URLSearchParams(m.replaceAll("+","%2b"));for(let m of["boons","banes","modifier","divide","percent"])k.has(m)&&k.set(m,do_math(substitute_variables(k.get(m),x)));return k.toString()}async function $a67d2793a1b43c8e$export$7801755dddf1fd51(m){let x=await fromUuid(m.origin);if(!x)return!0;for(let k of m.changes)k.value=$a67d2793a1b43c8e$export$b65e028fee10b7bb(k.value,x);return await m.updateSource({changes:m.changes}),!0}async function $a67d2793a1b43c8e$export$31930d543788113d(m){let x=m.target,k=m.statuses.first();if(m?.flags?.system?.no_consequence)return;let D=x.items.filter(m=>m.name.slugify()===k&&"consequence"===m.type).values().next()?.value;D||((D=game.items.filter(x=>x.name===m.name&&"consequence"===x.type).values().next()?.value)||(D=await Item.create({name:k.capitalize(),type:"consequence",system:{rank:1}})),m?.flags?.system?.subject_prompt&&new Dialog({title:`Specify Subject of ${D.name}`,content:`
                    <form>
                        <div class="form-group">
                            <label for="subject">Subject</label>
                            <input type="text" name="subject" value="" autofocus>
                        </div>
                    </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async k=>{let S=k.find("[name=subject]").val().trim();D.update({"system.specialization":S,"system.rank":1}),D.system.specialization=S,m?.flags?.system?.remove_others&&x.items.filter(m=>m.name===D.name&&"consequence"===m.type&&m.system.specialization!==S).forEach(m=>m.delete())}}},default:"Confirm"}).render({force:!0}),m?.flags?.system?.value_prompt&&new Dialog({title:`Specify Descriptor and Value of ${D.name}`,content:`
                    <form>
                        <div class="grid grid-2col">
                            <label for="subject">Descriptor (optional)</label>
                            <input type="text" name="subject" value="" autofocus>
                            <label for="value">Value</label>
                            <input type="number" name="value" value="1">
                        </div>
                    </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async m=>{let x=m.find("[name=subject]").val().trim(),k=parseInt(m.find("[name=value]").val())||1;D.update({"system.specialization":x,"system.rank":k})}}},default:"Confirm"}).render({force:!0}),[D]=await x.createEmbeddedDocuments("Item",[D]))}async function $a67d2793a1b43c8e$export$efd50a08c6cb878d(m){let x=m.target,k=x.items.filter(x=>x.name===m.name&&"consequence"===x.type);k.length&&await x.deleteEmbeddedDocuments("Item",k.map(m=>m.id))}function $a67d2793a1b43c8e$export$df951736c406196b(m){let x=m.target,k=x.items.filter(x=>x.name===m.name&&"consequence"===x.type);if(!k.length)return!0;if(k.length>1||m?.flags?.system?.value_prompt){let D='<form><div class="grid grid-2col">';return k.forEach(x=>{let k=m?.flags?.system?.value_prompt||x.system.rank>1?x.system.rank:"";D+=`<input type="radio" name="consequence" value="${x.id}" />
                            <label for="consequence">${x.system.full_name} ${k}</label>`}),D+="</div></form>",new Dialog({title:`Select Which ${k[0].name} to Remove`,content:D,buttons:{Confirm:{icon:"<i class='fa fa-trash'></i>",label:"Remove",callback:async m=>{let k=m.find("input[name=consequence]:checked").val();k&&await x.deleteEmbeddedDocuments("Item",[k])}}},default:"Confirm"}).render({force:!0}),!1}return!0}let $99f2af74aa8b5874$export$c49d3afcc675f1b5=class $99f2af74aa8b5874$export$c49d3afcc675f1b5 extends Actor{async prepareDerivedData(){super.prepareDerivedData(),"character"===this.type&&await $99f2af74aa8b5874$export$ed3c1ed9e6e8a483.calculate_scores(this),"stash"===this.type&&await $99f2af74aa8b5874$export$251803a9103f8263.calculate_scores(this),"vehicle"===this.type&&await $99f2af74aa8b5874$export$d98152187a58a356.calculate_scores(this)}getRollData(){let m=super.getRollData();if(m.stats){for(let x of Object.keys(m.stats))m[x]=m.stats[x].value;for(let x of Object.keys(m.scores))m[x]=m.scores[x].value}return m}getInitiativeRoll(m=null){return new Roll(m?m:this.is_npc()?$be5000aeda79555a$export$bd4feec9a9a5101a.NPC_TURN:this.system.fast_turn?$be5000aeda79555a$export$bd4feec9a9a5101a.FAST_TURN:$be5000aeda79555a$export$bd4feec9a9a5101a.SLOW_TURN)}calculate_score(m,x,k={}){let D=Array.isArray(x)?$81dc50ef4a81fbcd$export$9c490b34b2f16a34(x):x,S=this.total_modifiers({base_score:m,...k}),C=1+S.percent/100;return Math.floor((D+S.modifier)*C/(S.divide||1))}armor_properties(){let m=this.items.filter(m=>"item"===m.type&&"Armors"===m.system.group&&m.system.equipped),x={Armor:0,Bulky:0,Powered:0};for(let k of m)k.system.armor>x.Armor&&(x.Armor=k.system.armor),k.system.bulky>x.Bulky&&(x.Bulky=k.system.bulky),k.system.powered>x.Powered&&(x.Powered=k.system.powered),k.system.properties.includes("Sealed")&&(x.Sealed=!0);return x}armor_value(){if(this.system.scores.armor.properties.Armor)return this.system.scores.armor.properties.Armor;let m=this.items.filter(m=>"item"===m.type&&"Armors"===m.system.group&&m.system.equipped),x=0;for(let k of m){let m=k.system.armor;m>x&&(x=m)}return x}encumbrance_total(){return this.items.filter(m=>"item"===m.type).reduce((m,x)=>x.system.encumbrance+m,0)}wound_total(){return this.items.filter(m=>"consequence"===m.type&&("wound"===m.name.toLowerCase()||"grave wound"===m.name.toLowerCase()||"fatigue"===m.name.toLowerCase())).map(m=>m.system.rank).reduce((m,x)=>m+x,0)}has_trait(m,x=null){let k=this.items.filter(x=>"trait"===x.type&&x.name.toLowerCase()===m.toLowerCase());if(!x)return!!k.length;let D=!1;for(let m of k)for(let k of m.system.specialization&&m.system.specialization.split(","))k.trim().toLowerCase()===x&&(D=!0);return D}has_immunity(m){return this.has_trait("Immunity",m)}has_vulnerability(m){return this.has_trait("Vulnerability",m)}has_resistance(m){return this.has_trait("Resistance",m)}dying_tn(){return Math.abs(Math.min(this.system.scores.health.max-this.system.scores.health.value,0))}async apply_damage(m,x,k,D){k="true"===k||!0===k;let S=(D=Number(D))===$5ba9a332765ece17$export$a32b0b1c1ac59d04.IGNORES_ALL_ARMOR?Number(m):Number(m)-Math.max(this.system.scores.armor.value-Math.max(D,0),0);if(this.has_immunity(x)&&(ChatMessage.create({content:"The character has immunity. Ignoring damage.",whisper:[game.user.id]}),S=0),this.has_vulnerability(x)&&(ChatMessage.create({content:"The character has vulnerability. Doubling damage.",whisper:[game.user.id]}),S*=2),this.has_resistance(x)&&(ChatMessage.create({content:"The character has resistance. Halving damage.",whisper:[game.user.id]}),S=Math.floor(S/2)),S<=0)return;this.system.scores.health.value+S>=this.system.scores.health.max&&(k=!0,"fat"===x?ChatMessage.create({content:`Wound Total exceeds Health. ${this.name} must succeed at an <strong>End-${this.system.scores.health.fatigue+S}</strong> test or fall unconscious for [[1d10]] hours.`}):ChatMessage.create({content:`Wound Total exceeds Health. ${this.name} takes a Grave Wound.`}));let C=Math.floor(this.system.scores.health.value/this.system.scores.health.max),N=Math.max(Math.floor((this.system.scores.health.value+S)/this.system.scores.health.max)-C,+(this.system.scores.health.value>this.system.scores.health.max&&"fat"!==x));if("fat"===x&&0===C&&N--,N>0){let m=!1,x=this?.items.filter(m=>"Dying"===m.name&&"consequence"===m.type).values().next()?.value;x?m=!0:(x=await $a67d2793a1b43c8e$export$ce53e9a4e8384701({name:"Dying",actor:this,skip_actor:!0}),[x]=await this.createEmbeddedDocuments("Item",[x]));let k=m?x.system.rank+N:N;if(await x.update({"system.rank":k}),k>=3&&!this.statuses.has("defeated")){let m=null;if(CONFIG.statusEffects.forEach(x=>{"defeated"===x.id&&(m=x)}),m){let x=foundry.utils.deepClone(m);ActiveEffect.create(x,{parent:this}),ChatMessage.create({content:`Dying consequences exceed 3 or more. ${this.name} is dead.`})}}}let I=null;I="fat"===x?"Fatigue":k?"Grave Wound":"Wound";let M=game.items.filter(m=>m.name===I&&"consequence"===m.type).values().next()?.value;M||(M=await Item.create({name:I,type:"consequence",system:{specialized:!0,specialization:"describe injury",rank:1}}));let[E]=await this.createEmbeddedDocuments("Item",[M]);await E.update({"system.rank":S});let A=await $5ba9a332765ece17$export$a8bf75e7367c8d41.generate_wound(x,k);new Dialog({title:`Describe ${I}`,content:`
                <form>
                    <div class="form-group">
                        <label for="descriptor">Descriptor</label>
                        <input type="text" name="descriptor" value="${A.descriptor}" autofocus>
                    </div>
                </form>`,buttons:{Confirm:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async m=>{let x=m.find("[name=descriptor]").val();A.descriptor!==x&&(A.description=""),await E.update({"system.specialization":x,"system.description":A.description})}}},default:"Confirm"}).render({force:!0})}async encumbrance_consequences(){if(this.isOwner)if(this.system.scores.encumbrance.value>this.system.scores.encumbrance.max){if(this.items.filter(m=>"Hindered"===m.name&&"Encumbered"===m.system.specialization&&"consequence"===m.type).length)return;let m=await $a67d2793a1b43c8e$export$ce53e9a4e8384701({name:"Hindered",actor:this,skip_actor:!0});[m]=await this.createEmbeddedDocuments("Item",[m]),await m.update({"system.specialization":"Encumbered","system.specialized":!0})}else{let m=this.items.filter(m=>"Hindered"===m.name&&"Encumbered"===m.system.specialization&&"consequence"===m.type);m.length&&await this.deleteEmbeddedDocuments("Item",m.map(m=>m.id))}}is_pc(){return"character"===this.type&&!this.system.npc}is_npc(){return"character"===this.type&&!!this.system.npc}total_modifiers(m){return $eafd1e11e36a1c81$export$b5c87c9f30e8974e.total_modifiers(this.modifiers(m))}modifiers(m){let x=null;return(m.base_score&&(x=foundry.utils.deepClone(this.system.modifiers.scores[m.base_score])),("Defense"===m.tn||"Willpower"===m.tn)&&(x=foundry.utils.deepClone(this.system.modifiers.other.attack)),x?.length||"defense"!==m.score&&"willpower"!==m.score||(x=foundry.utils.deepClone(this.system.modifiers.other.defense)),!x?.length&&m.stat&&(x=foundry.utils.deepClone(this.system.modifiers.stats[m.stat])),x||(x=[]),Array.isArray(x))?(m.boons&&x.push(`boons=${m.boons}`),m.banes&&x.push(`banes=${m.banes}`),m.modifier&&x.push(`modifier=${m.modifier}`),m.divide&&x.push(`divide=${m.divide}`),!$7c3e2ddbe0c064b6$export$4b017698e4946e33.is_attack(m)||$7c3e2ddbe0c064b6$export$4b017698e4946e33.is_power(m)||$7c3e2ddbe0c064b6$export$4b017698e4946e33.strength_met(m,this)||x.push("name=Low Str&banes=1"),("strength"===m.stat||"dexterity"===m.stat||"speed"===m.stat||"endurance"===m.stat)&&this.system.scores.health.fatigue&&this.system.scores.health.value>=this.system.scores.health.max&&x.push("name=Fatigue&banes=1"),("speed"===m.stat||"Athletics"===m.skill)&&this.system.scores.armor.properties.Bulky&&x.push("name=Bulky&banes=1"),"strength"===m.stat&&this.system.scores.armor.properties.Powered&&x.push("name=Powered&boons=2"),$7c3e2ddbe0c064b6$export$4b017698e4946e33.is_attack(m)&&$7c3e2ddbe0c064b6$export$4b017698e4946e33.has_property(m.properties,"Auto")&&x.push("name=Auto&boons=1"),$eafd1e11e36a1c81$export$b5c87c9f30e8974e.parse(x)):(console.error("Mods object is not array"),[])}async test(m){let x=new $3cb507794eef5f3c$export$1b16fc9eb974a84d({actor:this,...m});return!1!==m.evaluate&&await x.evaluate(),!1!==m.apply_effects&&await x.apply_effects(m),m.chat&&await x.to_chat({whisper:!!m.whisper}),x}};let $99f2af74aa8b5874$export$ed3c1ed9e6e8a483=class $99f2af74aa8b5874$export$ed3c1ed9e6e8a483{static async calculate_scores(m){m.system.scores.armor.properties=m.armor_properties(),m.system.scores.armor.custom||(m.system.scores.armor.value=m.calculate_score("armor",m.armor_value())),m.system.scores.defense.custom||(m.system.scores.defense.value=m.calculate_score("defense",[m.system.stats.dexterity.value,m.system.stats.speed.value,m.system.stats.perception.value])),m.system.scores.willpower.custom||(m.system.scores.willpower.value=m.calculate_score("willpower",[m.system.stats.intelligence.value,m.system.stats.charisma.value,m.system.stats.determination.value])),m.system.scores.health.custom||(m.system.scores.health.max=m.calculate_score("health",m.system.stats.strength.value+m.system.stats.endurance.value)),m.system.scores.health.value=m.wound_total(),m.system.scores.health.fatigue=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.fatigue(m),m.system.scores.move.custom||(m.system.scores.move.value=m.calculate_score("move",[m.system.stats.speed.value,m.system.stats.endurance.value,m.system.stats.determination.value],{modifier:-1*m.system.scores.armor.properties.Bulky||0,divide:m.system.scores.health.fatigue&&m.system.scores.health.value>=m.system.scores.health.max?2:1})),m.system.scores.encumbrance.custom||(m.system.scores.encumbrance.max=m.calculate_score("encumbrance",[m.system.stats.strength.value,m.system.stats.dexterity.value,m.system.stats.endurance.value],{modifier:m.system.scores.armor.properties.Powered||0})),m.system.scores.encumbrance.value=m.encumbrance_total();let x=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.experiences_spent(m);m.system.experiences.spent=x.total,m.system.experiences.spent_stats=x.stats,m.system.experiences.spent_skills=x.skills,m.system.experiences.spent_traits=x.traits,m.system.experiences.unspent=m.system.experiences.total-m.system.experiences.spent,m.system.experiences.level=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.power_level(m)}static fatigue(m){return m.items.filter(m=>"consequence"===m.type&&"fatigue"===m.name.toLowerCase()).map(m=>m.system.rank).reduce((m,x)=>m+x,0)}static stress(m){return m.items.filter(m=>"consequence"===m.type&&"stressed"===m.name.toLowerCase()).map(m=>m.system.rank).reduce((m,x)=>m+x,0)}static luck_cost(m){return 6*m-30}static stat_cost(m,x=0){let k=x?[...Array(x+1).keys()].reduce((m,x)=>m+x,0):0;return[...Array(m+1).keys()].reduce((m,x)=>m+x,-1*k)}static experiences_spent(m){let x=0;for(let k of["strength","dexterity","speed","endurance","intelligence","perception","charisma","determination"])x+=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.stat_cost(m.system.stats[k].value);x-=$81dc50ef4a81fbcd$export$33dec5772ae42010("level",120);let k=0,D=0;for(let x of m.items)"skill"===x.type&&(k+=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.stat_cost(x.system.rank,x.system.free_ranks)),"trait"===x.type&&(D+=x.system.ranked?x.system.cost*x.system.rank:x.system.cost);return{total:x+k+D+($81dc50ef4a81fbcd$export$33dec5772ae42010("luck_exp",!1)?$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.luck_cost(m.system.scores.luck.max):0),stats:x,skills:k,traits:D}}static power_level(m){let x=m.system.experiences.spent+$81dc50ef4a81fbcd$export$33dec5772ae42010("level",120);if(x<150)return"Mundane";if(x<200)return"Novice";if(x<250)return"Exceptional";if(x<300)return"Distinguished";if(x<350)return"Renowned";else return"Legendary"}static parry_bonus(m){let x=m.items.filter(m=>"item"===m.type&&"Weapons"===m.system.group&&m.system.equipped),k=0;for(let m of x){let x=m.system.parry;x>k&&(k=x)}return k}static primary_weapon(m){let x=m.items.filter(m=>"item"===m.type&&"Weapons"===m.system.group&&m.system.equipped),k=null,D=0;for(let m of x){let x=Number(m?.system?.actions?.[0]?.system?.action_effects.filter(m=>"damage"===m.type)?.[0]?.value)||0;x>D&&(D=x,k=m)}return k}static async merge_attack_option(m){if("true"!==m.option)return m;{let x=await fromUuid(m.uuid);if(!x)return m;let k=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.primary_weapon(x);if(!k)return m;let D=k?.system?.actions?.[0];return D?{uuid:m.uuid,type:m.type,stat:m.stat||D.system.stat,skill:m.skill||D.system.stat,tn:m.tn,modifiers:$7c3e2ddbe0c064b6$export$4b017698e4946e33.merge_modifiers(D?.system?.modifiers,m.modifiers),properties:$7c3e2ddbe0c064b6$export$4b017698e4946e33.merge_properties(D?.system?.properties,m.properties,!0),effects:JSON.stringify(D.system.action_effects.concat(JSON.parse(m.effects)))}:m}}};let $99f2af74aa8b5874$export$251803a9103f8263=class $99f2af74aa8b5874$export$251803a9103f8263{static async calculate_scores(m){m.system.wealth.total=$99f2af74aa8b5874$export$251803a9103f8263.wealth_total(m),m.system.encumbrance.value=m.encumbrance_total()}static wealth_total(m){return m.items.filter(m=>"item"===m.type).reduce((m,x)=>x.system.cost*x.system.quantity+m,0)+m.system.wealth.money}};let $99f2af74aa8b5874$export$d98152187a58a356=class $99f2af74aa8b5874$export$d98152187a58a356{static async calculate_scores(m){m.system.scores.armor.properties=m.armor_properties(),m.system.scores.armor.custom||(m.system.scores.armor.value=m.calculate_score("armor",m.armor_value())),m.system.scores.handling.boons=(m.system.scores.handling.label.match(/\+/g)||[]).length,m.system.scores.handling.banes=(m.system.scores.handling.label.match(/-/g)||[]).length,m.system.scores.defense.custom||(m.system.scores.defense.tn=m.calculate_score("defense",10+m.system.scores.handling.boons-(m.system.scores.size.value+m.system.scores.handling.banes))),m.system.scores.health.custom||(m.system.scores.health.max=m.calculate_score("health",15*2**m.system.scores.size.value)),m.system.scores.health.value=m.wound_total(),m.system.scores.space.value=$99f2af74aa8b5874$export$d98152187a58a356.loads_total(m)}static loads_total(m){return m.items.filter(m=>"item"===m.type).reduce((m,x)=>x.system.loads+m,0)}};Hooks.once("init",async()=>{Handlebars.registerHelper("is_GM",()=>game.user.isGM),Handlebars.registerHelper("is_weapon",m=>m?.system?.group?.toLowerCase()==="weapons"),Handlebars.registerHelper("is_wearable",m=>"armors"===m.system.group.toLowerCase()||"apparel"===m.system.group.toLowerCase()),Handlebars.registerHelper("has_uses",m=>Number.isFinite(parseInt(m.system.uses))),Handlebars.registerHelper("if_equal",(m,x,k)=>m===x?k.fn(void 0):k.inverse(void 0)),await foundry.applications.handlebars.loadTemplates(["systems/saga-machine/templates/partials/character-header.html","systems/saga-machine/templates/partials/character-sidebar.html","systems/saga-machine/templates/partials/character-inventory.html"])});const $c797d4b82ea8d9ca$export$80c8f1fa094e6c5={Broke:"Broke",Poor:"Poor",Struggling:"Struggling",Average:"Average",Comfortable:"Comfortable",Wealthy:"Wealthy","Very Wealthy":"Very Wealthy","Filthy Rich":"Filthy Rich"},$c797d4b82ea8d9ca$export$9e27b50feea479b8={Stash:"Stash",Merchant:"Merchant"},$c797d4b82ea8d9ca$export$a49669a6e3059265={common:"Common",uncommon:"Uncommon",rare:"Rare",exotic:"Exotic"},$c797d4b82ea8d9ca$export$b3cb66a2a96a3e6b={"++":"⊕⊕","+":"⊕","":"—","-":"⊖","--":"⊖⊖"};let $c797d4b82ea8d9ca$export$c7f6895f6cb1258b=class $c797d4b82ea8d9ca$export$c7f6895f6cb1258b extends foundry.appv1.sheets.ActorSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["saga-machine","sheet","actor"],width:850,height:650,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"basics"}],scrollY:[".basics",".combat",".inventory",".advancement"],dragDrop:[{dragSelector:".items-list .item",dropSelector:null}]})}get template(){return!game.user.isGM&&this.actor.limited?"systems/saga-machine/templates/actors/limited-sheet.html":`systems/saga-machine/templates/actors/${this.actor.type}-sheet.html`}getData(){let m=super.getData();return m.data.system.ambitions=this.items(m,"ambition",null,(m,x)=>m.system.type>x.system.type?1:-1),m.data.system.paths=this.items(m,"path"),m.data.system.origins=this.items(m,"origin"),m.data.system.all_skills=this.items(m,"skill"),m.data.system.skill_groups=this.skills_and_traits(m.data.system.all_skills,"General Skills"),m.data.system.all_traits=this.items(m,"trait"),m.data.system.trait_groups=this.skills_and_traits(m.data.system.all_traits,"General Traits",["General Traits","Weaknesses"]),m.data.system.consequences=this.items(m,"consequence"),m.data.system.equipment=this.items(m,"item"),m.data.system.containers=this.items(m,"item",m=>!!m.system.container),m}items(m,x,k,D){return k||(k=()=>!0),D||(D=(m,x)=>m.name>x.name?1:-1),m.actor.items.filter(m=>m.type===x&&k(m)).sort(D)}gather_actions(m){let x=this.items(m,"action");for(let k of m.actor.items.filter(m=>m.system.actions?.length&&!m.system.parent))for(let m of k.system.actions)x.push(new $7c3e2ddbe0c064b6$export$471af1c74e831048(m,{parent:k,parentCollection:k.collection}));return x}skills_and_traits(m,x,k=null){let D=this.group_items(m,m=>m.system.group,null,null,x),S=[];if(k)for(let m of k)m in D||S.push({name:m,contents:[]});for(let m of Object.keys(D))S.push({name:m,contents:D[m]});return S.sort((m,k)=>m.name===k.name?0:m.name===x?-1:k.name===x?1:m.name<k.name?-1:+(m.name>k.name)),S}groups_and_containers({context:m,top_groups:x=["Weapons","Armors"],blank:k="Miscellanea"}){let D=this.group_items(m.data.system.equipment,m=>m.system.parent||m.system.group,m=>!m.system.container);m.data.system.equipment.filter(m=>!m.system.parent&&!m.system.container).length||(D[k]=[]);let S=[];for(let x of m.data.system.containers)x.id in D||S.push({name:x.system.full_name,container:x,contents:[],encumbrance:0,max:x.system.container});for(let x of Object.keys(D)){let k=m.data.system.containers.find(m=>m.id===x);S.push({name:k?k.system.full_name:x,container:k||null,contents:D[x],encumbrance:D[x].reduce((m,x)=>m+x.system.container_encumbrance,0),max:k?k.system.container:0})}return S.sort((m,k)=>{if(m.name===k.name)return 0;for(let D of x){if(m.name===D)return -1;if(k.name===D)return 1}return m.container&&!k.container?1:k.container&&!m.container||m.name<k.name?-1:+(m.name>k.name)}),S}group_items(m,x,k,D,S){k||(k=()=>!0),D||(D=(m,x)=>m.name>x.name?1:-1),S||(S="Miscellanea");let access=(m,x)=>x.split(".").reduce((m,x)=>m[x],m),C={};for(let D of m){if(!k(D))continue;let m="function"==typeof x?x(D):access(D,x);m&&"string"==typeof m||(m=S),m in C?C[m].push(D):C[m]=[D]}for(let m of Object.keys(C))C[m].sort(D);return C}calc_health_progress_bar(m){m.data.system.scores.health.max?m.data.system.scores.health.percent=Math.round(m.data.system.scores.health.value/m.data.system.scores.health.max*100):m.data.system.scores.health.percent=0}activateListeners(m){super.activateListeners(m),this.isEditable&&(m.find(".item-create").on("click",this.on_item_create.bind(this)),m.find(".item-edit").on("click",this.on_item_edit.bind(this)),m.find(".item-delete").on("click",this.on_item_delete.bind(this)),m.find(".item-remove").on("click",this.on_item_remove.bind(this)),m.find(".item-input").on("change",this.on_item_update.bind(this)),m.find(".expandable").on("click",this.expand_description.bind(this)),m.find(".chatable").on("click",this.chat_description.bind(this)),this.init_origins_menu(m),this.attach_drag_events(m),this.attach_drop_events(m))}_onDragStart(m){"Test"===m.currentTarget.dataset.type&&m.stopPropagation(),this.attach_uuid(m.currentTarget.dataset);let x={"key-alt":m.altKey,"key-ctrl":m.ctrlKey,"key-shift":m.shiftKey,"key-meta":m.metaKey};m.dataTransfer.setData("text/plain",JSON.stringify({...m.currentTarget.dataset,...x})),super._onDragStart(m)}async on_item_create(m){m.preventDefault();let x=$(m.currentTarget).data("type"),k={name:$(m.currentTarget).data("name")||`New ${x}`,type:x,system:$(m.currentTarget).data("system")||{}},D=await this.actor.createEmbeddedDocuments("Item",[k]);return D?.[0]}async on_item_edit(m){let x=$(m.currentTarget).parents(".item");this.actor.items.get(x.data("id")).sheet.render({force:!0})}async on_item_delete(m){let x=$(m.currentTarget).parents(".item"),k=this.actor.items.get(x.data("id"));if(k.system.container){let m=this.actor.items.filter(m=>"item"===m.type&&m.system.parent===k.id);await this.actor.updateEmbeddedDocuments("Item",m.map(m=>Object({_id:m.id,"system.parent":null})))}await k.delete(),x&&x.length&&(x[0].style.display="none"),await this.render()}async on_item_remove(m){let x=$(m.currentTarget).parents(".item"),k={_id:this.actor.items.get(x.data("id")).id,"system.parent":null};this.actor.updateEmbeddedDocuments("Item",[k])}async on_item_update(m){let x=$(m.currentTarget).parents(".item"),k=m.currentTarget.getAttribute("data-name"),D={_id:x.data("id")};D[k]=Number(m.currentTarget.value),this.actor.updateEmbeddedDocuments("Item",[D])}async on_action_edit(m){let x=$(m.currentTarget).parents(".item");if("Actor"===x.data("parent-type"))await this.on_item_edit(m);else{let m=this.actor.items.get(x.data("parentId")),k=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parent_action_index(m,x.data("id"));if(k>m.system.actions.length||k<0)return;new $7c3e2ddbe0c064b6$export$471af1c74e831048(m.system.actions[k],{parent:m,parentCollection:m.collection}).sheet.render({force:!0})}}async on_action_delete(m){let x=$(m.currentTarget).parents(".item");if("Actor"===x.data("parent-type"))await this.on_item_delete(m);else{let m=this.actor.items.get(x.data("parentId")),k=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parent_action_index(m,x.data("id"));m.system.actions.splice(k,1),m.update({"system.actions":m.system.actions}),x.remove()}}async expand_description(m){let x=null,k=$(m.target).closest(".item").find(".item-description");if(!k.length){let D=$(m.target).closest(".item").data("id");x=$(m.target).closest(".items-inline").find(".item-description"),k=$(m.target).closest(".items-inline").find(`.item-description[data-id='${D}']`)}if(x)for(let m of x)m!==k[0]&&$(m).is(":visible")&&$(m).slideUp(200);k.slideToggle(200)}async chat_description(m){let x=$(m.target).closest(".item").data("id");if(!x)return;let k=this.actor.items.get(x);if(k)if(k.system.actions&&k.system.actions.length){let x=[];for(let m of k.system.actions)x.push(new $7c3e2ddbe0c064b6$export$471af1c74e831048(m,{parent:k,parentCollection:k.collection}));let D=[{action:"display",icon:"fa-solid fa-message",label:"Display in Chat",callback:()=>this.to_chat(k)}];for(let k of x)D.push({action:`do_${k.name}`,icon:"fa-solid fa-hand",label:k.name,callback:()=>this.on_test(m,{type:"Test",option:k.system.attack_option,stat:k.system.stat,skill:k.system.skill,tn:k.system.tn,modifiers:k.system.modifiers,properties:k.system.properties,effects:k.sheet.effects_str})});new foundry.applications.api.DialogV2({window:{title:"Choose Action"},content:"<p>What would you like to do?</p>",buttons:D,default:"display",close:()=>{}}).render({force:!0})}else this.to_chat(k)}init_origins_menu(m){let x=$81dc50ef4a81fbcd$export$33dec5772ae42010("origin_label","Origin"),k=$81dc50ef4a81fbcd$export$33dec5772ae42010("path_label","Path"),D=[{name:x,icon:'<img class="menu-img" src="systems/saga-machine/images/defaults/origin.svg" />',condition:!0,callback:async m=>(await this.actor.createEmbeddedDocuments("Item",[{name:`New ${x}`,type:"origin"}]),console.log(this),!0)},{name:k,icon:'<img class="menu-img" src="systems/saga-machine/images/defaults/path.svg" />',condition:!0,callback:async m=>{await this.actor.createEmbeddedDocuments("Item",[{name:`New ${k}`,type:"path"}])}}];foundry.applications.ux.ContextMenu.create(this,m?.[0],".origins-add",D,{eventName:"click",jQuery:!1})}attach_drag_events(m){m.find(".rollable").each((m,x)=>{x.setAttribute("draggable",!0),x.addEventListener("dragstart",m=>this._onDragStart(m),!1)}),m.find(".items-list .item input, .items-list .item select").on("mousedown",function(m){m.stopPropagation(),$(m.target).closest(".item").attr("draggable",!1)}),m.find(".items-list .item").on("mousedown",function(m){$(m.target).attr("draggable",!0)}).on({dragstart:function(m){m.stopPropagation();let x=m.originalEvent&&m.originalEvent.dataTransfer?m.originalEvent.dataTransfer:m.dataTransfer;x&&(x.effectAllowed="move",x.setData("text/html",""))}})}attach_drop_events(m){m.find(".item-group").on("drop",async m=>{let x=null;try{x=JSON.parse((m.dataTransfer||m.originalEvent?.dataTransfer).getData("text/plain"))}catch(m){}if(!x||!x.uuid||"Item"!==x.type)return;let k=await fromUuid(x.uuid);if("item"!==k.type)return;let D=$(m.currentTarget).data("id");D&&(k.system.container_encumbrance+$(m.currentTarget).data("encumbrance")<=$(m.currentTarget).data("max")?await k.update({"system.parent":D}):await k.update({"system.parent":null}))})}async on_score_toggle(m){m.preventDefault();let x=$(m.target);x.hasClass("score-secondary")?this.adjust_score(x,-1):this.toggle_custom(x)}async on_score_increment(m){m.preventDefault();let x=$(m.target);x.hasClass("score-secondary")&&this.adjust_score(x,1)}attach_uuid(m){m.uuid||(m.uuid=this.actor.uuid)}adjust_score(m,x){let k=m.attr("name"),D=this.get_score(k,[]),S={};S[k]=D+x,this.actor.update(S)}toggle_custom(m){let x=m.hasClass("score-input")?m:m.find(".score-input");if(!x.length)return;let k=x.attr("name"),D=this.get_score(k,["max","value","tn"]);if(!D)return;x.prop("disabled",!!D.custom);let S=this.get_score_custom(k),C={};C[S]=!D.custom,this.actor.update(C)}get_score(m,x){let k=m.split("."),D=this.actor;for(let m of k)if(D&&!x.includes(m))D=D[m]?D[m]:null;else break;return D}get_score_custom(m){return m.substring(0,m.lastIndexOf("."))+".custom"}to_chat(m){ChatMessage.create({flavor:`<header class="item-header"><img src="${m.img}" alt="${m.name}" /><h2>${m.name}</h2></header>`,content:m.system.description,speaker:ChatMessage.getSpeaker({actor:this.actor})})}async on_test(m,x=null){m.preventDefault(),x||(x=m.currentTarget.dataset),this.attach_uuid(x),x=await $99f2af74aa8b5874$export$ed3c1ed9e6e8a483.merge_attack_option(x),await $3cb507794eef5f3c$export$5803ef6f71bdd50f(x)}};let $c797d4b82ea8d9ca$export$eaa36efd5f1a839=class $c797d4b82ea8d9ca$export$eaa36efd5f1a839 extends $c797d4b82ea8d9ca$export$c7f6895f6cb1258b{get template(){return!game.user.isGM&&this.actor.limited?"systems/saga-machine/templates/actors/limited-sheet.html":this.actor.is_pc()?"systems/saga-machine/templates/actors/pc-sheet.html":"systems/saga-machine/templates/actors/npc-sheet.html"}getData(){let m=super.getData();return m.data.system.scores.luck.label=$81dc50ef4a81fbcd$export$33dec5772ae42010("luck_label","Luck"),m.data.system.wealth.money_label=$81dc50ef4a81fbcd$export$33dec5772ae42010("money_label","Money"),m.data.system.LIFESTYLES=$c797d4b82ea8d9ca$export$80c8f1fa094e6c5,m.data.system.equipment_groups=this.groups_and_containers({context:m,top_groups:["Weapons","Armors"],blank:"Miscellanea"}),m.data.system.actions=this.gather_actions(m),m.data.system.action_groups=this.skills_and_traits(m.data.system.actions,"Attacks"),this.calc_health_progress_bar(m),m.data.system.defenses=this.gather_defenses(m),m}activateListeners(m){super.activateListeners(m),this.isEditable&&(m.find(".rollable").click(this.on_test.bind(this)),m.find(".score").on("contextmenu",this.on_score_toggle.bind(this)),m.find(".score").on("click",this.on_score_increment.bind(this)),m.find(".item-equip").click(this.on_item_equip.bind(this)),m.find(".item-carry").click(this.on_item_carry.bind(this)),m.find(".items-inline > .item").on("contextmenu",this.on_npc_edit.bind(this)),m.find(".defense-test").on("click",this.on_defense_test.bind(this)),m.find(".dodge-toggle").on("click",this.on_dodge.bind(this)),m.find(".parry-toggle").on("click",this.on_parry.bind(this)),m.find(".resist-toggle").on("click",this.on_resist.bind(this)),m.find(".action-edit").on("click",this.on_action_edit.bind(this)),m.find(".action-delete").on("click",this.on_action_delete.bind(this)))}async on_dodge(m){m.preventDefault();let x=!this.actor.system.scores.defense.dodge_on;this.actor.system.scores.defense.parry_on&&await this.on_parry(m);let set_dodge=async m=>{m.total>this.actor.system.scores.defense.tn&&await this.actor.update({"system.scores.defense.tn":m.total,"system.scores.defense.dodge_on":!0,"system.scores.defense.round_tn":this.actor.system.scores.defense.tn})};if(x){let m={type:"Test",score:"defense"};this.attach_uuid(m),await $3cb507794eef5f3c$export$5803ef6f71bdd50f(m,set_dodge)}else await ChatMessage.create({flavor:`<div>Removing Dodge.</div><div><strong>Defense TN:</strong> ${this.actor.system.scores.defense.round_tn}</div>`,whisper:game.users.filter(m=>m.character?.id===this.actor?.id).map(m=>m.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.defense.tn":this.actor.system.scores.defense.round_tn,"system.scores.defense.dodge_on":!1})}async on_resist(m){m.preventDefault();let x=!this.actor.system.scores.willpower.resist_on,set_willpower=async m=>{m.total>this.actor.system.scores.willpower.tn&&await this.actor.update({"system.scores.willpower.tn":m.total,"system.scores.willpower.resist_on":!0,"system.scores.willpower.round_tn":this.actor.system.scores.willpower.tn})};if(x){let m={type:"Test",score:"willpower"};this.attach_uuid(m),await $3cb507794eef5f3c$export$5803ef6f71bdd50f(m,set_willpower)}else await ChatMessage.create({flavor:`<div>Removing Resist.</div><div><strong>Willpower TN:</strong> ${this.actor.system.scores.willpower.round_tn}</div>`,whisper:game.users.filter(m=>m.character?.id===this.actor?.id).map(m=>m.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.willpower.tn":this.actor.system.scores.willpower.round_tn,"system.scores.willpower.resist_on":!1})}async on_parry(m){this.actor.system.scores.defense.dodge_on&&await this.on_dodge(m);let x=!this.actor.system.scores.defense.parry_on,k=$99f2af74aa8b5874$export$ed3c1ed9e6e8a483.parry_bonus(this.actor),D=x?this.actor.system.scores.defense.tn+k:this.actor.system.scores.defense.tn-k;x?await ChatMessage.create({flavor:`<div>${this.actor.name} Parries!</div><div><strong>Defense TN:</strong> ${D}</div>`,speaker:ChatMessage.getSpeaker({actor:this.actor})}):await ChatMessage.create({flavor:`<div>Removing Parry bonus.</div><div><strong>Defense TN:</strong> ${D}</div>`,whisper:game.users.filter(m=>m.character?.id===this.actor?.id).map(m=>m.id),speaker:ChatMessage.getSpeaker({actor:this.actor})}),await this.actor.update({"system.scores.defense.tn":D,"system.scores.defense.parry_on":x})}async on_defense_test(m){let x=this.actor.system.scores.defense.test;if(x){for(let m of this.gather_actions(this))if(m.id===x){let x={type:"Test",stat:m.system.stat,skill:m.system.skill,tn:m.system.tn,modifiers:m.system.modifiers,properties:m.system.properties,effects:m.sheet.effects_str};return this.attach_uuid(x),await $3cb507794eef5f3c$export$5803ef6f71bdd50f(x)}}else await this.on_test(m)}gather_defenses(m){let x=[];for(let k of m.data.system.actions)$7c3e2ddbe0c064b6$export$4b017698e4946e33.is_defense(k.system.action_effects)&&x.push(k);return x}async on_item_equip(m){let x=$(m.currentTarget).parents(".item"),k=this.actor.items.get(x.data("id"));k||(k=this.actor.items.get(x.data("parentId")));let D={_id:k.id,"system.equipped":!k.system.equipped};this.actor.updateEmbeddedDocuments("Item",[D])}async on_item_carry(m){let x=$(m.currentTarget).parents(".item"),k=this.actor.items.get(x.data("id")),D={_id:k.id,"system.carried":!k.system.carried};this.actor.updateEmbeddedDocuments("Item",[D])}async on_npc_edit(m){m.preventDefault();let x=$(m.currentTarget).closest(".item");this.actor.items.get(x.data("id")).sheet.render({force:!0})}};let $c797d4b82ea8d9ca$export$9059fd0f09215233=class $c797d4b82ea8d9ca$export$9059fd0f09215233 extends $c797d4b82ea8d9ca$export$c7f6895f6cb1258b{getData(){let m=super.getData();return m.data.system.STASH_TYPES=$c797d4b82ea8d9ca$export$9e27b50feea479b8,m.data.system.wealth.money_label=$81dc50ef4a81fbcd$export$33dec5772ae42010("money_label","Money"),m.data.system.equipment_groups=this.groups_and_containers({context:m,top_groups:["Weapons","Armors"],blank:"Miscellanea"}),m}activateListeners(m){super.activateListeners(m),this.isEditable&&m.find(".distribute-money").on("click",this.distribute_money.bind(this))}async distribute_money(){let m=game?.canvas?.tokens?.controlled;if(!m.length)return ui.notifications.warn("No valid character selected.");let x=this.actor.system.wealth.money%m.length,k=Math.floor(this.actor.system.wealth.money/m.length);for(let D of m)D.actor.isOwner?D.actor.update({"system.wealth.money":D.actor.system.wealth.money+k}):x+=k;this.actor.update({"system.wealth.money":x});let D="<li>"+m.map(m=>`@UUID[${m.actor.uuid}]{${m.name}}`).join("</li><li>")+"</li>";ChatMessage.create({content:`<strong>${k}\xa4</strong> each distributed from @UUID[${this.actor.uuid}]{${this.actor.name}} to:<ul style="line-height: 1.7em">${D}</ul>`})}};let $c797d4b82ea8d9ca$export$d55003dbaa27bba5=class $c797d4b82ea8d9ca$export$d55003dbaa27bba5 extends $c797d4b82ea8d9ca$export$c7f6895f6cb1258b{async getData(){let m=super.getData();return m.data.system.is_pc=this.actor.hasPlayerOwner,m.data.system.VEHICLE_AVAILABILITY=$c797d4b82ea8d9ca$export$a49669a6e3059265,m.data.system.VEHICLE_HANDLING=$c797d4b82ea8d9ca$export$b3cb66a2a96a3e6b,m.data.system.equipment_groups=this.groups_and_containers({context:m,top_groups:["Vehicle Components","Trade Goods"],blank:"Trade Goods"}),m.data.system.actions=this.gather_actions(m),m.data.system.action_groups=this.skills_and_traits(m.data.system.actions,"Attacks"),await this.lookup_crew(m),this.calc_health_progress_bar(m),this.calc_space_progress_bar(m),m}async activateListeners(m){super.activateListeners(m),await this.draw_positions(m),this.isEditable&&(m.find(".rollable").click(this.on_test.bind(this)),m.find(".score").on("contextmenu",this.on_score_toggle.bind(this)),m.find(".score").on("click",this.on_score_increment.bind(this)),m.find(".position-list .lock-toggle").click(this.toggle_lock.bind(this)),m.find(".position-list .position-row").on("drop",this.drop_crewman.bind(this)),m.find(".position-list img.crewman").click(this.open_crewman.bind(this)),m.find(".position-list .crew-delete").click(this.delete_crewman.bind(this)),m.find(".position-list .position-create").click(this.add_position.bind(this)),m.find(".position-list .position-delete").click(this.delete_position.bind(this)),m.find(".action-crewman").on("change",this.on_action_crewman.bind(this)),m.find(".action-edit").on("click",this.on_action_edit.bind(this)),m.find(".action-delete").on("click",this.on_action_delete.bind(this)))}calc_space_progress_bar(m){m.data.system.scores.space.max?m.data.system.scores.space.percent=Math.round(m.data.system.scores.space.value/m.data.system.scores.space.max*100):m.data.system.scores.space.percent=0}async on_test(m){m.preventDefault();let x=$(m.currentTarget).closest(".item, .position").find("select.action-crewman, input[name=character]").val();m.currentTarget.dataset.uuid=x||this.actor.uuid,await $3cb507794eef5f3c$export$5803ef6f71bdd50f({...m.currentTarget.dataset,...x?{}:{score:"crew",stat:null,skill:null}})}async lookup_crew(m){for(let x of m.data.system.scores.crew.positions)x.character&&(x.actor=await fromUuid(x.character),x.label=`${x.actor.name} (${x.position})`);m.data.system.scores.crew.roster=m.data.system.scores.crew.positions.filter(m=>m.character)}on_action_crewman(m){m.preventDefault(),m.stopPropagation()}async drop_crewman(m){let x=null;try{x=JSON.parse((m.dataTransfer||m.originalEvent?.dataTransfer)?.getData("text/plain"))}catch(m){}if(!x||!x.uuid||"Actor"!==x.type)return;let k=await fromUuid(x.uuid);"character"===k.type&&($(m.currentTarget).closest(".position").find("input[name=character]").val(k.uuid),this.update_positions(m))}async open_crewman(m){let x=$(m.currentTarget).data("uuid");(await fromUuid(x)).sheet.render({force:!0})}async delete_crewman(m){$(m.currentTarget).closest(".character").find("input[name=character]").val(""),this.update_positions(m)}toggle_lock(m){let x=$(m.currentTarget).closest(".lock-toggle"),k=x.closest(".position-list");x.hasClass("locked")?(x.removeClass("locked").find("i").removeClass("fa-lock").addClass("fa-unlock"),k.find(".position-create").removeClass("hidden"),k.find(".position-delete").removeClass("hidden"),k.find("select").removeAttr("disabled")):(x.addClass("locked").find("i").removeClass("fa-unlock").addClass("fa-lock"),k.find(".position-create").addClass("hidden"),k.find(".position-delete").addClass("hidden"),k.find("select").attr("disabled","disabled"))}async add_position(m){if(!this.isEditable)return;let x=this.element.find(".position.prototype"),k=this.element.find("ol.position-list");if(!x||!x.length||!k||!k.length)return;let D=x.clone();D.removeClass("prototype"),D.find("input, select").change(this.update_positions.bind(this)),k.append(D),this.update_positions(m)}async delete_position(m){let x=$(m.currentTarget).closest(".position"),k=x.closest(".position-list");x.remove(),this.update_positions(m,k)}async draw_positions(m){if(!this.actor.system.scores.crew.positions||!this.actor.system.scores.crew.positions.length)return;let x=m.find(".position.prototype"),k=m.find("ol.position-list");if(x&&x.length&&k&&k.length)for(let m of this.actor.system.scores.crew.positions){let D=x.clone();if(D.removeClass("prototype"),D.find("[name=position]").val(m.position),D.find("[name=character]").val(m.character),m.character){let x=await fromUuid(m.character);D.find(".character").addClass("filled"),D.find("img.crewman").attr("src",x.img).data("uuid",x.uuid),D.find("div.character-label").text(x.name)}k.append(D),this.isEditable&&(D.find("input, select").change(this.update_positions.bind(this)),"Captain"===m.position?D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Coordinate","charisma","Persuade",12)+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Inspire","perception","Empathy",12)):"Driver/Pilot"===m.position?D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Regain Control","speed","Vehicles",12)+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Evasive Actions","speed","Vehicles","")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Close","speed","Vehicles","",null,"Vehicles vs. Vehicles")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Escape","speed","Vehicles","",null,"Vehicles vs. Vehicles")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("On Alert","speed","Vehicles",12)):"Engineer"===m.position?D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Reroute Power","intelligence","Academics (Engineering)",12,"academics")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Boost","intelligence","Academics (Engineering)",12,"academics")):"Gunner"===m.position?D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Point Defense","dexterity","Projectiles","",null,"Projectiles vs. Projectiles")):"Jammer"===m.position?D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Jam","intelligence","Academics (Computing)",12,"academics")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Unjam","intelligence","Academics (Computing)",12,"academics")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Countermeasures","intelligence","Academics (Computing)","","academics","Academics (Computing) vs. Academics (Computing)")):"Marine"===m.position?D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Board","strength","Athletics",12)):"Mechanic"===m.position?D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Repair","dexterity","Trade (Mechanic)",10,"trade")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Jury-rig","dexterity","Trade (Mechanic)",12,"trade")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Recalibrate","dexterity","Trade (Mechanic)",12,"trade")):"Medic"===m.position&&D.find(".position-actions").html($c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Treat","dexterity","Medicine",10,null,"Dex/Medicine-10")+$c797d4b82ea8d9ca$export$d55003dbaa27bba5.position_action_button("Counsel","perception","Empathy",12)))}}static position_action_button(m,x,k,D,S=null,C=null){return S||(S=k.toLowerCase()),C||(C=`${k}-${D}`),`<span class="item-img rollable" data-type="Test" data-stat="${x}" data-skill="${k}" data-tn="${D}" draggable="true">
				    <img class="item-img" src="systems/saga-machine/images/skills/${S}.svg" title="${m}: ${C} test">
				    <img class="item-img" src="systems/saga-machine/images/d10.svg" title="${m}: ${C} test">
			    </span>`}async update_positions(m,x=null){m.preventDefault(),m.stopPropagation();let k=$(m.currentTarget).closest("ol.position-list"),D=!!k.find(".lock-toggle").hasClass("locked"),S=x?x.find(".position:not(.prototype)"):k.find(".position:not(.prototype)"),C=[];S.each((m,x)=>{let k=$(x).find("[name=position]").val().trim(),D=$(x).find("[name=character]").val().trim();C.push({position:k,character:D})}),await this.actor.update({"system.scores.crew.positions":C}),D||setTimeout(()=>this.element.find(".lock-toggle").trigger("click"),10)}};const $9ae65f310b7f9d18$export$d4de1c0b65920b67={"Long-term":"Long-term","Short-term":"Short-term",Party:"Party",Quest:"Quest"},$9ae65f310b7f9d18$export$78527858eb8a4178={"":"--",strength:"Strength",dexterity:"Dexterity",speed:"Speed",endurance:"Endurance",intelligence:"Intelligence",perception:"Perception",charisma:"Charisma",determination:"Determination"},$9ae65f310b7f9d18$export$55fbcbf6ed18708={common:"Common",uncommon:"Uncommon",rare:"Rare",exotic:"Exotic"};let $9ae65f310b7f9d18$export$11dc603c5bc66ba5=class $9ae65f310b7f9d18$export$11dc603c5bc66ba5 extends foundry.appv1.sheets.ItemSheet{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["saga-machine","sheet","item"],width:600,height:360,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"basics"}],scrollY:[".basics",".actions","effects",".description"]})}get template(){return`systems/saga-machine/templates/items/${this.item.type}-sheet.html`}getData(){return super.getData()}activateListeners(m){super.activateListeners(m),this.isEditable&&(m.find(".actions .item-create").click(this.add_action.bind(this)),m.find(".actions .action-edit").click(this.edit_action.bind(this)),m.find(".actions .action-delete").click(this.delete_action.bind(this)))}toggle_items_provided(m){m.preventDefault(),$(m.target).parent().find(".items-provided").each((m,x)=>{$(x).is(":visible")?x.style.display="none":x.style.display="block"})}async on_create_effect(m){return m.preventDefault(),await ActiveEffect.create({name:"New Effect"},{parent:this.item})}async on_edit_effect(m){let x=$(m.target).closest(".effect"),k=x.data("id"),D=x.data("name"),S=k?this.item.effects.get(k):this.item.effects.getName(D);S&&S.sheet.render({force:!0})}async on_delete_effect(m){let x=$(m.target).closest(".effect"),k=x.data("id"),D=x.data("name"),S=k?this.item.effects.get(k):this.item.effects.getName(D);await S.delete(),x&&x.length&&(x[0].style.display="none"),await this.render()}async on_toggle_effect(m){let x=$(m.target).closest(".effect"),k=x.data("id"),D=x.data("name"),S=k?this.item.effects.get(k):this.item.effects.getName(D);S.update({disabled:!S.disabled})}add_action(){if(!this.isEditable)return;let m={name:this.item.name,type:"action",_id:$81dc50ef4a81fbcd$export$260ae3d8e98e4090(),img:this.item.img,system:{}};this.item.system.description&&(m.system.description=this.item.system.description),"item"===this.item.type&&(m.system.properties=this.item.system.properties,"Weapons"===this.item.system.group&&(m.system.group="Attacks")),"skill"===this.item.type&&(m.system.skill=this.item.system.full_name,m.system.stat=this.item.system.default,"Powers"===this.item.system.group&&(m.system.group="Powers"),"Maneuvers"===this.item.system.group&&(m.system.group="Attacks"),"Opening Moves"===this.item.system.group&&(m.system.group="Attacks"),"Stances"===this.item.system.group&&(m.system.group="Attacks"));let x=new $7c3e2ddbe0c064b6$export$471af1c74e831048(m,{parent:this.item,parentCollection:this.item.collection});this.item.system.actions.push(x.toJSON()),this.item.update({"system.actions":this.item.system.actions})}edit_action(m){let x=$(m.target).closest(".action").data("id");x>this.item.system.actions.length||new $7c3e2ddbe0c064b6$export$471af1c74e831048(this.item.system.actions[x],{parent:this.item,parentCollection:this.item.collection}).sheet.render({force:!0})}delete_action(m){let x=$(m.target).closest(".action"),k=x.data("id");this.item.system.actions.splice(k,1),this.item.update({"system.actions":this.item.system.actions}),x.remove()}items_provided(m,x){if(!x)return"&horbar;";let k=[];for(let D of x.split(",").map(m=>m.trim())){let x=this.matching_item(m,D),[S,C,N,I]=[x.item,x.name,x.specialization,x.rank];S?k.push(`<a class="content-link" draggable="true" data-uuid="${S.uuid}" data-id="${S.id}" data-type="Item" data-specialization="${N}" data-rank="${I}" data-tooltip="Item"><i class="fas fa-suitcase"></i>${D}</a>`):k.push(`<a class="content-link broken" draggable="true" data-type="${m}" data-name="${C}" data-specialization="${N}" data-rank="${I}"><i class="fas fa-unlink"></i>${D}</a>`)}return k.join(", ")}matching_item(m,x){let k=x.split(" "),D=k[k.length-1];isNaN(Number(D))&&(D="");let S=x.match(/\(([^\)]+)\)/);S=S?S[S.length-1]:"";let C=x.slice(0,x.length-D.length);(k=C.split("(")).length>1&&(C=k[0]),C=C.trim();let N=game.items.filter(x=>x.type===m&&x.name===C);return N.length?{item:N[0],name:C,specialization:S,rank:D}:{item:null,name:C,specialization:S,rank:D}}};let $9ae65f310b7f9d18$export$96c1200f91678a19=class $9ae65f310b7f9d18$export$96c1200f91678a19 extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{getData(){let m=super.getData();return m.data.system.SKILL_DEFAULTS=$9ae65f310b7f9d18$export$78527858eb8a4178,m}activateListeners(m){if(super.activateListeners(m),!this.isEditable)return}};let $9ae65f310b7f9d18$export$9f2a24c9f192c221=class $9ae65f310b7f9d18$export$9f2a24c9f192c221 extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{activateListeners(m){super.activateListeners(m),this.isEditable&&(m.find(".effect-create").on("click",this.on_create_effect.bind(this)),m.find(".effect-edit").on("click",this.on_edit_effect.bind(this)),m.find(".effect-delete").on("click",this.on_delete_effect.bind(this)),m.find(".effect-toggle").on("click",this.on_toggle_effect.bind(this)))}};let $9ae65f310b7f9d18$export$4169507366d0a707=class $9ae65f310b7f9d18$export$4169507366d0a707 extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{getData(){let m=super.getData();return m.data.system.skills_provided=this.items_provided("skill",m.data.system.skills),m.data.system.traits_provided=this.items_provided("trait",m.data.system.traits),m.data.system.equipment_provided=this.items_provided("item",m.data.system.equipment),m}activateListeners(m){super.activateListeners(m),this.isEditable&&m.find(".items-provided").on("contextmenu",this.toggle_items_provided.bind(this))}};let $9ae65f310b7f9d18$export$6f7f838e9b4593fa=class $9ae65f310b7f9d18$export$6f7f838e9b4593fa extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{getData(){let m=super.getData();return m.data.system.skills_provided=this.items_provided("skill",m.data.system.skills),m.data.system.traits_provided=this.items_provided("trait",m.data.system.traits),m.data.system.equipment_provided=this.items_provided("item",m.data.system.equipment),m}activateListeners(m){super.activateListeners(m),this.isEditable&&m.find(".items-provided").on("contextmenu",this.toggle_items_provided.bind(this))}};let $9ae65f310b7f9d18$export$eff3dd514a394135=class $9ae65f310b7f9d18$export$eff3dd514a394135 extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{activateListeners(m){super.activateListeners(m),this.isEditable&&(m.find(".effect-create").on("click",this.on_create_effect.bind(this)),m.find(".effect-edit").on("click",this.on_edit_effect.bind(this)),m.find(".effect-delete").on("click",this.on_delete_effect.bind(this)),m.find(".effect-toggle").on("click",this.on_toggle_effect.bind(this)))}};let $9ae65f310b7f9d18$export$7b63ff0ee2469440=class $9ae65f310b7f9d18$export$7b63ff0ee2469440 extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{getData(){let m=super.getData();return m.data.system.ITEM_AVAILABILITY=$9ae65f310b7f9d18$export$55fbcbf6ed18708,m}activateListeners(m){if(super.activateListeners(m),!this.isEditable)return}};let $9ae65f310b7f9d18$export$f62ad08e7f4ea9c3=class $9ae65f310b7f9d18$export$f62ad08e7f4ea9c3 extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{getData(){let m=super.getData();return m.data.system.AMBITION_TYPES=$9ae65f310b7f9d18$export$d4de1c0b65920b67,m}};let $9ae65f310b7f9d18$export$aa81b4e329608703=class $9ae65f310b7f9d18$export$aa81b4e329608703 extends $9ae65f310b7f9d18$export$11dc603c5bc66ba5{static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{width:550,height:600})}getData(){let m=super.getData();return m.data.system.STAT_OPTIONS=$3cb507794eef5f3c$export$3b84a4f667a9b873,m.data.system.SCORE_OPTIONS=$3cb507794eef5f3c$export$31ebfa08917fa7c5,m}activateListeners(m){if(super.activateListeners(m),!this.isEditable)return;for(let x of m.find(".tag-input"))"system.modifiers"===x.getAttribute("name")&&Array.isArray(this.item.system.modifiers)&&(x.value=this.item.system.modifiers.join(",")),"system.properties"===x.getAttribute("name")&&Array.isArray(this.item.system.properties)&&(x.value=this.item.system.properties.join(",")),new($parcel$interopDefault($0a478c99c1d3517f$exports))(x,{duplicates:!0,transformTag:m=>{m.style=$eafd1e11e36a1c81$export$b5c87c9f30e8974e.color(m.value),isNaN(parseInt(m.value.split(" ").at(-1)))&&(m.value=m.value.replaceAll("+","⊕").replaceAll("-","⊖"))}});let x=m.find("select.stat[name='system.stat']"),k=m.find("select.score[name='system.stat']");x.on("change",()=>k.val("")),k.on("change",()=>x.val("")),this.draw_effects(m),m.find(".action-row .item-create").click(this.add_effect.bind(this)),m.find(".action-row .item-delete").click(this.delete_effect.bind(this))}_getSubmitData(m={}){let x=super._getSubmitData(m);if("system.stat"in x&&Array.isArray(x["system.stat"])&&x["system.stat"].length>=2&&(x["system.stat"]=x["system.stat"][0]?x["system.stat"][0]:x["system.stat"][1]),"system.modifiers"in x)try{x["system.modifiers"]=JSON.parse(x["system.modifiers"]).map(m=>m.value)}catch{}if("system.properties"in x)try{x["system.properties"]=JSON.parse(x["system.properties"]).map(m=>m.value)}catch{}return x}async _onSubmit(m,{updateData:x=null,preventClose:k=!1,preventRender:D=!1}={}){if(m.preventDefault(),!(this.item.parent instanceof $7c3e2ddbe0c064b6$export$471af1c74e831048))return super._onSubmit(m,{updateData:x,preventClose:k,preventRender:D});{let m=this._getSubmitData(x);"consequence_name"in m&&delete m.consequence_name,"consequence_subject"in m&&delete m.consequence_subject,"damage_type"in m&&delete m.damage_type,"damage_value"in m&&delete m.damage_value,"effect_target"in m&&delete m.effect_target,"effect_type"in m&&delete m.effect_type,"effect_when"in m&&delete m.effect_when,"message_key"in m&&delete m.message_key,"message_value"in m&&delete m.message_value,foundry.utils.mergeObject(this.item,m);let k=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parent_action_index(this?.item?.parent,this.item.id);if(k>=0)return this.item.parent.system.actions[k]=this.item.toObject(!1),await this.item.parent.update({"system.actions":this.item.parent.system.actions})}}draw_effects(m){if(!this.item.system.action_effects||!this.item.system.action_effects.length)return;let x=m.find(".action-effect.prototype"),k=m.find("ol.action-list");if(x&&x.length&&k&&k.length)for(let m of this.item.system.action_effects){let D=x.clone();D.removeClass("prototype"),D.find("[name=effect_type]").val(m.type),"damage"===m.type&&D.find("[name=damage_value]").val(m.value),"damage"===m.type&&D.find("[name=damage_type]").val(m.damage_type),"consequence"===m.type&&D.find("[name=consequence_name]").val(m.name),"consequence"===m.type&&D.find("[name=consequence_subject]").val(m.subject),"message"===m.type&&D.find("[name=message_key]").val(m.key),"message"===m.type&&D.find("[name=message_value]").val(m.value),D.find("[name=effect_when]").val(m.when),D.find("[name=effect_target]").val(m.target),this.change_effect_type(D),k.append(D),this.isEditable&&D.find("input, select").change(this.update_effects.bind(this))}}change_effect_type(m){let x=m.find("[name=effect_type]").val(),k=m.find(".action-props").children();if(m.length&&x&&k.length)for(let m of k)m.classList.contains(`action-${x}`)?m.classList.remove("hidden"):m.classList.add("hidden")}add_effect(){if(!this.isEditable)return;let m=this.element.find(".action-effect.prototype"),x=this.element.find("ol.action-list");if(!m||!m.length||!x||!x.length)return;let k=m.clone();k.removeClass("prototype"),k.find("input, select").change(this.update_effects.bind(this)),x.append(k)}delete_effect(m){let x=$(m.currentTarget).closest(".action-effect"),k=x.closest(".action-list");x.remove(),this.update_effects(m,k)}async update_effects(m,x=null){m.preventDefault(),m.stopPropagation();let k=x?x.find(".action-effect:not(.prototype)"):$(m.currentTarget).closest("ol.action-list").find(".action-effect:not(.prototype)"),D=[];k.each((m,x)=>{let k=$(x).find("[name=effect_type]").val().trim(),S=$(x).find("[name=damage_value]").val().trim(),C=$(x).find("[name=damage_type]").val().trim(),N=$(x).find("[name=consequence_name]").val().trim(),I=$(x).find("[name=consequence_subject]").val().trim(),M=$(x).find("[name=message_key]").val().trim(),E=$(x).find("[name=message_value]").val().trim(),A={type:k,when:$(x).find("[name=effect_when]").val().trim(),target:$(x).find("[name=effect_target]").val().trim()};"damage"===k?A={value:S,damage_type:C,...A}:"consequence"===k?A={name:N,subject:I||null,...A}:"message"===k&&(A={key:M||null,value:E,...A});try{D.push($5ba9a332765ece17$export$a32b0b1c1ac59d04.to_json(new $5ba9a332765ece17$export$a32b0b1c1ac59d04(A)))}catch(m){}}),this.item.parent instanceof $7c3e2ddbe0c064b6$export$471af1c74e831048?(await this.submit({updateData:{"system.action_effects":D}}),await this.render()):this.item.update({"system.action_effects":D})}get effects_str(){return JSON.stringify(this.item.system.action_effects.map(m=>$5ba9a332765ece17$export$a32b0b1c1ac59d04.to_json(m)))}};async function $f871c4c9b98160c4$export$ed3f1528e78b2d0c(m,x){if("Test"!==m.type)return;let k=$81dc50ef4a81fbcd$export$99454b2c58b3846f(m);if(!k)return ui.notifications.warn("You can only create macro buttons for known actors");let D=new $3cb507794eef5f3c$export$1b16fc9eb974a84d({actor:k,stat:(m=await $99f2af74aa8b5874$export$ed3c1ed9e6e8a483.merge_attack_option(m)).stat||m.score,skill:m.skill,tn:m.tn}).label,S=null;m.skill&&(S=k.items.find(x=>x.name===m.skill&&"skill"===x.type));let C=JSON.stringify(m,null,4),N=`game.sagamachine.sm_test_macro(${C});`,I=game.macros.find(m=>m.name===D&&m.command===N),M={name:D,type:"script",command:N,flags:{"sagamachine.sm_test_macro":!0}};return S&&(M.img=S.img),I||(I=await Macro.create(M)),await game.user.assignHotbarMacro(I,x),!1}async function $f871c4c9b98160c4$export$4ae6666db41501cf(m){let x=$81dc50ef4a81fbcd$export$99454b2c58b3846f(m);if(!x){let k=ChatMessage.getSpeaker();k.token&&(x=game.actors.tokens[k.token]),x||(x=game.actors.get(k.actor)),m.uuid=x.uuid}await $3cb507794eef5f3c$export$5803ef6f71bdd50f(m)}async function $58f2a91e4fad6ad7$export$3d7f02c9b93e6b0(m){if(!m.find(".damage").length)return;let x=!!m.find(".critical").length,k=[];m.find(".damage").each((m,D)=>{let S=Number($(D).text()),C=$(D).parent().find(".damage-type").text(),N=Number($(D).data("pierce"))||0;k.push({damage:S,damageType:C,critical:x,pierce:N}),x=!1}),m[0].setAttribute("draggable",!0),m[0].addEventListener("dragstart",m=>{m.currentTarget.dataset.hits=JSON.stringify(k),m.dataTransfer.setData("text/plain",JSON.stringify({hits:k}))},!1)}async function $58f2a91e4fad6ad7$export$a54b240a5cfd4caf(m,x){if(x.hits)for(let k of x.hits)await m.apply_damage(k.damage,k.damageType,k.critical,k.pierce)}async function $58f2a91e4fad6ad7$export$d9445ce8959d2e19(m){m.push({name:"Push Your Luck",icon:'<i class="fas fa-dice"></i>',condition:m=>!!$(m).find(".test-json").length,callback:async m=>{let x=$(m),k=$3cb507794eef5f3c$export$1b16fc9eb974a84d.from_json(JSON.parse(x.find(".test-json").val()));return k?.actor?.isOwner?k?.actor?.system?.scores?.luck?.value<=0?ui.notifications.warn("The character doesn't have enough Luck."):void(k.boons++,$81dc50ef4a81fbcd$export$33dec5772ae42010("stress",!1)&&k.stress_boons++,k.use_luck=!0,await k.evaluate(),k.actor.update({"system.scores.luck.value":k.actor.system.scores.luck.value-1}),await k.apply_effects(),await k.to_chat({whisper:x.hasClass("whisper"),rolls:[k.results]})):ui.notifications.warn("You can't Push Your Luck for this character.")}})}async function $58f2a91e4fad6ad7$export$220dda78442aea07(m){m.push({name:"Apply Damage",icon:'<i class="fas fa-user-minus"></i>',condition:m=>!!$(m).find(".damage").length,callback:m=>{let x=$(m),k=game?.canvas?.tokens?.controlled;if(!k.length&&game.user.isGM)return void ui.notifications.warn("No valid character selected.");let D=k.filter(m=>m?.document?.actor?.isOwner);for(let m of(!D.length&&game.user.character&&(D=[game.user.character]),D)){let k=m?.document?.actor||m;if(k&&k.isOwner){let m=!!x.find(".critical").length;x.find(".damage").each((x,D)=>{let S=Number($(D).text()),C=$(D).parent().find(".damage-type").text(),N=Number($(D).data("pierce"))||0;k.apply_damage(S,C,m,N),m=!1})}}}})}async function $58f2a91e4fad6ad7$export$5386e3bdcb090884(m){m.push({name:"Edit Results",icon:'<i class="fa fa-edit"></i>',condition:m=>game.user.isGM,callback:m=>{let x=$(m),k=x.data("messageId"),D=$3cb507794eef5f3c$export$1b16fc9eb974a84d.from_json(JSON.parse(x.find(".test-json").val()));new Dialog({title:"Edit Results",content:`
                    <form class="saga-machine">
                        <div class="form-group">
                            <label for="critical">Success</label>
                            <input type="checkbox" name="success" ${D.success?"checked":""}>
                        </div>
                        <div class="form-group">
                            <label for="critical">Critical</label>
                            <input type="checkbox" name="critical" ${D.critical?"checked":""}>
                        </div>
                        <div class="form-group">
                            <label for="value">Margin</label>
                            <input type="number" name="margin" value="${D.margin}" autofocus>
                        </div>
                        <div class="sheet-body">
                            <ol class="items-list consequence-list">
                                <li class="item flexrow items-header consequence-row">
                                    <div class="item-name">Type</div>
                                    <div class="item-name">Value</div>
                                    <div class="item-controls">
                                        <a class="item-control item-create" title="Create effect"><i class="fas fa-plus"></i> Add</a>
                                    </div>
                                </li>
                
                                <li class="item flexrow consequence consequence-row prototype">
                                    <select class="item-input item-name" name="type">
                                        <option value="damage">Damage</option>
                                        <option value="consequence">Consequence</option>
                                        <option value="defense">Defense</option>
                                        <option value="message">Message</option>
                                    </select>
                                    <input class="item-input item-name" type="text" name="value" value="" />
                                    <div class="item-controls">
                                        <a class="item-control item-delete" title="Delete Item"><i class="fas fa-trash"></i></a>
                                    </div>
                                </li>
                            </ol>
                        </div>
                    </form>`,render:m=>{if(D.effects&&D.effects.length){let x=m.find(".consequence.prototype"),k=m.find("ol.consequence-list");for(let m of D.effects){let S=null;switch(m.type){case"consequence":S=m.name;break;case"damage":S=`${Number(m.value)+(Number(m.margin)||Number(D.margin))} ${m.damage_type} ${m.properties}`;break;case"message":S=`${m.key}: ${m.value}`;break;default:S=""}let C=x.clone();C.removeClass("prototype"),C.find("[name=type]").val(m.type),C.find("[name=value]").val(S),k.append(C)}}m.find(".consequence-list .item-create").click(x=>{let k=m.find(".consequence.prototype"),D=m.find("ol.consequence-list");if(!k||!k.length||!D||!D.length)return;let S=k.clone();S.removeClass("prototype"),S.find(".item-delete").click(m=>$(m.currentTarget).closest(".consequence").remove()),D.append(S)}),m.find(".consequence-list .item-delete").click(m=>$(m.currentTarget).closest(".consequence").remove())},buttons:{Edit:{icon:"<i class='fas fa-check'></i>",label:"OK",callback:async m=>{D.success=m.find("input[name=success]").is(":checked"),D.critical=m.find("input[name=critical]").is(":checked"),D.margin=Number(m.find("input[name=margin]").val()),D.edited=!0;let x=[];m.find(".consequence:not(.prototype)").each((m,k)=>{let S=$(k).find("select[name=type]").val(),C=$(k).find("input[name=value]").val(),N={};if("consequence"===S)N.name=C.trim();else if("message"===S){let m=C.split(": ");m.length>=2?[N.key,N.value]=[m[0],m[1]]:[N.key,N.value]=["Message",m[0]]}else if("damage"===S){let m=C.split(" ");N.value=Number(m?.[0])-D.margin,N.damage_type=m?.[1],m.length>=3&&(N.properties=$7c3e2ddbe0c064b6$export$4b017698e4946e33.parse_properties(m.slice(2).join(" ")))}let I=new $5ba9a332765ece17$export$a32b0b1c1ac59d04({type:S,...N},D);I.apply(D.success?"success":"failure"),x.push(I),D.effects=x}),await ChatMessage.updateDocuments([{_id:k,content:D.content(),flavor:D.flavor()}],{})}}}}).render({force:!0})}})}async function $a17192fafb7d2c73$export$a6324e54748ebe3(m,x,k,D){game.user.id===D&&"character"===m.type&&await m.encumbrance_consequences(),game.user.id===D&&game.combat&&(game.user.isGM||m.isOwner)&&game.combat.update_combatant_initiative(m,x?.system?.fast_turn)}async function $a17192fafb7d2c73$export$4bf3fd4b252a8de8(m,x,k){game.user.id===k&&m.parent&&"character"===m.parent.type&&"item"===m.type&&await m.parent.encumbrance_consequences(),game.user.id===k&&m.parent&&"item"===m.type&&m.system.parent&&await m.remove_from_container(),game.user.id===k&&"consequence"===m.type&&m.parent&&await $a67d2793a1b43c8e$export$bce7246a7036e38(m.parent)}async function $a17192fafb7d2c73$export$38a029996c573874(m,x,k,D){game.user.id===D&&m.parent&&"character"===m.parent.type&&"item"===m.type&&await m.parent.encumbrance_consequences(),game.user.id===D&&"consequence"===m.type&&m.parent&&await $a67d2793a1b43c8e$export$bce7246a7036e38(m.parent)}async function $a17192fafb7d2c73$export$4a9b7a56f490dcad(m,x,k){game.user.id===k&&m.parent&&"character"===m.parent.type&&"item"===m.type&&await m.parent.encumbrance_consequences(),game.user.id===k&&"consequence"===m.type&&m.parent&&await $a67d2793a1b43c8e$export$bce7246a7036e38(m.parent)}function $a17192fafb7d2c73$export$9dc996de602aaf4f(m,x,k,D){return game.user.id===D&&m.modifiesActor&&m.parent&&"character"===m.parent.type&&m.origin&&$a67d2793a1b43c8e$export$7801755dddf1fd51(m),!0}async function $a17192fafb7d2c73$export$d367f85a279edb03(m,x,k){game.user.id===k&&!m.origin&&m.statuses?.size&&m.target&&await $a67d2793a1b43c8e$export$31930d543788113d(m),game.user.id===k&&!m.modifiesActor&&m.transfer&&m.parent&&m.parent.parent&&"character"===m.parent.parent.type&&await $a67d2793a1b43c8e$export$40b3570d78570c16(m.parent)}async function $a17192fafb7d2c73$export$60945f152bbb5568(m,x,k,D){game.user.id===D&&!m.modifiesActor&&m.transfer&&m.parent&&m.parent.parent&&"character"===m.parent.parent.type&&await $a67d2793a1b43c8e$export$40b3570d78570c16(m.parent)}function $a17192fafb7d2c73$export$7e03fe5bbd47fde3(m,x,k){let D=!0;return game.user.id===k&&!m.origin&&m.statuses?.size&&(m?.flags?.system?.subject_prompt||m?.flags?.system?.value_prompt)&&(D&&=$a67d2793a1b43c8e$export$df951736c406196b(m)),D}async function $a17192fafb7d2c73$export$3cc25891b8a467f7(m,x,k){game.user.id===k&&!m.origin&&m.statuses?.size&&m.target&&await $a67d2793a1b43c8e$export$efd50a08c6cb878d(m),game.user.id===k&&!m.modifiesActor&&m.transfer&&m.parent&&m.parent.parent&&"character"===m.parent.parent.type&&await $a67d2793a1b43c8e$export$40b3570d78570c16(m.parent,!0)}async function $a17192fafb7d2c73$export$40058aa05d265e4f(m,x,k,D){game.user.id===D&&x.round&&x.round!==m.round&&await m.start_of_round()}async function $a17192fafb7d2c73$export$b326b618cce92063(m,x,k){await $f871c4c9b98160c4$export$ed3f1528e78b2d0c(x,k)}async function $a17192fafb7d2c73$export$e6333a552b7032f3(m,x,k){await $58f2a91e4fad6ad7$export$3d7f02c9b93e6b0($(x))}async function $a17192fafb7d2c73$export$5c0c0cc3fc780035(m,x,k){await $58f2a91e4fad6ad7$export$a54b240a5cfd4caf(m,k)}async function $a17192fafb7d2c73$export$61c10505fc99de78(m,x){await $58f2a91e4fad6ad7$export$d9445ce8959d2e19(x),await $58f2a91e4fad6ad7$export$220dda78442aea07(x),await $58f2a91e4fad6ad7$export$5386e3bdcb090884(x)}function $8812a975c235f8c9$export$f4ed8f8c82a836f9(m,x,k){x.default=k,game.settings.register("saga-machine",m,x)}const $8812a975c235f8c9$export$3277948426b5bf5c={name:"Starting Power Level",hint:"The starting power level of all player characters.",scope:"world",config:!0,type:Number,default:120,choices:{85:"Mundane",120:"Novice",160:"Exceptional",200:"Distinguished",240:"Renowned",280:"Legendary",150:"Shadows Over Sol"}},$8812a975c235f8c9$export$bc4c654b208fcde2={name:"Name for Luck",hint:"Luck, Edge, Karma, Moxie, etc.",scope:"world",config:!0,type:String,default:"Luck",choices:{Luck:"Luck",Edge:"Edge",Karma:"Karma",Moxie:"Moxie"}},$8812a975c235f8c9$export$1f55ffeba98e912e={name:"Name for Money",hint:"Money, Coins, Credits, etc.",scope:"world",config:!0,type:String,default:"Money",choices:{Money:"Money",Microcredits:"Microcredits",Dollars:"Dollars","Bronze Pennies":"Bronze Pennies",Coins:"Coins"}},$8812a975c235f8c9$export$44ba513cca23cc31={name:"Name for Origins",hint:"Origins, Genelines, Species, etc.",scope:"world",config:!0,type:String,default:"Origin",choices:{Origin:"Origin",Geneline:"Geneline",Species:"Species",Background:"Background",People:"People"}},$8812a975c235f8c9$export$9b24ff5253e45161={name:"Name for Paths",hint:"Paths, Roles, Careers, etc.",scope:"world",config:!0,type:String,default:"Path",choices:{Path:"Path",Role:"Role",Career:"Career",Archetype:"Archetype"}},$8812a975c235f8c9$export$228ad5dcb372b11={name:"Starting Luck Affects Experience",hint:"Used in Shadows Over Sol",scope:"world",config:!0,type:Boolean,default:!1},$8812a975c235f8c9$export$a0f669c9193be7da={name:"Use Stress & Mental Breaks",hint:"This campaign uses the optional Stress rules.",scope:"world",config:!0,type:Boolean,default:!1},$8812a975c235f8c9$export$34967b20022f14d6={name:"Theme",hint:"The visual theme for character sheets and UI. Requires reload to take effect.",scope:"world",config:!0,type:String,default:"unified",choices:{unified:"Unified",sos:"Shadows Over Sol"},onChange:()=>{window.location.reload()}};function $fb5cf267de5c5650$export$d2e759d1e37455cc({level:m=100,luck_label:x="Luck",money_label:k="Money",origin_label:D="Origin",path_label:S="Path",luck_exp:C=!1,stress:N=!1,theme:I="unified"}={}){CONFIG.debug.hooks=!0,Hooks.once("init",async()=>{console.log("Initializing Saga Machine"),game.sagamachine={SagaMachineActor:$99f2af74aa8b5874$export$c49d3afcc675f1b5,SagaMachineItem:$7c3e2ddbe0c064b6$export$471af1c74e831048,sm_test_macro:$f871c4c9b98160c4$export$4ae6666db41501cf},CONFIG.Actor.documentClass=$99f2af74aa8b5874$export$c49d3afcc675f1b5,CONFIG.Item.documentClass=$7c3e2ddbe0c064b6$export$471af1c74e831048,CONFIG.Combatant.documentClass=$be5000aeda79555a$export$ca8ad600a8ec4279,CONFIG.Combat.documentClass=$be5000aeda79555a$export$c9b99f4a745fcbd1,foundry.documents.collections.Actors.unregisterSheet("core",foundry.appv1.sheets.ActorSheet),foundry.documents.collections.Items.unregisterSheet("core",foundry.appv1.sheets.ItemSheet),foundry.documents.collections.Actors.registerSheet("saga-machine",$c797d4b82ea8d9ca$export$eaa36efd5f1a839,{types:["character"],makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("saga-machine",$c797d4b82ea8d9ca$export$9059fd0f09215233,{types:["stash"],makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("saga-machine",$c797d4b82ea8d9ca$export$d55003dbaa27bba5,{types:["vehicle"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$96c1200f91678a19,{types:["skill"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$9f2a24c9f192c221,{types:["trait"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$4169507366d0a707,{types:["origin"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$6f7f838e9b4593fa,{types:["path"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$eff3dd514a394135,{types:["consequence"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$7b63ff0ee2469440,{types:["item"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$f62ad08e7f4ea9c3,{types:["ambition"],makeDefault:!0}),foundry.documents.collections.Items.registerSheet("saga-machine",$9ae65f310b7f9d18$export$aa81b4e329608703,{types:["action"],makeDefault:!0}),$8812a975c235f8c9$export$f4ed8f8c82a836f9("level",$8812a975c235f8c9$export$3277948426b5bf5c,m),$8812a975c235f8c9$export$f4ed8f8c82a836f9("luck_label",$8812a975c235f8c9$export$bc4c654b208fcde2,x),$8812a975c235f8c9$export$f4ed8f8c82a836f9("money_label",$8812a975c235f8c9$export$1f55ffeba98e912e,k),$8812a975c235f8c9$export$f4ed8f8c82a836f9("origin_label",$8812a975c235f8c9$export$44ba513cca23cc31,D),$8812a975c235f8c9$export$f4ed8f8c82a836f9("path_label",$8812a975c235f8c9$export$9b24ff5253e45161,S),$8812a975c235f8c9$export$f4ed8f8c82a836f9("luck_exp",$8812a975c235f8c9$export$228ad5dcb372b11,C),$8812a975c235f8c9$export$f4ed8f8c82a836f9("stress",$8812a975c235f8c9$export$a0f669c9193be7da,N),$8812a975c235f8c9$export$f4ed8f8c82a836f9("theme",$8812a975c235f8c9$export$34967b20022f14d6,I);let M=game.settings.get("saga-machine","theme"),E=`systems/saga-machine/styles/${M}.css`,A=document.createElement("link");A.rel="stylesheet",A.type="text/css",A.href=E,document.head.appendChild(A),CONFIG.statusEffects=$a67d2793a1b43c8e$export$7065c91b0a27b3b9(),CONFIG.specialStatusEffects.DEFEATED="defeated",CONFIG.specialStatusEffects.INCAPACITATED="unconscious",CONFIG.specialStatusEffects.INVISIBLE="hidden",game.sagamachine.standard_consequences=CONFIG.statusEffects.map(m=>m.name),Hooks.on("updateActor",$a17192fafb7d2c73$export$a6324e54748ebe3),Hooks.on("createItem",$a17192fafb7d2c73$export$4bf3fd4b252a8de8),Hooks.on("updateItem",$a17192fafb7d2c73$export$38a029996c573874),Hooks.on("deleteItem",$a17192fafb7d2c73$export$4a9b7a56f490dcad),Hooks.on("preCreateActiveEffect",$a17192fafb7d2c73$export$9dc996de602aaf4f),Hooks.on("createActiveEffect",$a17192fafb7d2c73$export$d367f85a279edb03),Hooks.on("updateActiveEffect",$a17192fafb7d2c73$export$60945f152bbb5568),Hooks.on("preDeleteActiveEffect",$a17192fafb7d2c73$export$7e03fe5bbd47fde3),Hooks.on("deleteActiveEffect",$a17192fafb7d2c73$export$3cc25891b8a467f7),Hooks.on("preUpdateCombat",$a17192fafb7d2c73$export$40058aa05d265e4f),Hooks.on("hotbarDrop",$a17192fafb7d2c73$export$b326b618cce92063),Hooks.on("renderChatMessageHTML",$a17192fafb7d2c73$export$e6333a552b7032f3),Hooks.on("dropActorSheetData",$a17192fafb7d2c73$export$5c0c0cc3fc780035),Hooks.on("getChatMessageContextOptions",$a17192fafb7d2c73$export$61c10505fc99de78)})}$fb5cf267de5c5650$export$d2e759d1e37455cc({level:"150",luck_label:"Edge",money_label:"Microcredits",origin_label:"Geneline",path_label:"Role",luck_exp:!0,stress:!0,theme:"sos"});
//# sourceMappingURL=sos2e.js.map
